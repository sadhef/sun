<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Training Institute Application</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Litepicker CSS for Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <div class="side-menu" id="sideMenu">
            <div class="menu-toggle" id="menuToggle"><i class="fas fa-bars icon"></i></div>
            <ul id="menu-list"></ul>
        </div>
        <div class="main-content-wrapper">
             <div class="top-bar">
                 <div class="logo"><img src ="../logo.png"> <span>Sun</span> Training Institute</div>
                 <div class="search-container">
                    <div class="search-bar">
                        <i class="fas fa-magnifying-glass"></i>
                        <input type="text" id="searchInput" placeholder="Search across all pages...">
                        <span class="search-clear-btn" id="searchClearBtn">&times;</span>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="bell-icon-wrapper" id="bellIconWrapper"><i class="fas fa-bell"></i><span class="badge" id="reminderBadge"></span></div>
                    <div class="user-profile">
                        <select id="roleSwitcher" title="Switch Role">
                            <option value="Admin">Admin</option>
                            <option value="Trainer">Trainer</option>
                            <option value="Training Coordinator">Training Coordinator</option>
                            <option value="Accountant">Accountant</option>
                        </select>
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </div>
            <div class="main-content" id="mainContent"></div>
        </div>
    </div>
    
    <div class="side-panel" id="reminderPanel"></div>
    <div class="side-panel" id="availabilityPanel"></div>
    <div class="side-panel" id="pendingPeersPanel"></div>
    <div id="notification-container"></div>
    <div id="confirmationModal" class="modal"></div>
    <div id="scheduleModal" class="modal"></div>
    <div id="scheduleDetailModal" class="modal"></div>
    <div id="newEnquiryModal" class="modal"></div>
    <div id="notesModal" class="modal"></div>
    <div id="pendingDetailsModal" class="modal"></div>
    <div id="viewEnquiryModal" class="modal"></div>
    <div id="editEnquiryModal" class="modal"></div>
    <div id="nominationDetailsModal" class="modal"></div>
    <div id="newNominationModal" class="modal"></div>
    <div id="priceHistoryModal" class="modal"></div>
    <div id="agreementModal" class="modal"></div>
    <div id="workflowScheduleModal" class="modal"></div>
    <div id="trainerDetailsModal" class="modal"></div>
    <div id="resultsModal" class="modal"></div>
    <div id="certificateModal" class="modal"></div>
    <div id="invoiceModal" class="modal"></div>

    <!-- Litepicker JS for Date Range Picker -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link to external data file -->
    <script src="data.js"></script>

    <script>
        // --- DATA INITIALIZATION ---
        let enquiryCounter = 0, noteCounter = 0, invoiceCounter = 0, currentEnquiryId = null;
        // The 'toYYYYMMDD' function and 'initialData' object are now loaded from data.js
        
        // --- MODIFICATION: ADDED 'batches' TO THE DATA STRUCTURE ---
        let appData = { enquiries: [], notes: {}, activityLog: {}, clients: [], schedules: [], trainers: [], rooms: [], students: [], courses: [], classCapacity: {}, historicalPrices: {}, rateCards: {}, batchCounters: {}, invoices: [], batches: [] };

        // --- APP STATE & CONFIG ---
        let appState = { role: 'Admin', currentPage: 'dashboard', searchFilter: '' };
        let scheduleCurrentDate = new Date(); // Date for schedule page views, defaults to today
        let _tempWorkflowData = {};
        let tableSortState = {}; // For table sorting
        // --- MODIFICATION: ADDED LANGUAGES FROM DUMMY DATA ---
        const languages = ['English', 'Arabic', 'Tamil', 'Mandarin', 'Spanish', 'Hindi', 'Japanese', 'French', 'Italian', 'Russian', 'Korean', 'German', 'Portuguese', 'Cantonese', 'Urdu', 'Malayalam'];
        const menuConfig = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-tachometer-alt', roles: ['Admin'] },
            { 
                id: 'enquiries_parent', 
                label: 'Enquiries', 
                icon: 'fa-question-circle', 
                roles: ['Admin', 'Trainer', 'Training Coordinator'],
                submenu: [
                    { id: 'new_enquiry', label: 'New Enquiry', icon: 'fa-plus-circle', roles: ['Admin', 'Trainer', 'Training Coordinator'] },
                    { id: 'pending_enquiries', label: 'Pending Enquiries', icon: 'fa-file-signature', roles: ['Admin', 'Trainer', 'Training Coordinator'] }
                ]
            },
            { 
                id: 'nomination_parent', 
                label: 'Nomination', 
                icon: 'fa-user-check', 
                roles: ['Admin', 'Trainer', 'Training Coordinator'],
                submenu: [
                    { id: 'add_nomination', label: 'Add Nomination', icon: 'fa-user-plus', roles: ['Admin', 'Trainer', 'Training Coordinator'] },
                    { id: 'pending_nominations', label: 'Pending Nominations', icon: 'fa-tasks', roles: ['Admin', 'Trainer', 'Training Coordinator'] }
                ]
            },
            { id: 'all_records', label: 'All Records', icon: 'fa-list-ul', roles: ['Admin', 'Trainer', 'Training Coordinator'] },
            { id: 'schedule', label: 'Course Schedule', icon: 'fa-calendar-alt', roles: ['Admin', 'Trainer', 'Training Coordinator'] },
            { id: 'roster', label: 'Class Roster', icon: 'fa-clipboard-list', roles: ['Admin', 'Trainer', 'Training Coordinator', 'Accountant'] },
            { id: 'trainer', label: 'Trainer', icon: 'fa-chalkboard-teacher', roles: ['Admin'] },
            { id: 'rate_card', label: 'Rate Card', icon: 'fa-dollar-sign', roles: ['Admin'] },
            { id: 'results', label: 'Results', icon: 'fa-award', roles: ['Admin', 'Trainer'] },
            { id: 'feedback', label: 'Feedback', icon: 'fa-comments', roles: ['Admin', 'Trainer'] },
            { id: 'reports', label: 'Reports', icon: 'fa-chart-pie', roles: ['Admin'] },
            { id: 'invoices', label: 'Invoices', icon: 'fa-file-invoice-dollar', roles: ['Admin', 'Accountant'] },
            { id: 'certificates', label: 'Certificates', icon: 'fa-certificate', roles: ['Admin', 'Accountant'] },
            { id: 'revenue', label: 'Revenue', icon: 'fa-chart-line', roles: ['Admin', 'Accountant'] }
        ];

        // --- CORE AND SETUP FUNCTIONS ---
        function saveData(message = "Changes saved!") { localStorage.setItem('appData', JSON.stringify(appData)); showNotification(message); }
        
        function loadData() {
            const storedData = localStorage.getItem('appData');
            let loadedData = storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(initialData));

            for (const key in initialData) {
                if (!loadedData.hasOwnProperty(key)) {
                    loadedData[key] = JSON.parse(JSON.stringify(initialData[key]));
                }
            }
            
            if (loadedData.clients && typeof loadedData.clients[0] === 'string') {
                loadedData.clients = loadedData.clients.map(clientName => ({ name: clientName, type: 'company' }));
            }
             if (loadedData.enquiries && loadedData.enquiries.length > 0 && !loadedData.enquiries[0].hasOwnProperty('cost')) {
                loadedData.enquiries.forEach(enq => {
                    const course = initialData.courses.find(c => c.name === enq.course);
                    enq.cost = course ? course.cost : 0;
                });
            }

            appData = loadedData;

            // Data structure migration and safety checks
            if (appData.trainers && appData.trainers.length > 0 && typeof appData.trainers[0] === 'string') {
                appData.trainers = JSON.parse(JSON.stringify(initialData.trainers));
            }
            if (!appData.enquiries) appData.enquiries = [];
            if (!appData.notes) appData.notes = {};
            if (!appData.activityLog) appData.activityLog = {};
            if (!appData.clients) appData.clients = [];
            if (appData.clients && appData.clients.length > 0) {
                appData.clients.forEach(client => {
                    if (!client.hasOwnProperty('contactPerson')) client.contactPerson = '';
                    if (!client.hasOwnProperty('contactPhone')) client.contactPhone = '';
                    if (!client.hasOwnProperty('contactEmail')) client.contactEmail = '';
                });
            }
            if (!appData.classCapacity) appData.classCapacity = {};
            if (!appData.historicalPrices) appData.historicalPrices = {};
            if (!appData.rateCards) appData.rateCards = { byClient: {} };
            if (!appData.trainerLeaves) appData.trainerLeaves = [];
            if (!appData.batchCounters) appData.batchCounters = {};
            if (!appData.invoices) appData.invoices = [];
            // --- MODIFICATION: ENSURE 'batches' IS INITIALIZED ---
            if (!appData.batches) appData.batches = [];


            enquiryCounter = appData.enquiries.reduce((max, e) => Math.max(max, parseInt(e.id.split('-')[1] || 0)), 0);
            noteCounter = Object.values(appData.notes).flat().reduce((max, n) => Math.max(max, parseInt(n.id.split('-')[1] || 0)), 0);
            invoiceCounter = appData.invoices.reduce((max, i) => Math.max(max, parseInt((i.id.split('-')[2] || '0').match(/\d+/) || 0)), 0);
            appState.role = localStorage.getItem('userRole') || 'Admin';
            document.getElementById('roleSwitcher').value = appState.role;
        }

        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', () => document.getElementById('sideMenu').classList.toggle('collapsed'));
            document.getElementById('bellIconWrapper').addEventListener('click', () => toggleSidePanel('reminderPanel'));
            document.getElementById('mainContent').addEventListener('click', handleMainContentClick);
            document.addEventListener('click', handleOutsideClicks);
            document.getElementById('roleSwitcher').addEventListener('change', handleRoleChange);
            
            const searchInput = document.getElementById('searchInput');
            const searchClearBtn = document.getElementById('searchClearBtn');
            
            const handleSearch = () => {
                const newSearchTerm = searchInput.value.toLowerCase();
                if (appState.searchFilter === newSearchTerm) return;

                appState.searchFilter = newSearchTerm;
                
                // This is the crucial fix: Instead of a generic page reload,
                // call the specific data-rendering function for the current page.
                switch (appState.currentPage) {
                    case 'all_records':
                         renderEnquiriesListView('all');
                         break;
                    case 'pending_enquiries':
                         renderEnquiriesListView('pending');
                         break;
                    case 'pending_nominations':
                        loadClassSchedulerView();
                        break;
                    case 'roster':
                        loadClassRosterView();
                        break;
                    case 'trainer':
                         if (document.querySelector('table[data-view-id="trainers_view"]')) {
                            renderExistingTrainersList();
                        } else if (document.getElementById('leave-requests-table')) {
                            renderLeaveManagementPage();
                        }
                        break;
                    case 'results':
                        loadResultsView();
                        break;
                    case 'invoices':
                        loadInvoicesView();
                        break;
                    case 'revenue':
                        renderRevenuePage();
                        break;
                    case 'rate_card':
                        if (document.getElementById('baselineRCData')) {
                            renderBaselineRCPage();
                        } else if (currentClientForRC) {
                            renderRateCardForClient();
                        } else if (document.querySelector('.client-list-container')) {
                            renderClientListForRC();
                        }
                        break;
                    case 'schedule':
                        renderScheduleView();
                        break;
                    case 'add_nomination':
                        renderNominationPage();
                        break;
                }
            };
            
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                searchClearBtn.style.display = searchInput.value ? 'block' : 'none';
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(handleSearch, 300); // Debounce search
            });

            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                clearTimeout(searchTimeout);
                handleSearch(); // Immediately trigger search with empty term
            });
        }
        
        function handleRoleChange(e) {
            appState.role = e.target.value;
            localStorage.setItem('userRole', appState.role);

            const getNavigablePages = (menu) => {
                let pages = [];
                menu.forEach(item => {
                    if (item.submenu) {
                        pages = pages.concat(getNavigablePages(item.submenu));
                    } else {
                        pages.push(item);
                    }
                });
                return pages;
            };
            const allNavigablePages = getNavigablePages(menuConfig);
            const accessiblePages = allNavigablePages.filter(item => item.roles.includes(appState.role));
            const isCurrentPageAccessible = accessiblePages.some(p => p.id === appState.currentPage);

            if (!isCurrentPageAccessible && accessiblePages.length > 0) {
                appState.currentPage = accessiblePages[0].id;
            } else if (accessiblePages.length === 0) {
                appState.currentPage = null;
            }
            renderMenu();
            renderPage(appState.currentPage);
        }

        function handleMenuInteraction(e) {
            e.preventDefault();
            const link = e.target.closest('a');
            if (!link) return;

            if (link.dataset.page) {
                renderPage(link.dataset.page);
            } else if (link.dataset.toggle) {
                link.parentElement.classList.toggle('open');
            }
        }

        function handleMainContentClick(e) {
             const invoiceLink = e.target.closest('.view-invoice-link');
             if (invoiceLink) {
                e.preventDefault();
                const invoiceId = invoiceLink.dataset.invoiceId;
                openInvoiceModal(invoiceId);
                return;
             }

             const icon = e.target.closest('.action-icon');
             const button = e.target.closest('.btn[data-action]');
             const statCard = e.target.closest('.stat-card[data-navigate]');
             const th = e.target.closest('th.sortable');

             if (th) {
                handleTableSort(th);
                return;
             }

             if (statCard) {
                renderPage(statCard.dataset.navigate);
             } else if (icon) {
                const action = icon.dataset.action;
                const id = icon.closest('tr')?.dataset.id;
                if (action === 'availability') openAvailabilityPanel(id);
                if (action === 'notes') openNotesModal(id);
                if (action === 'view-log') openNotesModal(id, '', true);
                if (action === 'confirmNomination') confirmNomination(id);
                if (action === 'edit') openEditEnquiryModal(id);
                if (action === 'edit-quotation') openEditQuotationModal(id);
                if (action === 'view') openViewEnquiryModal(id);
                if (action === 'delete') deleteEnquiry(id);
                if (action === 'edit-agreement') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if (enq) {
                        const enquiriesForAgreement = appData.enquiries.filter(e => e.client === enq.client && e.status === 'Agreement Sent');
                        openAgreementModal(enquiriesForAgreement, { isEditable: true });
                    }
                }
             } else if (button) {
                const action = button.dataset.action;
                const id = button.closest('tr')?.dataset.id;
                
                if (action === 'send-quotation') {
                    openQuotationModal([id]);
                }
                if (action === 'view-roster') {
                    openClassRosterModal(id);
                }
                if (action === 'class-done') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if (enq) {
                        showConfirmation(`Are you sure you want to mark the class "${enq.course}" for "${enq.client}" as completed?`, () => {
                            enq.status = 'Completed';
                            logActivity(id, "Class Completed", "Status changed to Completed.");
                            saveData("Class marked as completed.");
                            loadClassRosterView(); // Reload the view
                            setTimeout(() => {
                                showConfirmation(`Class marked as completed. Generate invoice for ${enq.client}?`, () => {
                                    generateInvoiceForClient(enq.client);
                                });
                            }, 500); // Delay to allow first notification to be seen
                        });
                    }
                }
                 if (action === 'view-results') {
                    openResultsModal(id);
                }
                if (action === 'view-invoice') {
                   openInvoiceModal(id);
                }
                if (action === 'send-invoice') {
                    sendInvoiceByMail(id);
                }
                if (action === 'mark-paid') {
                    showConfirmation('Are you sure you want to mark this invoice as paid?', () => {
                        const invoice = appData.invoices.find(inv => inv.id === id);
                        if(invoice) {
                            invoice.status = 'Paid';
                            saveData(`Invoice ${id} marked as Paid.`);
                            loadInvoicesView();
                        }
                    });
                }
                if (action === 'confirm-by-client') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if (enq && enq.status === 'Quotation Sent') {
                        enq.status = 'Agreement Pending';
                        logActivity(id, "Quotation Agreed By Client", "Status changed to Agreement Pending.");
                        saveData("Quotation confirmed. Ready to send agreement.");
                        if (appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                            renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                        } else if (appState.currentPage === 'add_nomination') {
                           renderNominationPage();
                        }
                    }
                }
                if (action === 'send-agreement') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if (enq) {
                        const enquiriesForAgreement = appData.enquiries.filter(e => e.client === enq.client && e.status === 'Agreement Pending');
                        openAgreementModal(enquiriesForAgreement);
                    }
                }
                if (action === 'finalize-agreement') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if(enq) {
                        openViewAgreementModal(enq.client);
                    }
                }
                // --- MODIFICATION: This now triggers the new batch nomination flow ---
                 if (action === 'nominate' || action === 'edit-nomination') {
                    const enq = appData.enquiries.find(e => e.id === id);
                    if (!enq) return showNotification("Enquiry not found.", "error");

                    if (enq.batchNumber) {
                        const batch = appData.batches.find(b => b.batchId === enq.batchNumber);
                        if (batch) {
                            openBatchNominationModal(batch, { isJoining: true, joiningClient: enq.client, relatedEnquiries: [enq] });
                        } else {
                            showNotification(`Error: Batch ${enq.batchNumber} not found. Please re-assign.`, "error");
                            enq.batchNumber = null; // Clear invalid batch number
                            // Fall through to the logic below
                        }
                    } 
                    
                    if (!enq.batchNumber) {
                        const potentialBatchesToJoin = appData.batches.filter(b => b.courseName === enq.course && b.pending > 0);
                        
                        const assignToBatchOrNominate = (batchToJoin = null) => {
                            if (batchToJoin) {
                                enq.batchNumber = batchToJoin.batchId;
                                saveData(`Enquiry assigned to Batch ${batchToJoin.batchId}.`);
                                openBatchNominationModal(batchToJoin, { isJoining: true, joiningClient: enq.client, relatedEnquiries: [enq] });
                            } else {
                                const tempBatch = {
                                    batchId: `TEMP-${Date.now()}`, courseName: enq.course, date: enq.startDate,
                                    session: 'Morning', classCapacity: appData.classCapacity[enq.course] || enq.requested,
                                    nominated: 0, pending: appData.classCapacity[enq.course] || enq.requested,
                                    nominees: []
                                };
                                openBatchNominationModal(tempBatch, { isNew: true, client: enq.client, relatedEnquiries: [enq] });
                            }
                        };

                        if (potentialBatchesToJoin.length > 0) {
                            openJoinBatchModal(potentialBatchesToJoin, assignToBatchOrNominate);
                        } else {
                            assignToBatchOrNominate(null); // No choice but to create a new batch
                        }
                    }
                }
             }
             if (e.target.closest('.info-icon')) openPendingDetailsModal(e.target.closest('.info-icon').dataset);
        }
        function handleOutsideClicks(e) {
            const reminderPanel = document.getElementById('reminderPanel');
            if (reminderPanel.classList.contains('open') && !reminderPanel.contains(e.target) && !e.target.closest('.bell-icon-wrapper')) {
                toggleSidePanel('reminderPanel');
            }
            const availabilityPanel = document.getElementById('availabilityPanel');
            if (availabilityPanel.classList.contains('open') && !availabilityPanel.contains(e.target) && !e.target.closest('#checkAvailabilityBtn') && !e.target.closest('#nomTrainingDate') && !e.target.closest('#openSchedulePanelBtn')) {
                toggleSidePanel('availabilityPanel');
            }
            const pendingPeersPanel = document.getElementById('pendingPeersPanel');
            if (pendingPeersPanel.classList.contains('open') && !pendingPeersPanel.contains(e.target) && !e.target.closest('#viewPendingPeersLink')) {
                toggleSidePanel('pendingPeersPanel');
            }
        }

        // --- MENU & PAGE RENDERING ---
        function renderMenu() {
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';
            
            menuConfig.filter(item => item.roles.includes(appState.role)).forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.title = item.label;

                if (item.submenu) {
                    li.classList.add('has-submenu');
                    a.dataset.toggle = item.id;
                    a.innerHTML = `<i class="fas ${item.icon} icon"></i> <span class="text">${item.label}</span> <i class="fas fa-chevron-down submenu-toggle-icon"></i>`;
                    
                    const submenu = document.createElement('ul');
                    submenu.classList.add('submenu');
                    let isParentActive = false;
                    
                    const accessibleSubmenu = item.submenu.filter(subItem => (subItem.roles || item.roles).includes(appState.role));

                    accessibleSubmenu.forEach(subItem => {
                        const subLi = document.createElement('li');
                        const subA = document.createElement('a');
                        subA.href = '#';
                        subA.dataset.page = subItem.id;
                        subA.title = subItem.label;
                        subA.innerHTML = `<i class="fas ${subItem.icon} icon"></i> <span class="text">${subItem.label}</span>`;
                        if (subItem.id === appState.currentPage) {
                            subA.classList.add('active');
                            isParentActive = true;
                        }
                        subLi.appendChild(subA);
                        submenu.appendChild(subLi);
                    });

                    if (isParentActive) {
                        li.classList.add('open');
                    }
                    li.appendChild(a);
                    li.appendChild(submenu);
                } else {
                    a.dataset.page = item.id;
                    if (item.id === appState.currentPage) li.classList.add('active'); // Active class on LI for parent item
                    if (item.id === appState.currentPage) a.classList.add('active');
                    a.innerHTML = `<i class="fas ${item.icon} icon"></i> <span class="text">${item.label}</span>`;
                    li.appendChild(a);
                }
                menuList.appendChild(li);
            });

            menuList.removeEventListener('click', handleMenuInteraction);
            menuList.addEventListener('click', handleMenuInteraction);
        }
        
        function renderBreadcrumbs(trail) {
            const container = document.getElementById('breadcrumb-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous content

            trail.forEach((item, index) => {
                if (index === trail.length - 1) {
                    // Last item is active, just a span
                    const activeItem = document.createElement('span');
                    activeItem.className = 'breadcrumb-item active';
                    activeItem.textContent = item.label;
                    container.appendChild(activeItem);
                } else {
                    let breadcrumbEl;
                    if (item.onClick) {
                        // It's a clickable link
                        breadcrumbEl = document.createElement('a');
                        breadcrumbEl.href = '#';
                        breadcrumbEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            item.onClick();
                        });
                    } else {
                        // It's a non-clickable path segment
                        breadcrumbEl = document.createElement('span');
                    }
                    breadcrumbEl.className = 'breadcrumb-item';
                    breadcrumbEl.textContent = item.label;
                    container.appendChild(breadcrumbEl);
                    
                    // Add separator after the item
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '/';
                    container.appendChild(separator);
                }
            });
        }

        function renderPage(page) {
            // Sync search input with global state every time a page is rendered
            const searchInput = document.getElementById('searchInput');
            const searchClearBtn = document.getElementById('searchClearBtn');
            searchInput.value = appState.searchFilter || '';
            searchClearBtn.style.display = appState.searchFilter ? 'block' : 'none';

            if (!page) { document.getElementById('mainContent').innerHTML = `<div class="page-header"><div class="page-title">Access Denied</div></div><p>You do not have any pages assigned to your role.</p>`; return; }
            appState.currentPage = page;
            renderMenu();
            const mainContent = document.getElementById('mainContent');
            const pageTitle = menuConfig.flatMap(p => p.submenu || p).find(p => p.id === page)?.label || 'Page';
            const placeholderHTML = `<div class="page-header"><div id="breadcrumb-container"></div></div><p>${pageTitle} management page coming soon.</p>`;

            if (page === 'dashboard') renderDashboardPage();
            else if (page === 'all_records') renderEnquiriesListView('all');
            else if (page === 'pending_enquiries') renderEnquiriesListView('pending');
            else if (page === 'new_enquiry') renderNewEnquiryPage();
            else if (page === 'pending_nominations') renderClassSchedulerPage();
            else if (page === 'add_nomination') renderNominationPage();
            else if (page === 'schedule') renderSchedulePage();
            else if (page === 'roster') renderClassRosterPage();
            else if (page === 'rate_card') renderRateCardStartPage();
            else if (page === 'trainer') renderTrainerStartPage();
            else if (page === 'results') renderResultsPage();
            else if (page === 'reports') renderReportsPage();
            else if (page === 'certificates') renderCertificatesPage();
            else if (page === 'invoices') renderInvoicesPage();
            else if (page === 'revenue') renderRevenuePage();
            else { mainContent.innerHTML = placeholderHTML; renderBreadcrumbs([{label: pageTitle}]); }
        }

        // --- DASHBOARD PAGE ---
        function renderDashboardPage() {
            const mainContent = document.getElementById('mainContent');

            // --- Calculate Metrics ---
            const openEnquiriesCount = appData.enquiries.filter(e => ['Draft', 'Quotation Sent', 'Agreement Pending', 'Agreement Sent'].includes(e.status)).length;
            const pendingNominationsCount = appData.enquiries.filter(e => ['Pending Nomination', 'Nominated'].includes(e.status)).length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const sevenDaysLater = new Date(today);
            sevenDaysLater.setDate(today.getDate() + 7);

            const upcomingClassesCount = appData.schedules.filter(s => {
                const scheduleDate = new Date(s.date);
                return scheduleDate >= today && scheduleDate <= sevenDaysLater;
            }).length;
            
            const pendingLeavesCount = appData.trainerLeaves.filter(l => l.status === 'Pending').length;

            const pendingInvoices = appData.invoices.filter(inv => ['Draft', 'Sent'].includes(inv.status));
            const pendingInvoicesCount = pendingInvoices.length;
            const pendingInvoicesAmount = pendingInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);

            const totalRevenue = appData.invoices.filter(inv => inv.status === 'Paid').reduce((sum, inv) => sum + inv.totalAmount, 0);

            const todayStr = toYYYYMMDD(new Date());
            const todaysClasses = appData.schedules.filter(s => s.date === todayStr).sort((a,b) => a.startTime.localeCompare(b.startTime));
            const recentEnquiries = [...appData.enquiries].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            mainContent.innerHTML = `
                <div class="page-header">
                    <div id="breadcrumb-container"></div>
                </div>

                <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                     <div class="stat-card" data-navigate="invoices">
                        <div class="icon" style="background-color: var(--warning-color);"><i class="fas fa-file-invoice-dollar"></i></div>
                        <div class="info">
                            <div class="number">${pendingInvoicesCount}</div>
                            <div class="label">Pending Invoices</div>
                            <div class="label" style="font-size: 0.8rem; font-weight: bold;">(${pendingInvoicesAmount.toLocaleString(undefined, {minimumFractionDigits: 2})})</div>
                        </div>
                    </div>
                    <div class="stat-card" data-navigate="revenue">
                        <div class="icon" style="background-color: var(--success-color);"><i class="fas fa-chart-line"></i></div>
                        <div class="info">
                            <div class="number" style="font-size: 1.6rem;">${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                            <div class="label">Total Revenue</div>
                        </div>
                    </div>
                    <div class="stat-card" data-navigate="pending_enquiries">
                        <div class="icon" style="background-color: #3498db;"><i class="fas fa-file-alt"></i></div>
                        <div class="info">
                            <div class="number">${openEnquiriesCount}</div>
                            <div class="label">Open Enquiries</div>
                        </div>
                    </div>
                    <div class="stat-card" data-navigate="pending_nominations">
                        <div class="icon" style="background-color: #9b59b6;"><i class="fas fa-user-check"></i></div>
                        <div class="info">
                            <div class="number">${pendingNominationsCount}</div>
                            <div class="label">Pending Nominations</div>
                        </div>
                    </div>
                    <div class="stat-card" data-navigate="schedule">
                        <div class="icon" style="background-color: #16a085;"><i class="fas fa-calendar-alt"></i></div>
                        <div class="info">
                            <div class="number">${upcomingClassesCount}</div>
                            <div class="label">Upcoming Classes (7d)</div>
                        </div>
                    </div>
                    <div class="stat-card" data-navigate="trainer">
                        <div class="icon" style="background-color: var(--danger-color);"><i class="fas fa-calendar-times"></i></div>
                        <div class="info">
                            <div class="number">${pendingLeavesCount}</div>
                            <div class="label">Pending Leave Approvals</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-top: 20px;">
                    <div class="dashboard-section">
                        <h3>Today's Schedule</h3>
                        <div id="todays-schedule-list">
                            ${todaysClasses.length > 0 ? todaysClasses.map(s => {
                                const enq = appData.enquiries.find(e => e.id === s.enquiryId);
                                return `<div class="dashboard-list-item">
                                            <div>
                                                <strong>${s.course}</strong><br>
                                                <small>${enq ? enq.client : 'Internal'} | ${s.room}</small>
                                            </div>
                                            <span>${s.startTime} - ${s.endTime}</span>
                                        </div>`
                            }).join('') : '<p style="color:#888;">No classes scheduled for today.</p>'}
                        </div>
                    </div>
                    <div class="dashboard-section">
                        <h3>Recent Enquiries</h3>
                        <div id="recent-enquiries-list">
                            ${recentEnquiries.length > 0 ? recentEnquiries.map(e => `
                                <div class="dashboard-list-item">
                                    <div>
                                        <strong>${e.client}</strong><br>
                                        <small>${e.course}</small>
                                    </div>
                                    ${getStatusBadgeHTML(e.status)}
                                </div>
                            `).join('') : '<p style="color:#888;">No recent enquiries found.</p>'}
                        </div>
                    </div>
                </div>
            `;
            renderBreadcrumbs([{label: 'Dashboard'}]);
        }
        
        function getDisplayStatus(enq) {
            if (enq.status === 'Completed') {
                if (enq.certificateIssued) {
                    return 'Certificate Issued';
                }
                const invoice = appData.invoices.find(inv => inv.id === enq.invoiceId);
                if (invoice) {
                    if (invoice.status === 'Paid') {
                        return 'Payment Received';
                    }
                    return 'Payment Pending';
                }
                return 'Certificate Pending';
            }
            return enq.status;
        }


        function getStatusBadgeHTML(status) {
            if (!status) return '';
            const statusClass = status.toLowerCase().replace(/\s+/g, '-');
            return `<span class="status-badge status-${statusClass}">${status}</span>`;
        }

        function renderEnquiriesListView(filterType) {
            const mainContent = document.getElementById('mainContent');
            let currentStatusFilter = 'all'; // State for this view instance
            
            const pageTitle = filterType === 'all' 
                ? `All Records (${appData.enquiries.length})` 
                : `Pending Enquiries (${appData.enquiries.filter(e => ['Draft', 'Quotation Sent', 'Agreement Pending', 'Agreement Sent'].includes(e.status)).length})`;

            mainContent.innerHTML = `
                <div class="page-header">
                     <div id="breadcrumb-container"></div>
                     <div class="header-actions">
                        <button class="btn btn-primary new-enquiry-btn" onclick="renderPage('new_enquiry')">+ New Enquiry</button>
                        <div class="view-options">
                            <button data-view="table" class="view-btn active">Table</button>
                            <button data-view="course" class="view-btn">By Course</button>
                            <button data-view="client" class="view-btn">By Client</button>
                        </div>
                    </div>
                </div>
                <div id="status-filters-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);"></div>
                <div id="enquiryData"></div>`;
            
            if (filterType === 'all') {
                renderBreadcrumbs([{label: 'All Records'}]);
            } else { // pending
                renderBreadcrumbs([{label: 'Enquiries'}, {label: 'Pending Enquiries'}]);
            }
            
            const baseDataForFilters = filterType === 'all' 
                ? [...appData.enquiries] 
                : appData.enquiries.filter(enq => ['Draft', 'Quotation Sent', 'Agreement Pending', 'Agreement Sent'].includes(enq.status));
            
            const statusCounts = {};
            baseDataForFilters.forEach(enq => {
                const status = getDisplayStatus(enq);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statusFiltersEl = mainContent.querySelector('#status-filters-container');
            let filtersHTML = `<button class="btn btn-sm active-filter" data-status="all">All (${baseDataForFilters.length})</button>`;
            Object.keys(statusCounts).sort().forEach(status => {
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                filtersHTML += `<button class="btn btn-sm status-${statusClass}" data-status="${status}">${status} (${statusCounts[status]})</button>`;
            });
            statusFiltersEl.innerHTML = filtersHTML;

            const loadTable = () => {
                const viewType = mainContent.querySelector('.view-btn.active')?.dataset.view || 'table';
                const showBatchNumber = filterType === 'all';
                
                let data;
                if (filterType === 'all') {
                    data = [...appData.enquiries];
                } else { // 'pending'
                    data = appData.enquiries.filter(enq => ['Draft', 'Quotation Sent', 'Agreement Pending', 'Agreement Sent'].includes(enq.status));
                }

                if (appState.searchFilter) {
                    data = applyGlobalSearch(data, appState.searchFilter);
                }

                if (currentStatusFilter !== 'all') {
                    data = data.filter(enq => getDisplayStatus(enq) === currentStatusFilter);
                }
                
                const viewId = 'enquiries_view';
                const sortState = tableSortState[viewId];
                if (sortState) {
                    data = applyTableSorting(data, sortState.key, sortState.dir, sortState.type);
                } else {
                    if (viewType !== 'table') {
                        data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    }
                }

                const createTableRows = (dataset, currentViewType) => dataset.map((enq, index) => {
                    const pending = enq.requested - enq.nominated;
                    const date = new Date(enq.date).toLocaleDateString('en-GB');
                    
                    let row = `<td>${index + 1}</td><td>${enq.id}</td>${showBatchNumber ? `<td>${enq.batchNumber || '-'}</td>` : ''}`;
                    if (currentViewType === 'table') {
                        row += `<td><strong>${enq.client}</strong></td><td>${enq.course}</td>`;
                    } else if (currentViewType === 'client') {
                        row += `<td>${enq.course}</td>`;
                    } else if (currentViewType === 'course') {
                        row += `<td><strong>${enq.client}</strong></td>`;
                    }

                    const startDateFormatted = enq.startDate ? new Date(enq.startDate).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'numeric'}) : 'N/A';
                    
                    let costDiscountCell = '';
                     if (currentViewType === 'client' || currentViewType === 'table') {
                        const courseInfo = appData.courses.find(c => c.name === enq.course);
                        const baselineCost = courseInfo ? courseInfo.cost : enq.cost; 
                        const clientRateCard = appData.rateCards?.byClient?.[enq.client];
                        const courseDiscount = clientRateCard?.[enq.course]?.discount || 0;
                        
                        let cellText;
                        if (courseDiscount > 0) {
                            const finalCost = baselineCost * (1 - courseDiscount / 100);
                            cellText = `${finalCost.toFixed(2)} / ${courseDiscount}%`;
                        } else {
                            cellText = enq.cost.toFixed(2);
                        }
                        costDiscountCell = `<td class="text-center">${cellText}</td>`;
                    }

                    let actionsHTML = '';
                    if (enq.status === 'Draft') {
                        actionsHTML = `<button class="btn btn-secondary btn-sm" data-action="send-quotation" style="white-space: nowrap;">Send mail to client &rarr;</button>
                                        <span class="action-icon" data-action="edit" title="Edit Enquiry"><i class="fas fa-edit"></i></span>
                                        <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i></span>
                                        <span class="action-icon" data-action="delete" title="Delete Enquiry"><i class="fas fa-trash-alt"></i></span>`;
                    } else if (enq.status === 'Quotation Sent') {
                        actionsHTML = `<button class="btn btn-primary btn-sm" data-action="confirm-by-client">Quotation Agreed?</button>
                                       <span class="action-icon" data-action="edit-quotation" title="Edit Quotation"><i class="fas fa-edit"></i></span>
                                       <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i></span>
                                       <span class="action-icon" data-action="delete" title="Delete Enquiry"><i class="fas fa-trash-alt"></i></span>`;
                    } else if (enq.status === 'Agreement Pending') {
                        actionsHTML = `<button class="btn btn-primary btn-sm" data-action="send-agreement">Send Agreement &rarr;</button>
                                       <span class="action-icon" data-action="edit-quotation" title="Edit Quotation"><i class="fas fa-edit"></i></span>
                                       <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i></span>
                                       <span class="action-icon" data-action="delete" title="Delete Enquiry"><i class="fas fa-trash-alt"></i></span>`;
                    } else if (enq.status === 'Agreement Sent') {
                        actionsHTML = `<button class="btn btn-primary btn-sm" data-action="finalize-agreement">Confirm Agreement?</button>
                                       <span class="action-icon" data-action="edit-agreement" title="Edit Agreement"><i class="fas fa-edit"></i></span>
                                       <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i></span>
                                       <span class="action-icon" data-action="delete" title="Delete Enquiry"><i class="fas fa-trash-alt"></i></span>`;
                    } else {
                         actionsHTML = `<span class="action-icon" data-action="view" title="View Enquiry"><i class="fas fa-eye"></i></span>
                                        <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i></span>`;
                    }
                    
                    if (enq.invoiceId && !['Trainer', 'Training Coordinator'].includes(appState.role)) {
                        actionsHTML += `<span class="action-icon view-invoice-link" data-invoice-id="${enq.invoiceId}" title="View Invoice"><i class="fas fa-file-invoice"></i></span>`;
                    }

                    const displayStatus = getDisplayStatus(enq);
                    let statusCellHTML = getStatusBadgeHTML(displayStatus);

                    row += `<td class="text-center">${pending > 0 ? pending : '-'}<i class="fas fa-info-circle info-icon" data-requested="${enq.requested}" data-nominated="${enq.nominated}" data-pending="${pending}"></i></td>
                        ${costDiscountCell}
                        <td>
                            <div style="font-size: 11px; line-height: 1.4;">
                                <div>Date: ${startDateFormatted}</div>
                            </div>
                        </td>
                        <td class="text-center" style="font-size: 11px; line-height: 1.4;">${date}</td>
                        <td class="text-center">${statusCellHTML}</td>
                        <td>
                            <div class="action-icons-container">
                               ${actionsHTML}
                            </div>
                        </td>`;
                    return `<tr data-id="${enq.id}">${row}</tr>`;
                }).join('');

                const enquiryDataEl = document.getElementById('enquiryData');
                let headers = '';
                let tableContent = `<table class="data-table" data-view-id="${viewId}">`;
                let colspan;

                if (viewType === 'table') {
                    colspan = showBatchNumber ? 11 : 10;
                    headers = `<th>#</th><th class="sortable" data-sort-key="id">Enquiry ID</th>${showBatchNumber ? '<th>Batch No.</th>' : ''}<th class="sortable" data-sort-key="client">Client</th><th class="sortable" data-sort-key="course">Course</th><th class="sortable text-center" data-sort-key="requested" data-sort-type="number">Pending</th><th class="text-center">Cost/Discount</th><th class="sortable" data-sort-key="startDate" data-sort-type="date">Training Date</th><th class="sortable text-center" data-sort-key="date" data-sort-type="date">Created Date</th><th class="sortable text-center" data-sort-key="status">Status</th><th>Action</th>`;
                    tableContent += `<thead><tr>${headers}</tr></thead><tbody>`;
                    if(data.length > 0) {
                        tableContent += createTableRows(data, 'table');
                    }
                } else {
                    const groupHeaderColspan = showBatchNumber ? 4 : 3;
                    if (viewType === 'client') {
                        colspan = showBatchNumber ? 10 : 9;
                        headers = `<th>#</th><th class="sortable" data-sort-key="id">Enquiry ID</th>${showBatchNumber ? '<th>Batch No.</th>' : ''}<th class="sortable" data-sort-key="course">Course</th><th class="sortable text-center" data-sort-key="requested" data-sort-type="number">Pending</th><th class="text-center">Cost/Discount</th>`;
                    } else { // course view
                        colspan = showBatchNumber ? 9 : 8;
                        headers = `<th>#</th><th class="sortable" data-sort-key="id">Enquiry ID</th>${showBatchNumber ? '<th>Batch No.</th>' : ''}<th class="sortable" data-sort-key="client">Client</th><th class="sortable text-center" data-sort-key="requested" data-sort-type="number">Pending</th>`;
                    }
                    headers += `<th class="sortable" data-sort-key="startDate" data-sort-type="date">Training Date</th><th class="sortable text-center" data-sort-key="date" data-sort-type="date">Created Date</th><th class="sortable text-center" data-sort-key="status">Status</th><th>Action</th>`;
                    tableContent += `<thead><tr>${headers}</tr></thead><tbody>`;
                    
                    if (data.length > 0) {
                        const groupBy = viewType === 'client' ? 'client' : 'course';
                        
                        let groups;
                        if (sortState) {
                            groups = [...new Set(data.map(item => item[groupBy]))];
                        } else {
                            if (groupBy === 'client') {
                                const clientMaxDates = {};
                                data.forEach(enq => {
                                    const enqDate = new Date(enq.date);
                                    if (!clientMaxDates[enq.client] || enqDate > clientMaxDates[enq.client]) {
                                        clientMaxDates[enq.client] = enqDate;
                                    }
                                });
                                groups = Object.keys(clientMaxDates).sort((a, b) => clientMaxDates[b] - clientMaxDates[a]);
                            } else {
                                 groups = [...new Set(data.map(item => item[groupBy]))].sort();
                            }
                        }

                        groups.forEach(group => {
                            const groupData = data.filter(e => e[groupBy] === group);
                            const totalPending = groupData.reduce((sum, enq) => sum + (enq.requested - enq.nominated), 0);
                            const groupHeaderStyle = 'font-weight:bold; background-color: #f9f9f9;';
                            
                            const remainingCols = colspan - groupHeaderColspan - 1;
                            tableContent += `<tr>
                                <td colspan="${groupHeaderColspan}" style="${groupHeaderStyle}">${group}</td>
                                <td class="text-center" style="${groupHeaderStyle}"><span class="pending-badge">${totalPending}</span></td>
                                <td colspan="${remainingCols}" style="${groupHeaderStyle}"></td>
                            </tr>`;
                            tableContent += createTableRows(groupData, viewType);
                        });
                    }
                }

                if (data.length === 0) {
                    tableContent += `<tr><td colspan="${colspan}" class="text-center" style="padding: 20px;">No enquiries found for the selected filter</td></tr>`;
                }

                enquiryDataEl.innerHTML = tableContent + `</tbody></table>`;
                
                if (sortState) {
                    const th = enquiryDataEl.querySelector(`th[data-sort-key="${sortState.key}"]`);
                    if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            };

            statusFiltersEl.addEventListener('click', e => {
                const button = e.target.closest('button[data-status]');
                if (!button) return;
                
                const currentActive = statusFiltersEl.querySelector('.active-filter');
                if (currentActive) {
                    currentActive.classList.remove('active-filter');
                }
                button.classList.add('active-filter');
                
                currentStatusFilter = button.dataset.status;
                loadTable();
            });
            
            mainContent.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', e => { 
                mainContent.querySelector('.view-btn.active').classList.remove('active'); 
                e.target.classList.add('active'); 
                loadTable(); 
            }));
            
            loadTable();
        }

        function renderClassSchedulerPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `<div class="page-header">
                <div id="breadcrumb-container"></div>
                <div class="header-actions">
                     <div class="view-options">
                        <button data-view="table" class="view-btn active">Table View</button>
                        <button data-view="client" class="view-btn">By Client</button>
                        <button data-view="course" class="view-btn">By Course</button>
                    </div>
                </div>
            </div>
            <div id="nomination-status-filters-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);"></div>
            <div id="nominationData"></div>`;
            renderBreadcrumbs([{label: 'Nomination'}, {label: 'Pending Nominations'}]);
            document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', e => { 
                document.querySelector('#mainContent .view-btn.active').classList.remove('active'); 
                e.target.classList.add('active'); 
                loadClassSchedulerView(); 
            }));
            loadClassSchedulerView();
        }

        function loadClassSchedulerView() {
            let currentNominationStatusFilter = 'all';
            const mainContent = document.getElementById('mainContent');

            const getNominationDisplayStatus = (enq) => {
                if (enq.status === 'Scheduled') return 'Scheduled';
                const classCapacity = appData.classCapacity[enq.course] || enq.requested;
                if (enq.nominated >= classCapacity) return 'Fully Nominated';
                if (enq.nominated > 0) return 'Partially Nominated';
                return 'Pending Nomination';
            };
            
            const baseDataForFilters = appData.enquiries.filter(enq => ['Pending Nomination', 'Nominated'].includes(enq.status));
            
            const statusCounts = {};
            baseDataForFilters.forEach(enq => {
                const status = getNominationDisplayStatus(enq);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const statusFiltersEl = mainContent.querySelector('#nomination-status-filters-container');
            let filtersHTML = `<button class="btn btn-sm active-filter" data-status="all">All (${baseDataForFilters.length})</button>`;
            Object.keys(statusCounts).sort().forEach(status => {
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                filtersHTML += `<button class="btn btn-sm status-${statusClass}" data-status="${status}">${status} (${statusCounts[status]})</button>`;
            });
            statusFiltersEl.innerHTML = filtersHTML;


            const loadTable = () => {
                const viewType = document.querySelector('#mainContent .view-btn.active')?.dataset.view || 'table';
                let data = appData.enquiries.filter(enq => ['Pending Nomination', 'Nominated'].includes(enq.status));
                
                if (appState.searchFilter) {
                    data = applyGlobalSearch(data, appState.searchFilter);
                }

                if (currentNominationStatusFilter !== 'all') {
                    data = data.filter(enq => getNominationDisplayStatus(enq) === currentNominationStatusFilter);
                }
                
                const viewId = 'class_scheduler_view';
                const sortState = tableSortState[viewId];
                if(sortState) {
                    data = applyTableSorting(data, sortState.key, sortState.dir, sortState.type);
                } else {
                     if (viewType === 'table') {
                        data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    } else {
                        data.sort((a, b) => a.client.localeCompare(b.client) || new Date(b.date) - new Date(a.date));
                    }
                }
               
                const createTableRows = (dataset, currentView) => dataset.map((enq, index) => {
                    const date = new Date(enq.date).toLocaleDateString('en-GB');

                    let actionsHTML;
                     if (enq.status === 'Scheduled') { // This case will no longer appear but is kept for safety
                         actionsHTML = `
                            <button class="btn btn-secondary btn-sm" data-action="edit-nomination" title="Edit Nominees" style="display: inline-flex; align-items: center; gap: 5px;"><i class="fas fa-edit"></i> Edit</button>
                            <span class="action-icon" style="opacity: 0.5; pointer-events: none;" title="Confirmed"><i class="fas fa-check-circle" style="color: var(--success-color);"></i><span class="icon-label">Confirmed</span></span>
                            <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i><span class="icon-label">Notes</span></span>
                            <span class="action-icon" data-action="delete" title="Delete Nomination"><i class="fas fa-trash-alt"></i><span class="icon-label">Delete</span></span>
                        `;
                    } else { // status is 'Pending Nomination' or 'Nominated'
                        actionsHTML = `
                            <button class="btn btn-secondary btn-sm" data-action="edit-nomination" title="Edit Nominees" style="display: inline-flex; align-items: center; gap: 5px;"><i class="fas fa-edit"></i> Edit</button>
                            <span class="action-icon" data-action="confirmNomination" title="Confirm Nomination"><i class="fas fa-check-circle"></i><span class="icon-label">Confirm</span></span>
                            <span class="action-icon" data-action="notes" title="View Notes"><i class="fas fa-sticky-note"></i><span class="icon-label">Notes</span></span>
                            <span class="action-icon" data-action="delete" title="Delete Nomination"><i class="fas fa-trash-alt"></i><span class="icon-label">Delete</span></span>
                        `;
                    }
                    
                    let row = `<td>${index + 1}</td><td>${enq.id}</td><td>${enq.batchNumber || '-'}</td>`;
                    if (currentView === 'table') row += `<td>${enq.course}</td>`;
                    if (currentView === 'client') row += `<td>${enq.course}</td>`;
                    if (currentView === 'course') row += `<td><strong>${enq.client}</strong></td>`;
                    
                    const startDateFormatted = enq.startDate ? new Date(enq.startDate).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'numeric'}) : 'N/A';
                    
                    const classCapacity = appData.classCapacity[enq.course] || enq.requested;
                    
                    const displayStatus = getNominationDisplayStatus(enq);
                    const statusCellHTML = getStatusBadgeHTML(displayStatus);

                    row += `<td class="text-center">${enq.nominated} / ${classCapacity}</td>
                        <td>
                            <div style="font-size: 11px; line-height: 1.4;">
                                <div>Date: ${startDateFormatted}</div>
                            </div>
                        </td>
                        <td class="text-center">${date}</td>
                        <td class="text-center">${statusCellHTML}</td>
                        <td>
                            <div class="action-icons-container">
                               ${actionsHTML}
                            </div>
                        </td>`;
                    return `<tr data-id="${enq.id}">${row}</tr>`;
                }).join('');

                const nominationDataEl = document.getElementById('nominationData');
                
                let headers = `<th>#</th><th class="sortable" data-sort-key="id">Nomination ID</th><th>Batch No.</th>`;
                if (viewType === 'table') headers += `<th class="sortable" data-sort-key="course">Course</th>`;
                if (viewType === 'client') headers += `<th class="sortable" data-sort-key="course">Course</th>`;
                if (viewType === 'course') headers += `<th class="sortable" data-sort-key="client">Client</th>`;
                headers += `<th class="sortable text-center" data-sort-key="nominated" data-sort-type="number">Nominated / Class Capacity</th><th class="sortable" data-sort-key="startDate" data-sort-type="date">Training Date</th><th class="sortable text-center" data-sort-key="date" data-sort-type="date">Created Date</th><th class="sortable text-center" data-sort-key="status">Status</th><th class="text-center" style="width: 150px; text-align:left">Action</th>`;
                
                let tableContent = `<table class="data-table" data-view-id="${viewId}"><thead><tr>${headers}</tr></thead><tbody>`;
                const colspan = 9;

                if (data.length > 0) {
                    if (viewType === 'table') {
                        tableContent += createTableRows(data, 'table');
                    } else {
                        const groupBy = viewType === 'client' ? 'client' : 'course';
                        const groups = [...new Set(data.map(item => item[groupBy]))].sort();
                        groups.forEach(group => {
                            const groupData = data.filter(e => e[groupBy] === group);
                            tableContent += `<tr><td colspan="${colspan}" style="font-weight:bold; background-color: #f9f9f9;">${group}</td></tr>`;
                            tableContent += createTableRows(groupData, viewType);
                        });
                    }
                } else {
                    tableContent += `<tr><td colspan="${colspan}" class="text-center" style="padding: 20px;">No items found</td></tr>`;
                }
                
                nominationDataEl.innerHTML = tableContent + `</tbody></table>`;
                
                if (sortState) {
                    const th = nominationDataEl.querySelector(`th[data-sort-key="${sortState.key}"]`);
                    if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            }
            
            statusFiltersEl.addEventListener('click', e => {
                const button = e.target.closest('button[data-status]');
                if (!button) return;
                
                const currentActive = statusFiltersEl.querySelector('.active-filter');
                if (currentActive) currentActive.classList.remove('active-filter');
                
                button.classList.add('active-filter');
                currentNominationStatusFilter = button.dataset.status;
                loadTable();
            });

            loadTable();
        }
        
        // --- NEW NOMINATION WORKFLOW ---
        function renderNominationPage(selectedClient = null) {
            const mainContent = document.getElementById('mainContent');
            const clients = appData.clients.sort((a, b) => a.name.localeCompare(b.name));
            const clientOptions = `<option value="">Select Client...</option>` + clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            mainContent.innerHTML = `
                <style>
                    .nomination-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px; padding: 20px; background-color: #fff; border-radius: 0px; box-shadow: 0 1px 3px var(--shadow-color); }
                    .nomination-controls .form-group { margin-bottom: 0; display: flex; flex-direction: column; }
                    .nomination-controls .form-group label { margin-bottom: 5px; font-weight: 500;}
                    .nomination-controls .form-group select, .nomination-controls .form-group input { padding: 8px; border-radius: 0px; border: 1px solid var(--border-color); font-family: 'Inter', sans-serif; font-size: 14px; }
                    #new-client-form-container .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
                </style>
                <div class="page-header">
                    <div id="breadcrumb-container"></div>
                </div>
                <div id="nomination-page-container">
                    <div class="nomination-controls" id="client-selection-controls">
                        <div class="form-group" style="flex: 1 1 300px;">
                            <label for="nomClientSelect">Clients:</label>
                            <select id="nomClientSelect">${clientOptions}</select>
                        </div>
                        <div class="form-group">
                            <button id="addNewClientBtn" class="btn btn-primary">+ Add New Client</button>
                        </div>
                        <div class="form-group">
                            <button id="walkinClientBtn" class="btn btn-primary">Walk-in Client</button>
                        </div>
                    </div>

                    <div id="new-client-form-container" style="display:none; margin-bottom: 20px;"></div>

                    <div id="courseSelectionRow" class="nomination-controls" style="display: none;">
                        <!-- Course dropdown will be injected here -->
                    </div>
                    <div id="nominationDetailsContainer" style="margin-top: 20px;">
                        <!-- Nomination details form will be injected here -->
                    </div>
                </div>
            `;
            renderBreadcrumbs([{ label: 'Nomination' }, { label: 'Add Nomination' }]);

            const clientSelect = mainContent.querySelector('#nomClientSelect');
            clientSelect.addEventListener('change', handleClientSelectionForNomination);
            
            if (selectedClient) {
                clientSelect.value = selectedClient;
                clientSelect.dispatchEvent(new Event('change'));
            }

            mainContent.querySelector('#addNewClientBtn').addEventListener('click', () => {
                renderInlineNewClientForm();
            });
            mainContent.querySelector('#walkinClientBtn').addEventListener('click', () => {
                renderWalkinPersonalDetails();
            });
        }

        function renderInlineNewClientForm() {
            const clientSelectionControls = document.getElementById('client-selection-controls');
            const newClientFormContainer = document.getElementById('new-client-form-container');
            
            clientSelectionControls.style.display = 'none';
            newClientFormContainer.style.display = 'block';
            
            renderBreadcrumbs([
                { label: 'Nomination' },
                { label: 'Add Nomination', onClick: () => renderNominationPage() },
                { label: 'New Client' }
            ]);
            
            const breadcrumbContainer = document.getElementById('breadcrumb-container');
            const pageHeader = breadcrumbContainer.closest('.page-header');
            pageHeader.querySelector('.back-link')?.remove();
            
            const backLink = document.createElement('a');
            backLink.href = '#';
            backLink.className = 'back-link';
            backLink.innerHTML = '&larr; Back';
            backLink.style.cssText = 'display: block; margin-top: 15px; margin-bottom: 15px; font-size: 14px;';
            backLink.onclick = (e) => { e.preventDefault(); renderNominationPage(); };
            newClientFormContainer.insertAdjacentElement('beforebegin', backLink);

            newClientFormContainer.innerHTML = `
                 <div class="nomination-controls">
                    <div class="form-grid" style="width: 100%; align-items: flex-end; gap: 15px;">
                        <div class="form-group"><label>Client Name*</label><input type="text" id="newInlineClientName"></div>
                        <div class="form-group"><label>Contact Person*</label><input type="text" id="newInlineContactPerson"></div>
                        <div class="form-group"><label>Contact Number*</label><input type="text" id="newInlineContactNumber"></div>
                        <div class="form-group"><label>Email*</label><input type="email" id="newInlineEmail"></div>
                        <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end;">
                             <button id="createInlineClientBtn" class="btn btn-primary">Create</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('createInlineClientBtn').onclick = () => {
                const name = document.getElementById('newInlineClientName').value.trim();
                const person = document.getElementById('newInlineContactPerson').value.trim();
                const phone = document.getElementById('newInlineContactNumber').value.trim();
                const email = document.getElementById('newInlineEmail').value.trim();

                if (!name || !person || !phone || !email) {
                    return showNotification("All fields are required.", "error");
                }
                if (appData.clients.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                    return showNotification(`Client "${name}" already exists.`, "error");
                }

                const newClient = { name, type: 'company' };
                appData.clients.push(newClient);
                saveData(`New client "${name}" has been created.`);

                // Re-render the whole nomination page, now with the new client selected
                renderNominationPage(name);
            };
        }

        function handleClientSelectionForNomination() {
            const clientName = document.getElementById('nomClientSelect').value;
            const courseRow = document.getElementById('courseSelectionRow');
            const detailsContainer = document.getElementById('nominationDetailsContainer');
            const breadcrumbContainer = document.getElementById('breadcrumb-container');
            const pageHeader = breadcrumbContainer.closest('.page-header');

            pageHeader.querySelector('.back-link')?.remove();
            document.querySelector('.back-link')?.remove();

            if (clientName) {
                renderBreadcrumbs([
                    { label: 'Nomination' },
                    { label: 'Add Nomination', onClick: () => renderNominationPage() },
                    { label: 'Existing Client' }
                ]);

                document.getElementById('addNewClientBtn').style.display = 'none';
                document.getElementById('walkinClientBtn').style.display = 'none';

                const backLink = document.createElement('a');
                backLink.href = '#';
                backLink.className = 'back-link';
                backLink.innerHTML = '&larr; Back';
                backLink.style.cssText = 'display: block; margin-bottom: 15px; font-size: 14px;';
                backLink.onclick = (e) => {
                    e.preventDefault();
                    renderNominationPage();
                };
                document.getElementById('nomination-page-container').insertAdjacentElement('beforebegin', backLink);
                
                const courseOptions = `<option value="">Select Course...</option>` + appData.courses.sort((a, b) => a.name.localeCompare(b.name)).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                courseRow.innerHTML = `
                     <div class="form-group" style="flex: 1 1 300px;">
                        <label for="nomCourseSelect">Course:</label>
                        <select id="nomCourseSelect">${courseOptions}</select>
                    </div>
                    <div id="requestedCountDisplay" style="padding-left: 15px; font-weight: bold; align-self: center;"></div>
                `;
                courseRow.style.display = 'flex';
                document.getElementById('nomCourseSelect').addEventListener('change', handleCourseSelectionForNomination);
            } else {
                renderNominationPage();
            }
        }

        function handleCourseSelectionForNomination() {
            const clientName = document.getElementById('nomClientSelect').value;
            const courseName = document.getElementById('nomCourseSelect').value;
            const detailsContainer = document.getElementById('nominationDetailsContainer');
            const requestedCountDisplay = document.getElementById('requestedCountDisplay');

            detailsContainer.innerHTML = ''; // Clear previous form
            requestedCountDisplay.innerHTML = '';

            if (!courseName) return;

            // --- REFACTORED LOGIC START ---
            // Use the new appData.batches for checking
            const potentialBatchesToJoin = appData.batches.filter(batch => 
                batch.courseName === courseName &&
                batch.pending > 0
            );

            const proceedToNomination = (batchToJoin = null) => {
                if (batchToJoin) {
                    // We are JOINING an existing batch.
                    showNotification(`Joining existing batch ${batchToJoin.batchId}.`, "info");
                    // The 'isJoining' option tells the modal to behave differently.
                    openBatchNominationModal(batchToJoin, { isJoining: true, joiningClient: clientName });
                } else {
                    // We are CREATING a new batch.
                    const tempBatch = {
                        batchId: `TEMP-${Date.now()}`,
                        courseName: courseName,
                        date: null,
                        session: 'Morning',
                        classCapacity: appData.classCapacity[courseName] || 1,
                        nominated: 0,
                        pending: appData.classCapacity[courseName] || 1,
                        nominees: []
                    };
                    openBatchNominationModal(tempBatch, { isNew: true, client: clientName });
                }
            };
            
            // Open the selection modal if there are batches to join
            if (potentialBatchesToJoin.length > 0) {
                openJoinBatchModal(potentialBatchesToJoin, proceedToNomination);
            } else {
                proceedToNomination(null); // No merge options, create a new class.
            }
            // --- REFACTORED LOGIC END ---
        }
        
        // --- MODIFICATION: RENAMED and REFACTORED openMergeNominationModal to openJoinBatchModal ---
        function openJoinBatchModal(potentialBatches, callback) {
            const modal = document.getElementById('scheduleModal');
            
            const listItems = potentialBatches.map(batch => {
                const clientsInBatch = [...new Set(batch.nominees.map(n => n.name))].join(', ') || 'None';
                return `
                    <div class="merge-option" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                        <div>
                            <strong>Batch ID:</strong> ${batch.batchId}<br>
                            <strong>Course:</strong> ${batch.courseName}<br>
                            <strong>Clients in Batch:</strong> ${clientsInBatch}<br>
                            <strong>Date:</strong> ${batch.date ? new Date(batch.date).toLocaleDateString('en-GB') : 'Not Set'}<br>
                            <strong>Session:</strong> ${batch.session || 'N/A'}<br>
                            <strong>Available Seats:</strong> ${batch.pending}
                        </div>
                        <button class="btn btn-sm btn-primary join-class-btn" data-batch-id="${batch.batchId}">Join in this Batch</button>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div class="modal-content modal-md">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Available Batches Found</div>
                    <div class="modal-body">
                        <p>We found existing classes for this course with available seats. You can join one or create a new class.</p>
                        <div class="merge-options-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                             ${listItems.length > 0 ? listItems : '<p>No available batches found.</p>'}
                        </div>
                    </div>
                    <div class="modal-footer" style="justify-content: flex-end;">
                        <button id="createNewClassBtn" class="btn btn-secondary">Create a New Separate Class</button>
                    </div>
                </div>
            `;
            openModal(modal);

            const modalClickListener = e => {
                const joinBtn = e.target.closest('.join-class-btn');
                if (joinBtn) {
                    const targetBatchId = joinBtn.dataset.batchId;
                    const batchToJoin = appData.batches.find(b => b.batchId === targetBatchId);
                    closeModal(modal);
                    callback(batchToJoin);
                    modal.removeEventListener('click', modalClickListener);
                }
            };
            modal.addEventListener('click', modalClickListener);

            modal.querySelector('#createNewClassBtn').onclick = () => {
                closeModal(modal);
                callback(null);
                modal.removeEventListener('click', modalClickListener);
            };
            modal.querySelector('.modal-close').onclick = () => {
                closeModal(modal);
                modal.removeEventListener('click', modalClickListener);
            };
        }

        // This function is no longer needed as the workflow has changed to be batch-centric
        // function renderNominationDetailsForm(container, enquiry, options = {}) { ... }
        
        function renderClassRosterPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <div id="rosterData"></div>
            `;
            renderBreadcrumbs([{label: 'Class Roster'}]);
            loadClassRosterView();
        }

        function loadClassRosterView() {
            const container = document.getElementById('rosterData');
            const viewId = 'roster_view';
            let scheduledEnquiries = appData.enquiries
                .filter(e => e.status === 'Scheduled' || e.status === 'Completed');
            
            if (appState.searchFilter) {
                scheduledEnquiries = applyGlobalSearch(scheduledEnquiries, appState.searchFilter);
            }

            const sortState = tableSortState[viewId];
            if(sortState) {
                scheduledEnquiries = applyTableSorting(scheduledEnquiries, sortState.key, sortState.dir, sortState.type);
            } else {
                 scheduledEnquiries.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            }

            let tableRows = `<tr><td colspan="9" class="text-center" style="padding: 20px;">No scheduled or completed classes found.</td></tr>`;

            if (scheduledEnquiries.length > 0) {
                tableRows = scheduledEnquiries.map((enq, index) => {
                    const trainingDate = new Date(enq.startDate).toLocaleDateString('en-GB');
                    let actionsHTML = `<button class="btn btn-secondary btn-sm" data-action="view-roster">View</button>`;
                    if (enq.status === 'Scheduled') {
                        actionsHTML += `<button class="btn btn-primary btn-sm" data-action="class-done" style="margin-left: 5px;">Completed?</button>`;
                    }
                    return `
                        <tr data-id="${enq.id}">
                            <td>${index + 1}</td>
                            <td>${enq.id}</td>
                            <td>${enq.batchNumber || '-'}</td>
                            <td>${enq.client}</td>
                            <td>${enq.course}</td>
                            <td class="text-center">${trainingDate}</td>
                            <td class="text-center">${enq.nominated} / ${enq.requested}</td>
                            <td class="text-center">${getStatusBadgeHTML(enq.status)}</td>
                            <td class="text-center">
                                ${actionsHTML}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            container.innerHTML = `
                <table class="data-table" data-view-id="${viewId}">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th class="sortable" data-sort-key="id">Enquiry ID</th>
                            <th>Batch No.</th>
                            <th class="sortable" data-sort-key="client">Client</th>
                            <th class="sortable" data-sort-key="course">Course</th>
                            <th class="sortable text-center" data-sort-key="startDate" data-sort-type="date">Training Date</th>
                            <th class="text-center">Nominated / Requested</th>
                            <th class="sortable text-center" data-sort-key="status">Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;

            if (sortState) {
                const th = container.querySelector(`th[data-sort-key="${sortState.key}"]`);
                if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        function openClassRosterModal(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq) return showNotification("Enquiry not found", "error");

            let nomineesTable = `<p class="text-center" style="color: #888; padding: 20px 0;">No nominees found for this class.</p>`;
            if (enq.nominees && enq.nominees.length > 0) {
                nomineesTable = `
                    <table class="data-table">
                        <thead>
                            <tr><th>#</th><th>Civil ID</th><th>Student Name</th><th>Contact #</th><th>Email</th><th>Language</th></tr>
                        </thead>
                        <tbody>
                        ${enq.nominees.map((nom, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${nom.civilId || 'N/A'}</td>
                                <td>${nom.name}</td>
                                <td>${nom.phone || 'N/A'}</td>
                                <td>${nom.email || 'N/A'}</td>
                                <td>${nom.language || 'N/A'}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
            }

            const modal = document.getElementById('scheduleModal'); // Re-using a generic modal
            modal.innerHTML = `
                <div class="modal-content modal-xl">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Class Roster: ${enq.course} for ${enq.client}</div>
                    <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                        ${nomineesTable}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Close</button>
                        <button id="downloadRosterBtn" class="btn btn-primary">Download as Excel</button>
                    </div>
                </div>
            `;
            openModal(modal);

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('#downloadRosterBtn').onclick = () => downloadRosterAsCSV(enquiryId);
        }

        function downloadRosterAsCSV(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq || !enq.nominees || enq.nominees.length === 0) {
                return showNotification("No nominees to download.", "warning");
            }
            
            const headers = ["#", "Civil ID", "Student Name", "Contact #", "Email", "Language", "Time", "Notes"];

            const escapeCSV = (str) => {
                if (typeof str !== 'string') str = String(str || '');
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const csvRows = [headers.join(',')];
            enq.nominees.forEach((nom, index) => {
                const row = [
                    index + 1,
                    nom.civilId || '',
                    nom.name || '',
                    nom.phone || '',
                    nom.email || '',
                    nom.language || '',
                    nom.time || '',
                    nom.notes || ''
                ].map(escapeCSV);
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const dateStr = enq.startDate.replace(/-/g, '');
            const filename = `ClassRoster_${enq.course.replace(/\s+/g, '_')}_${dateStr}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification("Roster download started.", "success");
        }


        // --- NEW FEATURE: Updated New Client Workflow Functions ---
        function renderNewClientForm(initialData = {}) {
            const container = document.getElementById('mainContent');
            _tempWorkflowData.step = 1;

            container.innerHTML = `
                 <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <style>
                    .workflow-container { max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color); }
                    .form-grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                    .workflow-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
                    .workflow-container .form-group input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); font-family: 'Inter', sans-serif; font-size: 14px; width: 100%; box-sizing: border-box;}
                    @media (max-width: 767px) { .form-grid-2-col { grid-template-columns: 1fr; } }
                </style>
                <div class="workflow-container">
                    <h3 style="margin-top: 0; margin-bottom: 25px; text-align: center; color: var(--primary-color);">Step 1: New Client Details</h3>
                    <div class="form-grid-2-col">
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" id="newClientName" placeholder="e.g., Apex Global Services" value="${initialData.client?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Contact Person*</label>
                            <input type="text" id="newClientContactPerson" placeholder="e.g., Jane Doe" value="${initialData.contact?.contactName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Contact Number*</label>
                            <input type="text" id="newClientContactNumber" placeholder="e.g., 555-8765" value="${initialData.contact?.contactPhone || ''}">
                        </div>
                        <div class="form-group">
                            <label>Email ID*</label>
                            <input type="email" id="newClientEmail" placeholder="e.g., jane.d@apex.com" value="${initialData.contact?.contactEmail || ''}">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Government Document (Optional)</label>
                        <input type="file" id="newClientGovDoc">
                    </div>
                    <div class="workflow-actions">
                        <button id="saveAndContinueClientBtn" class="btn btn-primary">Save & Continue</button>
                    </div>
                </div>
            `;
             renderBreadcrumbs([
                { label: 'Nomination' },
                { label: 'Add Nomination', onClick: () => renderNominationPage() },
                { label: 'New Client' }
            ]);

            container.querySelector('#saveAndContinueClientBtn').addEventListener('click', () => {
                const clientName = document.getElementById('newClientName').value.trim();
                const contactPerson = document.getElementById('newClientContactPerson').value.trim();
                const contactNumber = document.getElementById('newClientContactNumber').value.trim();
                const email = document.getElementById('newClientEmail').value.trim();

                if (!clientName || !contactPerson || !contactNumber || !email) {
                    return showNotification("Please fill in all required fields (*).", "error");
                }

                if (appData.clients.some(c => c.name.toLowerCase() === clientName.toLowerCase())) {
                    return showNotification(`Client "${clientName}" already exists. Please use the 'Existing Client' option.`, "error");
                }
                
                const newClient = { name: clientName, type: 'company' };
                appData.clients.push(newClient);
                saveData(`New client "${clientName}" has been saved.`);

                _tempWorkflowData = {
                    client: newClient,
                    contact: { contactName: contactPerson, contactPhone: contactNumber, contactEmail: email }
                };

                renderNewEnquiryPageForClient();
            });
        }

        function renderNewEnquiryPageForClient() {
            const { client, contact } = _tempWorkflowData;
            _tempWorkflowData.step = 2;
            const container = document.getElementById('mainContent');

            container.innerHTML = `
                 <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <style>
                    .workflow-container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color); }
                    .form-grid-3-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
                    #workflowCourseTable th, #workflowCourseTable td { padding: 8px; }
                    #workflowCourseTable input[type=number] { width: 70px; padding: 4px; text-align: center; }
                    #workflowCourseTable .cost-cell { text-align: right; }
                    #workflowCourseTable .total-cost-cell { font-weight: bold; }
                    #workflowCourseTable .date-range-input { width: 220px; text-align: center; padding: 4px; }
                    .workflow-actions { display: flex; justify-content: space-between; gap: 10px; margin-top: 30px; }
                    .workflow-container .form-group input, .workflow-container .form-group select { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); font-family: 'Inter', sans-serif; font-size: 14px; width: 100%; box-sizing: border-box;}
                     @media (max-width: 767px) { .form-grid-3-col { grid-template-columns: 1fr; } }
                </style>
                <div class="workflow-container">
                    <h3 style="margin-top: 0; margin-bottom: 25px; text-align: center; color: var(--primary-color);">Step 2: Create Enquiries for ${client.name}</h3>
                     <div class="form-grid-3-col">
                         <div class="form-group"><label>Client Name</label><input type="text" value="${client.name}" disabled></div>
                         <div class="form-group"><label>Contact Person</label><input type="text" value="${contact.contactName}" disabled></div>
                         <div class="form-group"><label>Contact Phone</label><input type="text" value="${contact.contactPhone}" disabled></div>
                     </div>
                     <hr style="margin: 20px 0;">
                     <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start;">
                         <textarea id="dataPaste" rows="3" placeholder="Paste data here to auto-fill quantities (e.g., Fire Warden 15)" style="width: 100%;"></textarea>
                         <button id="processPasteBtn" class="btn btn-primary" style="white-space: nowrap;">Process</button>
                    </div>
                    <table class="data-table" id="workflowCourseTable">
                        <thead><tr><th class="text-center"></th><th>Course</th><th class="text-center">Qty</th><th>Training Date</th><th class="text-center">Cost/Person</th><th class="cost-cell">Total Cost</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="workflow-actions">
                        <button id="backToClientDetailsBtn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</button>
                        <div>
                             <button id="saveDraftsAndExitBtn" class="btn btn-secondary">Save Drafts & Exit</button>
                             <button id="generateQuotationBtn" class="btn btn-primary">Generate Quotation <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            `;
            renderBreadcrumbs([
                {label: 'Nomination', onClick: renderNominationPage},
                {label: 'New Client', onClick: renderNewClientForm},
                {label: 'Create Enquiry'}
            ]);
            
            const tbody = container.querySelector('#workflowCourseTable tbody');
            appData.courses.sort((a,b) => a.name.localeCompare(b.name)).forEach(course => {
                const row = tbody.insertRow();
                row.dataset.course = course.name;
                row.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="enq-select"></td>
                    <td>${course.name}</td>
                    <td class="text-center"><input type="number" class="enq-requested" value="0" min="0" disabled></td>
                    <td><input type="text" class="enq-date-range date-range-input" placeholder="Select date" disabled></td>
                    <td class="text-center"><input type="number" class="enq-cost-person" value="${course.cost.toFixed(2)}" min="0" step="0.01" disabled></td>
                    <td class="cost-cell total-cost-cell">-</td>
                `;
                const checkbox = row.querySelector('.enq-select'), qtyInput = row.querySelector('.enq-requested'), dateInput = row.querySelector('.enq-date-range'), costInput = row.querySelector('.enq-cost-person'), totalCell = row.querySelector('.total-cost-cell');
                const toggle = (e) => { [qtyInput, dateInput, costInput].forEach(i => { i.disabled = !e.checked; }); if(e.checked && qtyInput.value === '0') qtyInput.value = '1'; else if (!e.checked) qtyInput.value = '0'; calc(); };
                const calc = () => { const q = parseInt(qtyInput.value) || 0, c = parseFloat(costInput.value) || 0, t = q * c; totalCell.textContent = t > 0 ? t.toFixed(2) : '-'; };
                checkbox.addEventListener('change', () => toggle(checkbox));
                [qtyInput, costInput].forEach(i => i.addEventListener('input', calc));
                new Litepicker({ element: dateInput, singleMode: true, format: 'DD/MM/YYYY' });
            });
            
            const saveWorkflowEnquiries = (status) => {
                 const checkedRows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.querySelector('.enq-select').checked);
                if (checkedRows.length === 0) {
                    showNotification("No courses selected.", "error");
                    return null;
                }

                let validationPassed = true, newEnquiries = [];
                for (const row of checkedRows) {
                    const courseName = row.dataset.course, qty = parseInt(row.querySelector('.enq-requested').value), cost = parseFloat(row.querySelector('.enq-cost-person').value), dateRange = row.querySelector('.enq-date-range').value;
                    if (qty <= 0 || cost <= 0 || !dateRange) { showNotification(`Invalid data for '${courseName}'. Please check quantity, cost, and dates.`, 'error'); validationPassed = false; break; }
                    
                    const [day, month, year] = dateRange.split('/');
                    const formattedDate = `${year}-${month}-${day}`;

                    enquiryCounter++;
                    newEnquiries.push({
                        id: `ENQ-${enquiryCounter}`, course: courseName, client: client.name, cost,
                        contactName: contact.contactName, contactPhone: contact.contactPhone, contactEmail: contact.contactEmail,
                        status: status, date: new Date().toISOString().slice(0, 10), startDate: formattedDate, endDate: formattedDate,
                        requested: qty, nominated: 0, nominees: []
                    });
                }

                if (!validationPassed) return null;

                if (!appData.clients.some(c => c.name === client.name)) { appData.clients.push(client); }
                newEnquiries.forEach(enq => appData.enquiries.unshift(enq));
                return newEnquiries;
            };
            
            const processPastedData = () => processPastedCourseData(container.querySelector('#dataPaste'), tbody);
            container.querySelector('#processPasteBtn').onclick = processPastedData;

            container.querySelector('#backToClientDetailsBtn').addEventListener('click', () => renderNewClientForm(_tempWorkflowData));
            
            container.querySelector('#saveDraftsAndExitBtn').onclick = () => {
                const newEnquiries = saveWorkflowEnquiries('Draft');
                if(newEnquiries) {
                    saveData(`${newEnquiries.length} enquiries saved as draft.`);
                    renderPage('all_records');
                }
            };
            container.querySelector('#generateQuotationBtn').onclick = () => {
                const newEnquiries = saveWorkflowEnquiries('Draft'); // Always save as draft first
                if(newEnquiries) {
                    saveData(`${newEnquiries.length} enquiries saved.`);
                    openQuotationModal(newEnquiries.map(e => e.id));
                }
            };
        }
        
        function renderWalkinPersonalDetails(){
            const container = document.getElementById('mainContent');
            _tempWorkflowData = {}; // Reset for a new workflow
            _tempWorkflowData.step = 1;
            
            container.innerHTML = `
                 <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <div id="back-link-container"></div>
                <style>
                    .workflow-container { max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color); }
                    .form-grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                    .workflow-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
                    .workflow-container .form-group input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); font-family: 'Inter', sans-serif; font-size: 14px; width: 100%; box-sizing: border-box;}
                    @media (max-width: 767px) { .form-grid-2-col { grid-template-columns: 1fr; } }
                </style>
                <div class="workflow-container">
                    <!--  <h3 style="margin-top: 0; margin-bottom: 25px; text-align: center; color: var(--primary-color);">Step 1: Walk-in Client Details</h3> -->
                    <div class="form-grid-2-col">
                        <div class="form-group">
                            <label>Student Name*</label>
                            <input type="text" id="walkinStudentName" placeholder="e.g., John Smith">
                        </div>
                        <div class="form-group">
                            <label>Civil ID*</label>
                            <input type="text" id="walkinCivilId" placeholder="e.g., 199012345678">
                        </div>
                        <div class="form-group">
                            <label>Contact Number*</label>
                            <input type="text" id="walkinContactNumber" placeholder="e.g., 555-8765">
                        </div>
                        <div class="form-group">
                            <label>Email ID</label>
                            <input type="email" id="walkinEmail" placeholder="e.g., john.s@example.com">
                        </div>
                    </div>
                    <div class="workflow-actions">
                        <button id="saveAndContinueWalkinBtn" class="btn btn-primary">Save & Continue</button>
                    </div>
                </div>
            `;
            
            const backLinkContainer = container.querySelector('#back-link-container');
            const backLink = document.createElement('a');
            backLink.href = '#';
            backLink.className = 'back-link';
            backLink.innerHTML = '&larr; Back';
            backLink.style.cssText = 'display: block; margin-bottom: 15px; font-size: 14px;';
            backLink.onclick = (e) => { e.preventDefault(); renderNominationPage(); };
            backLinkContainer.appendChild(backLink);

            renderBreadcrumbs([
                { label: 'Nomination' },
                { label: 'Add Nomination', onClick: renderNominationPage },
                { label: 'Walk-in Client' }
            ]);

            container.querySelector('#saveAndContinueWalkinBtn').addEventListener('click', () => {
                const studentName = document.getElementById('walkinStudentName').value.trim();
                const civilId = document.getElementById('walkinCivilId').value.trim();
                const contactNumber = document.getElementById('walkinContactNumber').value.trim();
                const email = document.getElementById('walkinEmail').value.trim();

                if (!studentName || !civilId || !contactNumber) {
                    return showNotification("Please fill in Student Name, Civil ID, and Contact Number.", "error");
                }
                
                const clientName = studentName; // For individuals, client name is student name
                
                if (!appData.clients.some(c => c.name.toLowerCase() === clientName.toLowerCase())) { 
                    appData.clients.push({ name: clientName, type: 'individual' }); 
                }
                if (!appData.students.some(s => s.civilId === civilId)) {
                    appData.students.push({
                        civilId: civilId,
                        name: studentName,
                        phone: contactNumber,
                        email: email,
                        language: 'English' // Default language
                    });
                }
                
                saveData(`Walk-in client "${studentName}" created successfully.`);
                
                // Re-render the nomination page with the new client pre-selected
                renderNominationPage(clientName);
            });
        }

        function openAgreementModal(enquiries, options = {}) {
            const modal = document.getElementById('agreementModal');
            const { isEditable = false } = options;
            const clientName = enquiries[0].client;

            let actionsHTML = `<button id="sendAgreementBtn" class="btn btn-primary">Send Agreement</button>`;
            if (isEditable) {
                actionsHTML = `<button id="saveAgreementChangesBtn" class="btn btn-primary">Save Agreement Changes</button>`;
            }

            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Training Services Agreement</div>
                    <div class="modal-body" style="background-color: #f9f9f9; padding: 20px;">
                        ${getAgreementHTML(enquiries, options)}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Close</button>
                        ${actionsHTML}
                    </div>
                </div>
            `;
            
            openModal(modal);

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);

            if (isEditable) {
                const updateTotal = (row) => {
                    const qty = parseFloat(row.querySelector('.editable-qty').value) || 0;
                    const cost = parseFloat(row.querySelector('.editable-cost').value) || 0;
                    const totalCell = row.querySelector('.editable-total');
                    totalCell.textContent = (qty * cost).toFixed(2);
                    
                    let grandTotal = 0;
                    modal.querySelectorAll('.editable-total').forEach(cell => {
                        grandTotal += parseFloat(cell.textContent) || 0;
                    });
                    modal.querySelector('.grand-total-cell').textContent = grandTotal.toFixed(2);
                };

                modal.querySelectorAll('.editable-qty, .editable-cost').forEach(input => {
                    input.addEventListener('input', (e) => updateTotal(e.target.closest('tr')));
                });

                modal.querySelector('#saveAgreementChangesBtn').addEventListener('click', () => {
                    let changes = [];
                    modal.querySelectorAll('tbody tr').forEach(row => {
                        const enqId = row.dataset.enquiryId;
                        if (!enqId) return;
                        const enq = appData.enquiries.find(e => e.id === enqId);
                        const qtyInput = row.querySelector('.editable-qty');
                        const costInput = row.querySelector('.editable-cost');
                        const newQty = parseInt(qtyInput.value);
                        const newCost = parseFloat(costInput.value);

                        if (enq) {
                            if(enq.requested !== newQty) changes.push(`Qty for ${enq.course}: ${enq.requested} -> ${newQty}`);
                            if(enq.cost.toFixed(2) !== newCost.toFixed(2)) changes.push(`Cost for ${enq.course}: ${enq.cost.toFixed(2)} -> ${newCost.toFixed(2)}`);
                            enq.requested = newQty;
                            enq.cost = newCost;
                        }
                    });

                    if (changes.length > 0) {
                        logActivity(enquiries[0].id, "Agreement Edited", `Client: ${clientName}. Changes:\n${changes.join('\n')}`);
                        saveData("Agreement changes saved.");
                    } else {
                        showNotification("No changes detected.", "warning");
                    }
                    closeModal(modal);
                    // Refresh current view
                    if (appState.currentPage === 'add_nomination') renderNominationPage();
                    else if (appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                        renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                    }
                });
            }

            const sendBtn = modal.querySelector('#sendAgreementBtn');
            if(sendBtn) {
                 sendBtn.addEventListener('click', () => {
                    const contact = { contactName: enquiries[0].contactName, contactEmail: enquiries[0].contactEmail };
                    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Training Agreement</title></head><body>`;
                    const footer = "</body></html>";
                    const sourceHTML = header + modal.querySelector(".contract-container").innerHTML + footer;
                    
                    const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                    const fileDownload = document.createElement("a");
                    document.body.appendChild(fileDownload);
                    fileDownload.href = source;
                    fileDownload.download = `Training Agreement - ${clientName}.doc`;
                    fileDownload.click();
                    document.body.removeChild(fileDownload);

                    const subject = `Training Agreement from Sun Training Institute for ${clientName}`;
                    const body = `Dear ${contact.contactName},\n\nPlease find the training agreement (downloaded from your browser) attached for your review and confirmation.\n\nBest regards,\nSun Training Institute`;
                    const mailtoLink = `mailto:${contact.contactEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    showNotification("Agreement downloaded. Please attach it to the new email.", "success");
                    setTimeout(() => { window.location.href = mailtoLink; }, 500);
                    
                    enquiries.forEach(enq => {
                        if (enq.status === 'Agreement Pending') {
                            enq.status = 'Agreement Sent';
                            logActivity(enq.id, "Agreement Sent", `Status changed to Agreement Sent.`);
                        }
                    });
                    saveData("Agreement sent for client confirmation.");
                    closeModal(modal);
                     if (appState.currentPage === 'add_nomination') renderNominationPage();
                    else if (appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                         renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                    }
                });
            }
        }
        
        function getAgreementHTML(enquiries, options = {}) {
            const { isEditable = false } = options;
            const clientName = enquiries[0].client;
            const contact = { contactName: enquiries[0].contactName, contactEmail: enquiries[0].contactEmail, contactPhone: enquiries[0].contactPhone };
            const totalCost = enquiries.reduce((sum, enq) => sum + (enq.cost * enq.requested), 0);

            const client = appData.clients.find(c => c.name === clientName);
            const isIndividual = client && client.type === 'individual';
            const individualContact = isIndividual ? `${contact.contactEmail ? contact.contactEmail + ', ' : ''}${contact.contactPhone}` : '';

            const fontFamily = `font-family: 'Times New Roman', Times, serif;`;
            const containerStyle = `max-width: 850px; margin: 0 auto; background: #fff; padding: 50px; ${fontFamily} line-height: 1.6; color: #111;`;
            const headerStyle = `text-align: center; margin-bottom: 40px;`;
            const h2Style = `font-size: 24px; font-weight: bold; margin-bottom: 5px; ${fontFamily}`;
            const dateStyle = `font-size: 14px; color: #555; margin: 0;`;
            const sectionStyle = `margin-bottom: 30px;`;
            const h4Style = `font-size: 18px; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 15px; ${fontFamily}`;
            const pStyle = `margin: 5px 0 15px 0;`;
            const tableStyle = `border-collapse: collapse; width: 100%; font-size: 11pt; font-family: Calibri, sans-serif; border: 1px solid #cccccc; margin-top: 15px;`;
            const thStyle = `border: 1px solid #cccccc; padding: 10px; text-align: left; background-color: #f2f2f2; font-weight: bold;`;
            const tdStyle = `border: 1px solid #cccccc; padding: 10px; text-align: left; vertical-align: top;`;
            const totalRowStyle = `border: 1px solid #cccccc; padding: 10px; font-weight: bold; background-color: #f2f2f2;`;

            return `
                <style>
                    .contract-container { ${containerStyle} box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 5px; }
                </style>
                <div class="contract-container" id="contractToExport">
                    <div style="${headerStyle}">
                        <h2 style="${h2Style}">Training Services Agreement</h2>
                        <p style="${dateStyle}">Date: ${new Date().toLocaleDateString('en-GB')}</p>
                    </div>
                    <div style="${sectionStyle}">
                        <h4 style="${h4Style}">Parties</h4>
                        <p style="${pStyle}"><strong>Provider:</strong> Sun Training Institute</p>
                        ${isIndividual ? `
                            <p style="${pStyle}"><strong>Client:</strong> ${clientName} (${individualContact})</p>
                        ` : `
                            <p style="${pStyle}"><strong>Client:</strong> ${clientName}</p>
                            <p style="${pStyle}"><strong>Contact Person:</strong> ${contact.contactName} (${contact.contactEmail}, ${contact.contactPhone})</p>
                        `}
                    </div>
                    <div style="${sectionStyle}">
                        <h4 style="${h4Style}">Services</h4>
                        <p style="${pStyle}">The Provider agrees to deliver the following training courses to the Client:</p>
                        <table style="${tableStyle}">
                            <thead>
                                <tr>
                                    <th style="${thStyle}">Course</th>
                                    <th style="${thStyle}">Date</th>
                                    <th style="${thStyle}">Qty</th>
                                    <th style="${thStyle}">Unit Price</th>
                                    <th style="${thStyle}">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${enquiries.map(enq => {
                                    const start = new Date(enq.startDate).toLocaleDateString('en-GB');
                                    return `<tr data-enquiry-id="${enq.id}">
                                                <td style="${tdStyle}">${enq.course}</td>
                                                <td style="${tdStyle}">${start}</td>
                                                ${isEditable ? `
                                                    <td style="${tdStyle}"><input type="number" class="editable-qty" value="${enq.requested}" style="width: 60px; padding: 4px; border: 1px solid #ccc;"></td>
                                                    <td style="${tdStyle}"><input type="number" class="editable-cost" value="${enq.cost.toFixed(2)}" step="0.01" style="width: 80px; padding: 4px; border: 1px solid #ccc;"></td>
                                                    <td style="${tdStyle}" class="editable-total">${(enq.cost * enq.requested).toFixed(2)}</td>
                                                ` : `
                                                    <td style="${tdStyle}">${enq.requested}</td>
                                                    <td style="${tdStyle}">${enq.cost.toFixed(2)}</td>
                                                    <td style="${tdStyle}">${(enq.cost * enq.requested).toFixed(2)}</td>
                                                `}
                                            </tr>`
                                }).join('')}
                                <tr>
                                    <td colspan="4" style="${totalRowStyle} text-align: right;">Grand Total</td>
                                    <td style="${totalRowStyle}" class="grand-total-cell">${totalCost.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="${sectionStyle}">
                        <h4 style="${h4Style}">Terms & Conditions</h4>
                        <p style="${pStyle}">Standard terms and conditions apply. Payment is due within 3 days of invoice. Cancellations must be made 7 days prior to the training start date.</p>
                    </div>
                </div>
                `;
        }

        function renderSchedulePage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="page-header">
                     <div id="breadcrumb-container"></div>
                    <div class="header-actions">
                        <div class="view-options">
                            <button data-view="monthly" class="view-btn active">Monthly</button>
                            <button data-view="weekly" class="view-btn">Weekly</button>
                        </div>
                    </div>
                </div>
                <div id="schedule-view-container"></div>
            `;
            renderBreadcrumbs([{label: 'Course Schedule'}]);
            
            scheduleCurrentDate = new Date(); // Reset to today when loading page

            mainContent.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    mainContent.querySelector('.view-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    renderScheduleView();
                });
            });
            renderScheduleView();
        }

        function renderScheduleView() {
            const activeView = document.querySelector('#mainContent .view-btn.active')?.dataset.view || 'monthly';
            const container = document.getElementById('schedule-view-container');

            if (activeView === 'monthly') {
                renderMonthlySchedule(container);
            } else if (activeView === 'weekly') {
                renderWeeklySchedule(container);
            }
        }

        function renderMonthlySchedule(container) {
            container.innerHTML = `
                <div id="monthly-calendar-container">
                    <div class="monthly-calendar-header">
                        <button id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="month-year-header"></h2>
                        <button id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="monthly-calendar-grid days-header">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div class="monthly-calendar-grid days-body" id="calendar-body"></div>
                </div>
            `;

            const renderCalendar = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                document.getElementById('month-year-header').textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                const calendarBody = document.getElementById('calendar-body');
                calendarBody.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDayOfWeek = firstDayOfMonth.getDay();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < startDayOfWeek; i++) {
                    const prevMonthDay = new Date(year, month, 0).getDate() - startDayOfWeek + i + 1;
                    calendarBody.innerHTML += `<div class="calendar-day-cell other-month"><div class="day-number">${prevMonthDay}</div></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(year, month, day);
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day-cell';
                    if (cellDate.getTime() === today.getTime()) {
                        cell.classList.add('today');
                    }
                    
                    const dateString = toYYYYMMDD(cellDate);
                    let schedulesForDay = appData.schedules.filter(s => s.date === dateString);
                    
                    if (appState.searchFilter) {
                        schedulesForDay = applyGlobalSearch(schedulesForDay, appState.searchFilter);
                    }

                    schedulesForDay.sort((a,b) => a.startTime.localeCompare(b.startTime));

                    let eventsHTML = schedulesForDay.map(s => {
                        const enq = appData.enquiries.find(e => e.id === s.enquiryId);
                        const clientName = enq ? enq.client : 'Internal';
                        const isInternal = !enq;
                        return `<div class="calendar-event-item ${isInternal ? 'internal' : ''}" data-schedule-id="${s.id}" title="${s.startTime}-${s.endTime} | ${s.course} | ${clientName}">
                                    ${s.startTime} ${s.course}
                                </div>`;
                    }).join('');

                    cell.innerHTML = `<div class="day-number">${day}</div><div class="day-content">${eventsHTML}</div>`;
                    calendarBody.appendChild(cell);
                }

                const totalCells = startDayOfWeek + daysInMonth;
                const remainingCells = 42 - totalCells;
                for(let i=1; i <= remainingCells; i++) {
                     calendarBody.innerHTML += `<div class="calendar-day-cell other-month"><div class="day-number">${i}</div></div>`;
                }
            };

            renderCalendar(scheduleCurrentDate);

            document.getElementById('prev-month-btn').onclick = () => {
                scheduleCurrentDate.setMonth(scheduleCurrentDate.getMonth() - 1);
                renderCalendar(scheduleCurrentDate);
            };

            document.getElementById('next-month-btn').onclick = () => {
                scheduleCurrentDate.setMonth(scheduleCurrentDate.getMonth() + 1);
                renderCalendar(scheduleCurrentDate);
            };
            
            document.getElementById('calendar-body').onclick = (e) => {
                const eventItem = e.target.closest('.calendar-event-item');
                if (eventItem && eventItem.dataset.scheduleId) {
                    openScheduleDetailModal(eventItem.dataset.scheduleId);
                }
            };
        }

        function renderWeeklySchedule(container) {
            container.innerHTML = `
                <div id="weekly-schedule-container">
                    <div class="weekly-schedule-header">
                        <button id="prev-week-btn" class="nav-btn">&lt; Previous week</button>
                        <h2 id="week-header"></h2>
                        <button id="next-week-btn" class="nav-btn">Next Week &gt;</button>
                    </div>
                    <table class="weekly-schedule-table" id="weekly-schedule-table"></table>
                </div>
            `;

            const populateWeeklyTable = (date) => {
                const table = document.getElementById('weekly-schedule-table');
                table.innerHTML = '';

                const getWeekStart = (d) => {
                    const date = new Date(d);
                    const day = date.getDay();
                    const diff = date.getDate() - day;
                    return new Date(date.setDate(diff));
                };

                const weekStart = getWeekStart(date);
                const weekDates = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(weekStart);
                    d.setDate(d.getDate() + i);
                    return d;
                });

                const weekEnd = weekDates[6];
                const headerFormat = { month: 'short', day: 'numeric' };
                const startStr = weekStart.toLocaleDateString('en-GB', headerFormat);
                const endStr = weekEnd.toLocaleDateString('en-GB', headerFormat);
                document.getElementById('week-header').textContent = `${startStr} - ${endStr}, ${weekStart.getFullYear()}`;

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headerRow.innerHTML = `<th>Class Room</th><th>Timing</th>`;
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                weekDates.forEach((d, i) => {
                    headerRow.innerHTML += `<th>${days[i]}<br>${d.getDate()}</th>`;
                });
                
                const weekStartStr = toYYYYMMDD(weekDates[0]);
                const weekEndStr = toYYYYMMDD(weekDates[6]);
                let weekSchedules = appData.schedules.filter(s => s.date >= weekStartStr && s.date <= weekEndStr);
                
                if (appState.searchFilter) {
                    weekSchedules = applyGlobalSearch(weekSchedules, appState.searchFilter);
                }

                const tbody = table.createTBody();
                const rooms = ['Room 1', 'Room 2', 'Room 3', 'Conference Hall'];
                const totalTimeSlots = 11; 
                
                rooms.forEach(room => {
                    const roomScheduleGrid = Array(totalTimeSlots).fill(0).map(() => Array(7).fill(null));

                    weekSchedules.filter(s => s.room === room).forEach(schedule => {
                        const eventDate = new Date(schedule.date + 'T00:00:00');
                        const dayIndex = eventDate.getDay();
                        
                        const startHour = parseInt(schedule.startTime.split(':')[0]);
                        const endHour = parseInt(schedule.endTime.split(':')[0]);
                        const duration = endHour - startHour;
                        const timeIndex = startHour - 7;

                        if (timeIndex >= 0 && timeIndex < totalTimeSlots) {
                            roomScheduleGrid[timeIndex][dayIndex] = { event: schedule, rowspan: duration };
                            for (let i = 1; i < duration; i++) {
                                if (timeIndex + i < totalTimeSlots) {
                                    roomScheduleGrid[timeIndex + i][dayIndex] = 'covered';
                                }
                            }
                        }
                    });

                    for (let timeIndex = 0; timeIndex < totalTimeSlots; timeIndex++) {
                        const row = tbody.insertRow();
                        const currentHour = timeIndex + 7;

                        if (timeIndex === 0) {
                            const roomCell = row.insertCell();
                            roomCell.textContent = `${room}`;
                            roomCell.classList.add('room-cell');
                            roomCell.rowSpan = totalTimeSlots;
                        }

                        const timeCell = row.insertCell();
                        timeCell.classList.add('time-cell');
                        timeCell.textContent = `${currentHour.toString().padStart(2, '0')}:00 - ${(currentHour + 1).toString().padStart(2, '0')}:00`;

                        if (currentHour === 13) {
                            const lunchCell = row.insertCell();
                            lunchCell.textContent = "Lunch";
                            lunchCell.colSpan = 7;
                            lunchCell.classList.add('lunch-cell');
                        } else {
                            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                                const cellData = roomScheduleGrid[timeIndex][dayIndex];
                                if (cellData === 'covered') {
                                } else if (cellData) {
                                    const eventCell = row.insertCell();
                                    eventCell.rowSpan = cellData.rowspan;
                                    const trainerName = cellData.event.trainer || 'N/A';
                                    eventCell.innerHTML = `
                                        <div class="event-block" data-schedule-id="${cellData.event.id}" title="${cellData.event.course} by ${trainerName}">
                                            <span class="event-course">${cellData.event.course}</span>
                                            <span class="event-trainer">${trainerName}</span>
                                        </div>`;
                                } else {
                                    row.insertCell();
                                }
                            }
                        }
                    }
                });
            };

            populateWeeklyTable(scheduleCurrentDate);

            document.getElementById('prev-week-btn').onclick = () => {
                scheduleCurrentDate.setDate(scheduleCurrentDate.getDate() - 7);
                populateWeeklyTable(scheduleCurrentDate);
            };
            document.getElementById('next-week-btn').onclick = () => {
                scheduleCurrentDate.setDate(scheduleCurrentDate.getDate() + 7);
                populateWeeklyTable(scheduleCurrentDate);
            };
            document.getElementById('weekly-schedule-table').onclick = (e) => {
                const eventBlock = e.target.closest('.event-block');
                if (eventBlock && eventBlock.dataset.scheduleId) {
                    openScheduleDetailModal(eventBlock.dataset.scheduleId);
                }
            };
        }

        // --- MODALS AND PANELS ---
        function deleteEnquiry(enquiryId) {
            showConfirmation(`Are you sure you want to delete enquiry ${enquiryId}?`, () => {
                const index = appData.enquiries.findIndex(e => e.id === enquiryId);
                if (index > -1) {
                    logActivity(enquiryId, "Enquiry Deleted");
                    appData.enquiries.splice(index, 1);
                    delete appData.notes[enquiryId]; 
                    appData.schedules = appData.schedules.filter(s => s.enquiryId !== enquiryId);
                    saveData(`Enquiry ${enquiryId} deleted.`);
                    
                    if (appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                        renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                    } else if (appState.currentPage === 'pending_nominations') {
                        loadClassSchedulerView();
                    }
                }
            });
        }
        
        function generateBatchNumber(courseName) {
            const initial = courseName.charAt(0).toUpperCase();
            if (!appData.batchCounters) {
                appData.batchCounters = {}; 
            }
            let currentCount = appData.batchCounters[initial] || 0;
            currentCount++;
            appData.batchCounters[initial] = currentCount;
            const paddedCount = String(currentCount).padStart(3, '0');
            return `Batch-${initial}-${paddedCount}`;
        }

        function confirmNomination(enquiryId) {
            const enquiry = appData.enquiries.find(e => e.id === enquiryId);
            if (!enquiry) return;
            
            if (enquiry.nominated === 0) {
                return showNotification("Cannot confirm a nomination with 0 nominees.", "error");
            }
            if (!enquiry.startDate) {
                showNotification("Please set the Training Dates for this enquiry before confirming.", "error");
                return openEditEnquiryModal(enquiryId);
            }

            const confirmAction = () => {
                enquiry.status = 'Scheduled';

                // Assign batch number if it doesn't have one
                if (!enquiry.batchNumber) {
                    enquiry.batchNumber = generateBatchNumber(enquiry.course);
                }

                logActivity(enquiryId, "Nomination Confirmed", `${enquiry.nominated} nominees confirmed and status changed to Scheduled. Assigned to Batch: ${enquiry.batchNumber}.`);

                let schedule = appData.schedules.find(s => s.enquiryId === enquiryId);
                if (schedule) {
                    schedule.status = 'Confirmed';
                } else {
                    schedule = {
                        id: `SCH-${Date.now()}`,
                        enquiryId: enquiry.id,
                        course: enquiry.course,
                        date: enquiry.startDate,
                        startTime: '09:00',
                        endTime: '17:00',
                        room: 'TBD',
                        trainer: 'TBD',
                        status: 'Confirmed'
                    };
                    appData.schedules.push(schedule);
                    logActivity(enquiryId, "Schedule Auto-Created", `Schedule created on confirmation for date: ${schedule.date}`);
                }

                saveData(`Nomination for ${enquiry.course} confirmed and scheduled.`);
                
                if (appState.currentPage === 'pending_nominations') {
                    loadClassSchedulerView();
                } else if (appState.currentPage === 'add_nomination') {
                    renderNominationPage();
                }

                if (appState.currentPage === 'schedule') {
                    renderScheduleView();
                }
            };

            if (enquiry.nominated < enquiry.requested) {
                showConfirmation(`This is a partial nomination (${enquiry.nominated}/${enquiry.requested}). Are you sure you want to confirm the nomination for '${enquiry.course}' and mark it as scheduled?`, confirmAction);
            } else {
                confirmAction();
            }
        }
        
        function openNotesModal(enquiryId, prefillText = "", defaultToLog = false) {
            currentEnquiryId = enquiryId;
            const modal = document.getElementById('notesModal');
            modal.innerHTML = `<div class="modal-content modal-lg">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Notes for ${currentEnquiryId}</div>
                <div class="modal-body" style="overflow-y: hidden;">
                    <div class="notes-modal-tabs">
                        <div class="tab active" data-tab="user-notes">User Notes</div>
                        <div class="tab" data-tab="activity-log">Activity Log</div>
                    </div>
                    <div id="user-notes-content" class="notes-tab-content active" style="max-height: 450px; overflow-y: auto;">
                        <div style="display:flex; gap:20px;">
                            <div style="width:40%;">
                                <textarea id="noteInput" rows="8" style="width:100%; box-sizing: border-box; padding: 8px;">${prefillText}</textarea>
                                <label style="margin-top:10px; display:block;">Reminder Date:</label>
                                <input type="date" id="noteDueDate" style="width:100%; padding: 8px; box-sizing: border-box;">
                                <div style="margin-top:15px;"><button id="saveNoteBtn" class="btn btn-primary">Save Note</button></div>
                            </div>
                            <div style="width:60%; border-left:1px solid var(--border-color); padding-left:20px;" id="notesDisplay"></div>
                        </div>
                    </div>
                    <div id="activity-log-content" class="notes-tab-content" style="max-height: 450px; overflow-y: auto;"></div>
                </div>
            </div>`;
            openModal(modal);

            modal.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', e => {
                    modal.querySelector('.tab.active').classList.remove('active');
                    e.target.classList.add('active');
                    modal.querySelector('.notes-tab-content.active').classList.remove('active');
                    document.getElementById(e.target.dataset.tab + '-content').classList.add('active');
                });
            });

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('#saveNoteBtn').onclick = saveNote;
            renderNotesForEnquiry(currentEnquiryId);
            renderActivityLog(currentEnquiryId);
            
            if (defaultToLog) {
                modal.querySelector('.tab[data-tab="user-notes"]').classList.remove('active');
                modal.querySelector('#user-notes-content').classList.remove('active');
                modal.querySelector('.tab[data-tab="activity-log"]').classList.add('active');
                modal.querySelector('#activity-log-content').classList.add('active');
            }
        }

        function saveNote() {
            const content = document.getElementById('noteInput').value.trim();
            const dueDate = document.getElementById('noteDueDate').value;
            if (!content) return;
            
            noteCounter++;
            if (!appData.notes[currentEnquiryId]) appData.notes[currentEnquiryId] = [];
            appData.notes[currentEnquiryId].push({ id: `NID-${noteCounter}`, content, created: new Date().toISOString().slice(0,10), dueDate });
            logActivity(currentEnquiryId, "User Note Added", `Note: "${content.substring(0, 50)}..."`);
            saveData("Note saved successfully.");
            
            renderNotesForEnquiry(currentEnquiryId);
            renderActivityLog(currentEnquiryId);
            updateAllReminders();
            document.getElementById('noteInput').value = '';
            document.getElementById('noteDueDate').value = '';
        }

        function renderNotesForEnquiry(enquiryId) {
            const notes = appData.notes[enquiryId] || [];
            const display = document.getElementById('notesDisplay');
            display.innerHTML = notes.length === 0 ? `<p>No notes for this enquiry.</p>` : notes.map(note => `<div class="note-item" data-note-id="${note.id}"><p>${note.content}</p><div style="font-size: 10px; color: #888;">Created: ${new Date(note.created).toLocaleDateString('en-GB')} ${note.dueDate ? ` | Due: ${new Date(note.dueDate).toLocaleDateString('en-GB')}` : ''}</div></div>`).join('');
        }
        
        function renderActivityLog(enquiryId) {
            const log = appData.activityLog[enquiryId] || [];
            const display = document.getElementById('activity-log-content');
            if(log.length === 0) {
                display.innerHTML = `<p>No activity recorded yet.</p>`;
                return;
            }
            display.innerHTML = [...log].reverse().map(entry => {
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                return `<div class="activity-log-item">
                    <div class="activity-log-header">${entry.activity}</div>
                    ${entry.details ? `<div class="activity-log-details">${entry.details.replace(/\n/g, '<br>')}</div>` : ''}
                    <div class="activity-log-meta">${entry.user} on ${formattedDate} at ${formattedTime}</div>
                </div>`;
            }).join('');
        }
        
        function logActivity(enquiryId, activity, details = "") {
            if (!appData.activityLog[enquiryId]) {
                appData.activityLog[enquiryId] = [];
            }
            appData.activityLog[enquiryId].push({
                timestamp: new Date().toISOString(),
                user: appState.role,
                activity,
                details
            });
        }
        
        function showConfirmation(message, onConfirm, onCancel) {
            const modal = document.getElementById('confirmationModal');
            modal.innerHTML = `<div class="modal-content modal-sm"><div class="modal-body confirmation-modal-body"><p>${message}</p><div class="confirmation-modal-actions"><button id="confirmBtn" class="btn btn-primary">Yes</button><button id="cancelBtn" class="btn btn-secondary">Cancel</button></div></div></div>`;
            openModal(modal);
            document.getElementById('confirmBtn').onclick = () => { onConfirm(); closeModal(modal); };
            document.getElementById('cancelBtn').onclick = () => {
                if (typeof onCancel === 'function') {
                    onCancel();
                }
                closeModal(modal);
            };
        }
        
        // --- MODIFICATION: This function is now the central point for starting the nomination flow after agreement. ---
        function openViewAgreementModal(clientName) {
            const enquiriesForAgreement = appData.enquiries.filter(e => e.client === clientName && e.status === 'Agreement Sent');
            if (enquiriesForAgreement.length === 0) return;
        
            const agreementHTML = getAgreementHTML(enquiriesForAgreement);

            const modal = document.getElementById('scheduleModal'); // Re-use a generic modal
            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Confirm Agreement for ${clientName}</div>
                    <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                        ${agreementHTML}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Cancel</button>
                        <button class="btn btn-primary">Yes, Confirm</button>
                    </div>
                </div>
            `;

            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                // Change status for all related enquiries
                enquiriesForAgreement.forEach(e => {
                    e.status = 'Pending Nomination';
                    logActivity(e.id, "Agreement Confirmed by User", `Status changed to Pending Nomination, ready for nomination.`);
                });
                saveData(`Agreement for ${clientName} confirmed.`);
                closeModal(modal);
                
                // --- MODIFICATION: Now checks for available batches and handles user choice ---
                const firstEnquiry = enquiriesForAgreement[0];
                const potentialBatchesToJoin = appData.batches.filter(batch => 
                    batch.courseName === firstEnquiry.course &&
                    batch.pending > 0
                );

                const assignToBatchOrNominate = (batchToJoin = null) => {
                    if (batchToJoin) {
                        // User chose to JOIN an existing batch
                        enquiriesForAgreement.forEach(enq => {
                            enq.batchNumber = batchToJoin.batchId;
                        });
                        saveData(`Enquiries for ${clientName} assigned to Batch ${batchToJoin.batchId}.`);
                        showNotification("Please go to the Pending Nominations page to add students.", "success");
                        renderPage('pending_nominations'); // Navigate away as requested
                    } else {
                        // User chose to CREATE a new batch
                        const tempBatch = {
                            batchId: `TEMP-${Date.now()}`,
                            courseName: firstEnquiry.course,
                            date: firstEnquiry.startDate,
                            session: 'Morning',
                            classCapacity: appData.classCapacity[firstEnquiry.course] || firstEnquiry.requested,
                            nominated: 0,
                            pending: appData.classCapacity[firstEnquiry.course] || firstEnquiry.requested,
                            nominees: []
                        };
                        openBatchNominationModal(tempBatch, { isNew: true, client: clientName, relatedEnquiries: enquiriesForAgreement });
                    }
                };

                if (potentialBatchesToJoin.length > 0) {
                    openJoinBatchModal(potentialBatchesToJoin, assignToBatchOrNominate);
                } else {
                    assignToBatchOrNominate(null); // No choice, must create new
                }
            };
        }

        function openPendingDetailsModal(data) {
            const modal = document.getElementById('pendingDetailsModal');
            modal.innerHTML = `<div class="modal-content modal-sm"><span class="modal-close">&times;</span><div class="modal-title">Nomination Details</div><div class="modal-body"><p><strong>Requested:</strong> ${data.requested}</p><p><strong>Nominated:</strong> ${data.nominated}</p><p><strong>Pending:</strong> ${data.pending}</p></div></div>`;
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
        }

        // --- REMINDER PANEL ---
        function toggleSidePanel(panelId) {
            document.querySelectorAll('.side-panel').forEach(p => {
                if(p.id !== panelId) p.classList.remove('open');
            });
            const panel = document.getElementById(panelId);
            panel.classList.toggle('open');
            if (panel.classList.contains('open') && panelId === 'reminderPanel') {
                renderReminders();
            }
        }
        function updateAllReminders() {
            let allReminders = [];
            Object.keys(appData.notes).forEach(enqId => { appData.notes[enqId].forEach(note => { if (note.dueDate) { const enquiry = appData.enquiries.find(e => e.id === enqId); if (enquiry) allReminders.push({ ...note, enqId, client: enquiry.client, course: enquiry.course }); } }); });
            updateReminderBadge(allReminders);
            return allReminders;
        }
        function updateReminderBadge(reminders) {
            const badge = document.getElementById('reminderBadge');
            const today = new Date(); today.setHours(0,0,0,0);
            const overdueCount = reminders.filter(r => new Date(r.dueDate) < today).length;
            const totalCount = reminders.length;
            badge.innerHTML = totalCount > 0 ? `(<span class="overdue-count">${overdueCount}</span>/${totalCount})` : '';
        }
        function renderReminders() {
            const panel = document.getElementById('reminderPanel');
            const allReminders = updateAllReminders();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdue = [], todayReminders = [], upcoming = [];

            allReminders.forEach(r => {
                const [year, month, day] = r.dueDate.split('-').map(Number);
                const dueDate = new Date(year, month - 1, day);

                if (dueDate.getTime() < today.getTime()) {
                    overdue.push(r);
                } else if (dueDate.getTime() === today.getTime()) {
                    todayReminders.push(r);
                } else {
                    upcoming.push(r);
                }
            });

            const reminders = {
                overdue: overdue.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)),
                today: todayReminders,
                upcoming: upcoming.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
            };

            panel.innerHTML = `<div class="side-panel-header"><div class="title">Reminders</div><span class="close-btn" onclick="toggleSidePanel('reminderPanel')">&times;</span></div><div class="side-panel-body"><div style="display:flex; border-bottom:1px solid var(--border-color); background-color:#fff;" class="reminder-tabs"><div class="tab active" data-tab="today" style="flex-grow:1; text-align:center; padding:15px 10px; cursor:pointer;">Today (${reminders.today.length})</div><div class="tab" data-tab="overdue" style="flex-grow:1; text-align:center; padding:15px 10px; cursor:pointer;">Overdue (${reminders.overdue.length})</div><div class="tab" data-tab="upcoming" style="flex-grow:1; text-align:center; padding:15px 10px; cursor:pointer;">Upcoming (${reminders.upcoming.length})</div></div><div class="reminder-content" style="flex-grow:1; overflow-y:auto; padding-top:15px;"></div></div>`;
            
            panel.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (e) => {
                panel.querySelector('.tab.active')?.classList.remove('active');
                e.currentTarget.classList.add('active');
                renderReminderContent(reminders[e.currentTarget.dataset.tab], panel);
            }));
            renderReminderContent(reminders.today, panel);
        }
        function renderReminderContent(data, panel) {
            const contentEl = panel.querySelector('.reminder-content');
            contentEl.innerHTML = data.length === 0 ? `<p style="padding: 15px; color: #888;">No reminders.</p>` : data.map(r => `<div class="reminder-item" data-note-id="${r.id}" data-enq-id="${r.enqId}"><p style="margin:0 0 8px 0;"><strong>Client:</strong> ${r.client}</p><p style="margin:0;"><strong>Note: </strong>${r.content}</p><div style="font-size:10px; color:#888; margin-top:5px;">Due: ${new Date(r.dueDate).toLocaleDateString('en-GB')}</div></div>`).join('');
        }

        // --- AVAILABILITY PANEL ---
        function openNominationSchedulePanel(enq) {
            const panel = document.getElementById('availabilityPanel');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let calendarDefaultDate = enq.startDate ? new Date(enq.startDate) : today;
            if (calendarDefaultDate < today) calendarDefaultDate = today;
            
            const trainerOptions = `<option value="">Select Trainer...</option>` + appData.trainers.filter(t => t.status === 'Active').map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            const roomOptions = `<option value="">Select Room...</option>` + appData.rooms.map(r => `<option value="${r}">${r}</option>`).join('');

            panel.innerHTML = `
                <div class="side-panel-header">
                    <div class="title" id="availability-title">Set Schedule for ${enq.course}</div>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="side-panel-body" style="display: flex; flex-direction: row; gap: 15px; padding: 15px;">
                    <div class="calendar-container" style="flex: 0 0 300px;"></div>
                    <div class="details-container" style="flex: 1 1 auto; display: flex; flex-direction: column; min-width: 0; overflow-y: auto; border-left: 1px solid var(--border-color); padding-left: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; flex-shrink: 0;">
                            <div class="form-group" style="margin:0;"><label>Select Trainer</label><select id="panelTrainerSelect">${trainerOptions}</select></div>
                            <div class="form-group" style="margin:0;"><label>Select Room</label><select id="panelRoomSelect">${roomOptions}</select></div>
                        </div>
                        <div id="slots-date-header" style="font-weight: bold; margin-bottom: 10px; flex-shrink: 0;"></div>
                        <div class="time-slots-container" style="overflow-y: auto; flex-grow: 1;"></div>
                    </div>
                </div>`;

            const calContainer = panel.querySelector('.calendar-container');
            const slotsContainer = panel.querySelector('.time-slots-container');
            const trainerSelect = panel.querySelector('#panelTrainerSelect');
            const roomSelect = panel.querySelector('#panelRoomSelect');

            const renderAndToggle = (date) => {
                renderCalendar(calContainer, slotsContainer, date, enq.course, 'session');
                const trainerName = trainerSelect.value;
                if(trainerName){
                    renderSessionSlotsForPanel(slotsContainer, date, trainerName, enq);
                } else {
                     slotsContainer.innerHTML = '<p class="text-center" style="color: #888; padding-top:20px;">Please select a trainer to see available sessions.</p>';
                     document.getElementById('slots-date-header').textContent = `Sessions for ${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' })}`;
                }
            };

            const refreshSlots = () => {
                const selectedDay = calContainer.querySelector('.cal-day.selected');
                const day = selectedDay ? parseInt(selectedDay.dataset.day) : calendarDefaultDate.getDate();
                const month = parseInt(calContainer.querySelector('#month-select').value);
                const year = parseInt(calContainer.querySelector('#year-select').value);
                renderAndToggle(new Date(year, month, day));
            };

            trainerSelect.addEventListener('change', refreshSlots);
            roomSelect.addEventListener('change', refreshSlots);
            
            renderAndToggle(calendarDefaultDate);
            
            panel.querySelector('.close-btn').onclick = () => { toggleSidePanel('availabilityPanel'); };
            toggleSidePanel('availabilityPanel');
        }

        function renderCalendar(calContainer, slotsContainer, selectedDate, courseName, mode = 'hourly') {
            const month = selectedDate.getMonth();
            const year = selectedDate.getFullYear();
            
            const monthSelect = `<select id="month-select">${Array.from({length: 12}, (_, i) => `<option value="${i}" ${i === month ? 'selected' : ''}>${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('')}</select>`;
            const yearSelect = `<select id="year-select">${Array.from({length: 10}, (_, i) => `<option value="${new Date().getFullYear() - 5 + i}" ${new Date().getFullYear() - 5 + i === year ? 'selected' : ''}>${new Date().getFullYear() - 5 + i}</option>`).join('')}</select>`;

            calContainer.innerHTML = `<div class="calendar-header"><div class="calendar-nav">${monthSelect}${yearSelect}</div></div><div class="cal-grid"><div class="day-name">Su</div><div class="day-name">Mo</div><div class="day-name">Tu</div><div class="day-name">We</div><div class="day-name">Th</div><div class="day-name">Fr</div><div class="day-name">Sa</div></div>`;
            
            const grid = calContainer.querySelector('.cal-grid');
            const handleDateChange = () => {
                const newYear = parseInt(calContainer.querySelector('#year-select').value);
                const newMonth = parseInt(calContainer.querySelector('#month-select').value);
                const newDate = new Date(newYear, newMonth, 1);
                
                 const trainerName = document.getElementById('panelTrainerSelect')?.value;
                 renderCalendar(calContainer, slotsContainer, newDate, courseName, mode);
                 if(trainerName) renderSessionSlotsForPanel(slotsContainer, newDate);
            };

            calContainer.querySelector('#month-select').addEventListener('change', handleDateChange);
            calContainer.querySelector('#year-select').addEventListener('change', handleDateChange);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            const today = new Date();
            today.setHours(0,0,0,0);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day'; dayEl.textContent = day; dayEl.dataset.day = day;
                const currentDate = new Date(year, month, day);

                if (currentDate < today) dayEl.classList.add('disabled');
                
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                if (day === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                
                dayEl.onclick = (e) => {
                    if (e.target.classList.contains('disabled')) return;
                    e.stopPropagation();
                    const newSelectedDate = new Date(year, month, day);
                    const trainerName = document.getElementById('panelTrainerSelect')?.value;
                    renderCalendar(calContainer, slotsContainer, newSelectedDate, courseName, mode);
                    if(trainerName) {
                       renderSessionSlotsForPanel(slotsContainer, newSelectedDate);
                    }
                };
                grid.appendChild(dayEl);
            }
        }
        
        function renderSessionSlotsForPanel(slotsContainer, date, trainerName, enq) {
            const dateString = toYYYYMMDD(date);
            document.getElementById('slots-date-header').textContent = `Sessions for ${date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}`;
            
            const trainerOnLeave = appData.trainerLeaves.find(l => trainerName === l.trainerName && l.status === 'Approved' && dateString >= l.startDate && dateString <= l.endDate);

            const sessions = {
                Morning: { start: 8, end: 13, label: 'Morning Session (08:00 - 13:00)' },
                Evening: { start: 14, end: 18, label: 'Evening Session (14:00 - 18:00)' },
                Full: { start: 8, end: 18, label: 'Full day session (08:00 - 18:00)' }
            };

            let slotsHTML = '';

            for (const sessionName in sessions) {
                const session = sessions[sessionName];
                let isAvailable = true;

                if (trainerOnLeave) {
                    isAvailable = false;
                } else {
                    const conflict = appData.schedules.find(s => {
                        if (s.date !== dateString || s.trainer !== trainerName) return false;
                        const sStart = parseInt(s.startTime.split(':')[0]);
                        const sEnd = parseInt(s.endTime.split(':')[0]);
                        return (session.start < sEnd && session.end > sStart);
                    });

                    if (conflict) { isAvailable = false; }
                }
                
                slotsHTML += `
                    <div class="time-slot" style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <span class="time">${session.label}</span>
                            ${sessionName === 'Full' ? '<small style="display: block; color: #666;">(Includes 13:00 - 14:00 lunch break)</small>' : ''}
                        </div>
                        <button class="btn btn-sm btn-primary book-session-btn" data-session="${sessionName}" ${!isAvailable ? 'disabled' : ''}>Schedule</button>
                    </div>`;
            }

            slotsContainer.innerHTML = slotsHTML || '<p class="text-center" style="color: #888;">No sessions available.</p>';
            
            slotsContainer.querySelectorAll('.book-session-btn').forEach(btn => {
                btn.onclick = (e) => {
                     const modal = document.getElementById('nominationDetailsModal');
                    const session = e.target.dataset.session;
                    const trainer = document.getElementById('panelTrainerSelect').value;
                    const room = document.getElementById('panelRoomSelect').value;

                    if (!trainer || !room) {
                        return showNotification("Please select both a trainer and a room.", "error");
                    }
                    
                    modal.querySelector('#nomScheduleDate').value = date.toLocaleDateString('en-GB');
                    modal.querySelector('#nomScheduleTime').value = session;

                    modal._scheduleData = {
                        date: toYYYYMMDD(date),
                        trainer,
                        room,
                        session
                    };

                    toggleSidePanel('availabilityPanel');
                };
            });
        }

        function handleRemoveReservation(scheduleId, slotsContainer, date, enquiryId) {
            showConfirmation("Are you sure you want to remove this reservation?", () => {
                appData.schedules = appData.schedules.filter(s => s.id !== scheduleId);
                saveData("Reservation removed.");
                renderTimeSlots(slotsContainer, date, enquiryId);
            });
        }
        
        function handleBookedSlotAction(e, scheduleId, slotsContainer, date, enquiryId) {
            if (e.target.classList.contains('fa-eye')) openScheduleDetailModal(scheduleId);
            if (e.target.classList.contains('fa-edit')) openEditScheduleModal(scheduleId, slotsContainer, date, enquiryId);
            if (e.target.classList.contains('fa-trash-alt')) {
                showConfirmation("Are you sure you want to delete this booking?", () => {
                    appData.schedules = appData.schedules.filter(s => s.id !== scheduleId);
                    saveData("Booking deleted.");
                    renderTimeSlots(slotsContainer, date, enquiryId);
                });
            }
        }

        // --- SCHEDULE & EDIT MODALS ---
        function openScheduleDetailModal(scheduleId) {
            const schedule = appData.schedules.find(s => s.id === scheduleId);
            if (!schedule) return showNotification("Schedule not found.", "error");

            const enq = appData.enquiries.find(e => e.id === schedule.enquiryId);
            if (!enq) return showNotification("Associated enquiry not found.", "error");

            const modal = document.getElementById('scheduleDetailModal');

            const startDateFormatted = enq.startDate ? new Date(enq.startDate  + 'T00:00:00').toLocaleDateString('en-GB') : 'N/A';
            const createdDate = new Date(enq.date).toLocaleDateString('en-GB');

            let nomineesTable = `<p style="text-align:center; color:#888;">No nominees found for this course.</p>`;
            if (enq.nominees && enq.nominees.length > 0) {
                nomineesTable = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Civil ID</th>
                                <th>Student Name</th>
                                <th>Contact #</th>
                                <th>Email</th>
                                <th>Language</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${enq.nominees.map((nom, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${nom.civilId || 'N/A'}</td>
                                    <td>${nom.name}</td>
                                    <td>${nom.phone || 'N/A'}</td>
                                    <td>${nom.email || 'N/A'}</td>
                                    <td>${nom.language || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Schedule Details: ${schedule.id}</div>
                    <div class="modal-body">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group"><label>Client Name</label><input value="${enq.client}" disabled></div>
                            <div class="form-group"><label>Course Name</label><input value="${schedule.course}" disabled></div>
                            <div class="form-group"><label>Nominated / Requested</label><input value="${enq.nominated} / ${enq.requested}" disabled></div>
                            <div class="form-group"><label>Training Date</label><input value="${startDateFormatted}" disabled></div>
                            <div class="form-group"><label>Enquiry Created</label><input value="${createdDate}" disabled></div>
                            <div class="form-group"><label>Time</label><input value="${schedule.startTime} - ${schedule.endTime}" disabled></div>
                            <div class="form-group"><label>Trainer</label><input value="${schedule.trainer || 'TBD'}" disabled></div>
                            <div class="form-group"><label>Room</label><input value="${schedule.room || 'TBD'}" disabled></div>
                        </div>
                        <hr style="margin: 20px 0;">
                        <h4 style="margin-top:0; margin-bottom: 10px;">Nominee Details</h4>
                        <div style="max-height: 250px; overflow-y: auto;">
                            ${nomineesTable}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Close</button>
                    </div>
                </div>
            `;
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
        }

        function openEditScheduleModal(scheduleId, slotsContainer, date, enquiryId) {
            const schedule = appData.schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            const enq = appData.enquiries.find(e => e.id === schedule.enquiryId) || {};

            const modal = document.getElementById('editScheduleModal');
            const trainerOptions = appData.trainers.map(t => `<option value="${t.name}" ${t.name === schedule.trainer ? 'selected' : ''}>${t.name}</option>`).join('');
            const roomOptions = appData.rooms.map(r => `<option value="${r}" ${r === schedule.room ? 'selected' : ''}>${r}</option>`).join('');

            modal.innerHTML = `<div class="modal-content modal-md">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Edit Schedule Details</div>
                <div class="modal-body">
                     <div class="form-grid">
                        <div class="form-group"><label>Client Name</label><input value="${enq.client || 'Internal Booking'}" disabled></div>
                        <div class="form-group"><label>Course Name</label><input value="${schedule.course}" disabled></div>
                        <div class="form-group"><label>Contact Person</label><input id="editContactName" type="text" value="${enq.contactName || ''}" ${!enq.id ? 'disabled' : ''}></div>
                        <div class="form-group"><label>Contact Phone</label><input id="editContactPhone" type="text" value="${enq.contactPhone || ''}" ${!enq.id ? 'disabled' : ''}></div>
                        <div class="form-group"><label>Contact Email</label><input id="editContactEmail" type="email" value="${enq.contactEmail || ''}" ${!enq.id ? 'disabled' : ''}></div>
                        <div class="form-group"><label>Status</label><input value="${enq.status || 'Confirmed'}" disabled></div>
                        <div class="form-group"><label>Scheduled Training Date</label><input id="editScheduleDate" type="date" value="${schedule.date}"></div>
                        <div class="form-group"><label>Time</label><div style="display:flex; gap:10px;"><input id="editScheduleStart" type="time" value="${schedule.startTime}"><input id="editScheduleEnd" type="time" value="${schedule.endTime}"></div></div>
                        <div class="form-group"><label>Trainer</label><select id="editScheduleTrainer">${trainerOptions}</select></div>
                        <div class="form-group"><label>Room</label><select id="editScheduleRoom">${roomOptions}</select></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary">Save Changes</button>
                </div>
            </div>`;
            openModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                schedule.date = document.getElementById('editScheduleDate').value;
                schedule.startTime = document.getElementById('editScheduleStart').value;
                schedule.endTime = document.getElementById('editScheduleEnd').value;
                schedule.trainer = document.getElementById('editScheduleTrainer').value;
                schedule.room = document.getElementById('editScheduleRoom').value;

                if (enq.id) {
                    const originalEnquiry = appData.enquiries.find(e => e.id === enq.id);
                    if (originalEnquiry) {
                        originalEnquiry.contactName = document.getElementById('editContactName').value;
                        originalEnquiry.contactPhone = document.getElementById('editContactPhone').value;
                        originalEnquiry.contactEmail = document.getElementById('editContactEmail').value;
                    }
                }
                
                saveData("Details updated successfully.");
                closeModal(modal);
                renderTimeSlots(slotsContainer, date, enquiryId);
            };
        }
        
        // --- NEW ENQUIRY & NOMINATION MODALS ---
        function openViewEnquiryModal(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq) {
                showNotification("Enquiry not found.", "error");
                return;
            }

            const modal = document.getElementById('viewEnquiryModal');
            
            const startDateFormatted = enq.startDate ? new Date(enq.startDate).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';

            modal.innerHTML = `
                <style>
                    .view-data-field { padding: 8px 2px; font-size: 14px; border-bottom: 1px solid #f0f0f0; min-height: 21px; word-break: break-all; }
                </style>
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">
                        View Enquiry Details: ${enq.id} 
                        <small style="font-weight: normal; font-size: 12px; margin-left: 15px;">(Created: ${new Date(enq.date).toLocaleDateString('en-GB')})</small>
                    </div>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group"><label>Client</label><div class="view-data-field">${enq.client}</div></div>
                            <div class="form-group"><label>Contact Name</label><div class="view-data-field">${enq.contactName}</div></div>
                            
                            <div class="form-group"><label>Course</label><div class="view-data-field">${enq.course}</div></div>
                            <div class="form-group"><label>Contact Phone</label><div class="view-data-field">${enq.contactPhone || 'N/A'}</div></div>
                            
                             <div class="form-group">
                                <div style="display: flex; gap: 20px;">
                                    <div style="flex: 1;"><label>Requested Quantity</label><div class="view-data-field">${enq.requested}</div></div>
                                    <div style="flex: 1;"><label>Nominated Quantity</label><div class="view-data-field">${enq.nominated}</div></div>
                                </div>
                            </div>
                            <div class="form-group"><label>Contact Email</label><div class="view-data-field">${enq.contactEmail || 'N/A'}</div></div>
                            
                            <div class="form-group"><label>Cost per Person</label><div class="view-data-field">${enq.cost.toFixed(2)}</div></div>
                            <div class="form-group"><label>Training Date</label><div class="view-data-field">${startDateFormatted}</div></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Close</button>
                    </div>
                </div>`;
            
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
        }

        function openEditEnquiryModal(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq) {
                showNotification("Enquiry not found.", "error");
                return;
            }

            const originalEnq = JSON.parse(JSON.stringify(enq)); // Deep copy for comparison

            const modal = document.getElementById('editEnquiryModal');
            const courseInfo = appData.courses.find(c => c.name === enq.course);
            const baselineCost = courseInfo ? courseInfo.cost : 0;
            const initialDiscount = baselineCost > 0 ? (1 - (enq.cost / baselineCost)) * 100 : 0;
            const initialTotalCost = enq.cost * enq.requested;

            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">
                        Edit Enquiry: ${enq.id}
                        <small style="font-weight: normal; font-size: 12px; margin-left: 15px;">(Created: ${new Date(enq.date).toLocaleDateString('en-GB')})</small>
                    </div>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group"><label>Client</label><input type="text" value="${enq.client}" disabled></div>
                            <div class="form-group"><label>Contact Name</label><input id="editEnqContactName" type="text" value="${enq.contactName}"></div>

                            <div class="form-group"><label>Course</label><input type="text" value="${enq.course}" disabled></div>
                            <div class="form-group"><label>Contact Phone</label><input id="editEnqContactPhone" type="text" value="${enq.contactPhone}"></div>

                            <div class="form-group">
                                <label>Requested Qty</label>
                                <input id="editEnqRequested" type="number" min="1" value="${enq.requested}">
                            </div>
                            <div class="form-group"><label>Contact Email</label><input id="editEnqContactEmail" type="email" value="${enq.contactEmail}"></div>
                            
                             <div class="form-group">
                                <label>Cost & Discount</label>
                                <div style="display:flex; align-items: center; gap: 10px;">
                                    <input id="editEnqCost" type="number" min="0" step="0.01" value="${enq.cost.toFixed(2)}" style="flex-grow: 1;" title="Cost per Person">
                                    <input id="editEnqDiscount" type="number" min="0" max="100" value="${initialDiscount.toFixed(2)}" style="width: 70px;" title="Discount %">
                                    <span style="font-weight:bold;">%</span>
                                    <span id="viewPriceHistoryBtn" class="action-icon" title="View price history"><i class="fas fa-history"></i></span>
                                </div>
                            </div>
                             <div class="form-group">
                                <label>Total Cost</label>
                                <input id="editEnqTotalCost" type="text" value="${initialTotalCost.toFixed(2)}" disabled>
                            </div>

                            <div class="form-group"><label>Training Date</label><input id="editEnqDate" type="text" placeholder="Select date"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                         <button class="btn btn-secondary">Cancel</button>
                         <button class="btn btn-primary">Save Changes</button>
                    </div>
                </div>`;
            
            openModal(modal);

            const costInput = modal.querySelector('#editEnqCost');
            const discountInput = modal.querySelector('#editEnqDiscount');
            const qtyInput = modal.querySelector('#editEnqRequested');
            const totalCostInput = modal.querySelector('#editEnqTotalCost');

            const updateCosts = (source) => {
                const qty = parseInt(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;
                let discount = parseFloat(discountInput.value) || 0;

                if (source === 'discount') {
                    cost = baselineCost * (1 - (discount / 100));
                    costInput.value = cost.toFixed(2);
                } else if (source === 'cost') {
                    if (baselineCost > 0) {
                        discount = (1 - (cost / baselineCost)) * 100;
                        discountInput.value = discount.toFixed(2);
                    } else {
                        discountInput.value = "0.00";
                    }
                }
                const total = qty * cost;
                totalCostInput.value = total.toFixed(2);
            };

            qtyInput.addEventListener('input', () => updateCosts('qty'));
            costInput.addEventListener('input', () => updateCosts('cost'));
            discountInput.addEventListener('input', () => updateCosts('discount'));

            modal.querySelector('#viewPriceHistoryBtn').onclick = (e) => {
                e.stopPropagation();
                const history = appData.historicalPrices[enq.client]?.[enq.course];
                if (!history || history.length === 0) {
                    showNotification("No previous cost history available for this course and client", "warning");
                } else {
                    openPriceHistoryModal(enq.client, enq.course, costInput);
                }
            };
            
            const datePickerEl = modal.querySelector('#editEnqDate');
            const picker = new Litepicker({
                element: datePickerEl,
                singleMode: true,
                format: 'DD/MM/YYYY',
                dropdowns: { 'up': true }
            });

            if (enq.startDate) {
                picker.setDate(new Date(enq.startDate));
            }

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                const requested = parseInt(qtyInput.value, 10);
                if (requested <= 0 || isNaN(requested)) {
                    showNotification("Requested quantity must be a positive number.", "error");
                    return;
                }
                if (requested < enq.nominated) {
                    showNotification(`Requested quantity cannot be less than the already nominated count (${enq.nominated}).`, "error");
                    return;
                }

                const dateValue = datePickerEl.value;
                const [day, month, year] = dateValue.split('/');
                const formattedDate = `${year}-${month}-${day}`;

                const newContactName = document.getElementById('editEnqContactName').value.trim();
                const newContactPhone = document.getElementById('editEnqContactPhone').value.trim();
                const newContactEmail = document.getElementById('editEnqContactEmail').value.trim();
                const newCost = parseFloat(costInput.value);
                
                let changes = [];
                if (originalEnq.contactName !== newContactName) changes.push(`Contact Name: "${originalEnq.contactName}" -> "${newContactName}"`);
                if (originalEnq.contactPhone !== newContactPhone) changes.push(`Contact Phone: "${originalEnq.contactPhone}" -> "${newContactPhone}"`);
                if (originalEnq.contactEmail !== newContactEmail) changes.push(`Contact Email: "${originalEnq.contactEmail}" -> "${newContactEmail}"`);
                if (originalEnq.requested !== requested) changes.push(`Requested Quantity: ${originalEnq.requested} -> ${requested}`);
                if (originalEnq.cost.toFixed(2) !== newCost.toFixed(2)) changes.push(`Cost: ${originalEnq.cost.toFixed(2)} -> ${newCost.toFixed(2)}.`);
                if (originalEnq.startDate !== formattedDate) changes.push(`Training Date: ${originalEnq.startDate} -> ${formattedDate}.`);

                if (changes.length > 0) {
                    logActivity(enq.id, "Enquiry Updated", changes.join('\n'));
                }

                enq.contactName = newContactName;
                enq.contactPhone = newContactPhone;
                enq.contactEmail = newContactEmail;
                enq.requested = requested;
                enq.cost = newCost;
                enq.startDate = formattedDate;
                enq.endDate = formattedDate;

                saveData(`Enquiry ${enq.id} updated successfully.`);
                closeModal(modal);
                if (appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                    renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                } else if (appState.currentPage === 'add_nomination') {
                    renderNominationPage();
                }
            };
        }

        function renderNewEnquiryPage(prefilledClientName = null) {
            const mainContent = document.getElementById('mainContent');
            const pageTitle = 'New Enquiry';

            mainContent.innerHTML = `
                <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <div id="new-enquiry-content">
                    <style>
                        .form-grid-3-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
                        #newEnquiryCourseTable th, #newEnquiryCourseTable td { padding: 8px; }
                        #newEnquiryCourseTable input[type=number] { width: 70px; padding: 4px; text-align: center; }
                        #newEnquiryCourseTable .cost-cell { text-align: right; }
                        #newEnquiryCourseTable .total-cost-cell { font-weight: bold; }
                        #newEnquiryCourseTable .date-range-input { width: 220px; text-align: center; }
                        #newEnquiryCourseTable .price-history-icon { cursor: pointer; color: var(--primary-color); }
                        #newEnquiryCourseTable .price-history-icon.disabled { color: #ccc; cursor: not-allowed; }
                        .page-footer-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
                         @media (max-width: 767px) {
                            .form-grid-3-col { grid-template-columns: 1fr; }
                        }
                    </style>
                    <div style="background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color);">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label>Client Type:</label>
                                <div style="padding-top: 5px;">
                                    <input type="radio" id="clientTypeCompany" name="clientType" value="company" checked> <label for="clientTypeCompany" style="cursor:pointer;">Company</label>
                                    <input type="radio" id="clientTypeIndividual" name="clientType" value="individual" style="margin-left: 15px;"> <label for="clientTypeIndividual" style="cursor:pointer;">Individual</label>
                                </div>
                            </div>
                            <div class="form-group" id="clientInputContainer"></div>
                            <div class="form-group"></div>
                            <div class="form-group individual-field" style="display: none;">
                                <label>Civil ID:</label>
                                <input type="text" id="newEnquiryCivilId" placeholder="Enter Civil ID">
                            </div>
                            <div class="form-group individual-field" style="display: none;">
                                <label>Language:</label>
                                <select id="newEnquiryLanguage"></select>
                            </div>
                             <div class="form-group individual-field" style="display: none;"></div>
                            <div class="form-group">
                                <label>Contact Person Name:</label>
                                <input type="text" id="newEnquiryContactName" placeholder="e.g., John Doe">
                            </div>
                            <div class="form-group">
                                <label>Contact Phone:</label>
                                <input type="text" id="newEnquiryContactPhone" placeholder="e.g., 555-1234">
                            </div>
                            <div class="form-group">
                                <label>Contact Email:</label>
                                <input type="email" id="newEnquiryContactEmail" placeholder="e.g., john.d@example.com">
                            </div>
                        </div>

                        <hr style="margin: 20px 0;">

                        <div style="display: flex; gap: 10px; margin-bottom: 5px; align-items: flex-start;">
                             <textarea id="dataPaste" rows="3" placeholder="Paste data here, one course per line (e.g., Fire Warden 15)" style="width: 100%;"></textarea>
                             <button id="processPasteBtn" class="btn btn-primary" style="white-space: nowrap;">Process</button>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 15px;">
                            <b>Instructions:</b> Paste course and quantity data, one entry per line. Example:<br>
                            Fire Warden 15<br>
                            Risk Assessment 10
                        </div>
                        
                        <div id="new-enquiry-table-wrapper">
                            <table class="data-table" id="newEnquiryCourseTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;" class="text-center"></th>
                                        <th>Course</th>
                                        <th class="text-center">Qty</th>
                                        <th>Training Date</th>
                                        <th class="text-center">Cost/Person</th>
                                        <th class="cost-cell">Total Cost</th>
                                        <th class="text-center">Price History</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="page-footer-actions">
                            <button id="saveAsDraftBtn" class="btn btn-secondary">Save as Draft</button>
                            <button id="saveAndSendQuotationBtn" class="btn btn-primary">Save & Send Quotation</button>
                            <button id="nominateIndividualBtn" class="btn btn-success" style="display: none;">Nominate</button>
                        </div>
                    </div>
                </div>
            `;
            renderBreadcrumbs([{label: 'Enquiries'}, {label: 'New Enquiry'}]);
            
            const container = mainContent.querySelector('#new-enquiry-content');
            const nameInput = container.querySelector('#newEnquiryContactName');
            const phoneInput = container.querySelector('#newEnquiryContactPhone');
            const emailInput = container.querySelector('#newEnquiryContactEmail');
            const clientInputContainer = container.querySelector('#clientInputContainer');
            const courseTbody = container.querySelector('#newEnquiryCourseTable tbody');
            
            const updateCourseTableForClient = (clientName) => {
                courseTbody.querySelectorAll('tr').forEach(row => {
                    const courseName = row.dataset.course;
                    const costInput = row.querySelector('.enq-cost-person');
                    const historyIcon = row.querySelector('.price-history-icon');
                    
                    const priceHistory = clientName ? appData.historicalPrices[clientName]?.[courseName] : null;

                    if (priceHistory && priceHistory.length > 0) {
                        historyIcon.classList.remove('disabled');
                        historyIcon.title = 'View price history for this client';
                    } else {
                        historyIcon.classList.add('disabled');
                        historyIcon.title = 'No price history available';
                    }
                    const defaultCost = appData.courses.find(c => c.name === courseName)?.cost || 0;
                    costInput.value = defaultCost.toFixed(2);
                    costInput.dispatchEvent(new Event('input'));
                });
            };
            
            const updateContactInfo = (clientName) => {
                const client = appData.clients.find(c => c.name === clientName);
                const enquiry = appData.enquiries.find(e => e.client === clientName);

                // --- FIX 1: Populate Individual's data ---
                const civilIdInput = container.querySelector('#newEnquiryCivilId');
                const languageInput = container.querySelector('#newEnquiryLanguage');

                if (client && client.type === 'individual') {
                    const student = appData.students.find(s => s.name === clientName);
                    if (student) {
                        civilIdInput.value = student.civilId || '';
                        languageInput.value = student.language || 'English';
                        nameInput.value = student.name || '';
                        phoneInput.value = student.phone || '';
                        emailInput.value = student.email || '';
                    }
                } else if (client) { // Company Client
                    civilIdInput.value = ''; // Clear individual fields
                    nameInput.value = client.contactPerson || (enquiry ? enquiry.contactName : '');
                    phoneInput.value = client.contactPhone || (enquiry ? enquiry.contactPhone : '');
                    emailInput.value = client.contactEmail || (enquiry ? enquiry.contactEmail : '');
                } else if (enquiry) { // Fallback to last enquiry
                    nameInput.value = enquiry.contactName;
                    phoneInput.value = enquiry.contactPhone;
                    emailInput.value = enquiry.contactEmail;
                } else { // No data found, clear fields
                    civilIdInput.value = '';
                    nameInput.value = '';
                    phoneInput.value = '';
                    emailInput.value = '';
                }
                updateCourseTableForClient(clientName);
            };

            const renderClientInput = (type) => {
                const filteredClients = appData.clients.filter(c => c.type === type);
                const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);

                // Add some styles for the custom dropdown
                const customDropdownStyle = `
                    .custom-dropdown { position: relative; }
                    .custom-dropdown-list {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background-color: white;
                        border: 1px solid var(--border-color);
                        border-top: none;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        display: none;
                        box-shadow: 0 4px 8px var(--shadow-color);
                    }
                    .custom-dropdown-list div {
                        padding: 8px 12px;
                        cursor: pointer;
                    }
                    .custom-dropdown-list div:hover {
                        background-color: var(--secondary-color);
                    }
                `;
                if (!document.getElementById('customDropdownStyle')) {
                    const styleEl = document.createElement('style');
                    styleEl.id = 'customDropdownStyle';
                    styleEl.innerHTML = customDropdownStyle;
                    document.head.appendChild(styleEl);
                }

                clientInputContainer.innerHTML = `
                    <label>Select or Add ${typeLabel}: </label>
                    <div class="custom-dropdown">
                        <input type="text" id="clientInput" placeholder="Type or select a name..." autocomplete="off">
                        <div id="clientDropdownList" class="custom-dropdown-list"></div>
                    </div>
                `;

                const clientInput = document.getElementById('clientInput');
                const dropdownList = document.getElementById('clientDropdownList');

                const populateDropdown = (filter = '') => {
                    const lowerFilter = filter.toLowerCase();
                    const clientsToShow = filteredClients.filter(c => c.name.toLowerCase().includes(lowerFilter));
                    dropdownList.innerHTML = clientsToShow.length > 0
                        ? clientsToShow.map(c => `<div data-value="${c.name}">${c.name}</div>`).join('')
                        : `<div style="color: #888; cursor: default;">No matches found. Type to add.</div>`;
                };

                clientInput.addEventListener('focus', () => {
                    populateDropdown(''); // Show all options on focus
                    dropdownList.style.display = 'block';
                });

                clientInput.addEventListener('input', () => {
                    populateDropdown(clientInput.value);
                    updateContactInfo(clientInput.value);
                });

                dropdownList.addEventListener('mousedown', (e) => { // mousedown to fire before input loses focus
                    if (e.target.dataset.value) {
                        clientInput.value = e.target.dataset.value;
                        dropdownList.style.display = 'none';
                        updateContactInfo(clientInput.value);
                    }
                });

                // Global click listener to hide dropdown when clicking outside
                const outsideClickListener = (e) => {
                    if (!clientInputContainer.contains(e.target)) {
                        dropdownList.style.display = 'none';
                        document.removeEventListener('click', outsideClickListener);
                    }
                };
                
                clientInput.addEventListener('focus', () => {
                    // Add listener only when dropdown is open
                    document.addEventListener('click', outsideClickListener);
                });
            };
            
            const populateCourseTable = () => {
                courseTbody.innerHTML = '';
                appData.courses.sort((a,b) => a.name.localeCompare(b.name)).forEach(course => {
                    const row = courseTbody.insertRow();
                    row.dataset.course = course.name;
                    row.innerHTML = `
                        <td class="text-center"><input type="checkbox" class="enq-select"></td>
                        <td>${course.name}</td>
                        <td class="text-center"><input type="number" class="enq-requested" value="0" min="0" disabled></td>
                        <td><input type="text" class="enq-date-range date-range-input" placeholder="Select date" disabled></td>
                        <td class="text-center"><input type="number" class="enq-cost-person" value="${course.cost.toFixed(2)}" min="0" step="0.01" disabled></td>
                        <td class="cost-cell total-cost-cell">-</td>
                        <td class="text-center"><i class="fas fa-history price-history-icon disabled"></i></td>
                    `;

                    const checkbox = row.querySelector('.enq-select');
                    const qtyInput = row.querySelector('.enq-requested');
                    const dateInput = row.querySelector('.enq-date-range');
                    const costInput = row.querySelector('.enq-cost-person');
                    const totalCell = row.querySelector('.total-cost-cell');
                    const historyIcon = row.querySelector('.price-history-icon');

                    const toggleRowInputs = (enabled) => {
                        [qtyInput, dateInput, costInput].forEach(input => input.disabled = !enabled);
                    };
                    
                    const calculateTotal = () => {
                        const qty = parseInt(qtyInput.value) || 0;
                        const cost = parseFloat(costInput.value) || 0;
                        const total = qty * cost;
                        totalCell.textContent = total > 0 ? total.toFixed(2) : '-';
                    };

                    checkbox.addEventListener('change', () => {
                        toggleRowInputs(checkbox.checked);
                        if(checkbox.checked && qtyInput.value === '0') {
                            qtyInput.value = '1';
                        } else if (!checkbox.checked) {
                            qtyInput.value = '0';
                        }
                        calculateTotal();
                    });

                    [qtyInput, costInput].forEach(input => input.addEventListener('input', calculateTotal));

                    new Litepicker({ 
                        element: dateInput, 
                        singleMode: true, 
                        format: 'DD/MM/YYYY',
                        dropdowns: { 'up': true }
                    });
                    
                    historyIcon.onclick = () => {
                        if (historyIcon.classList.contains('disabled')) return;
                        const clientName = document.getElementById('clientInput')?.value;
                        if (clientName) {
                            openPriceHistoryModal(clientName, course.name, costInput);
                        } else {
                            showNotification("Please select a client first to see price history.", "warning");
                        }
                    };
                });
            };

            const langSelect = container.querySelector('#newEnquiryLanguage');
            langSelect.innerHTML = languages.map(lang => `<option value="${lang}">${lang}</option>`).join('');

            container.querySelectorAll('input[name="clientType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isIndividual = e.target.value === 'individual';
                    container.querySelectorAll('.individual-field').forEach(field => {
                        field.style.display = isIndividual ? 'block' : 'none';
                    });
                    container.querySelector('#saveAndSendQuotationBtn').style.display = isIndividual ? 'none' : 'inline-block';
                    container.querySelector('#nominateIndividualBtn').style.display = isIndividual ? 'inline-block' : 'none';
                    renderClientInput(e.target.value);
                });
            });

            container.querySelector('#processPasteBtn').onclick = () => processPastedCourseData(container.querySelector('#dataPaste'), courseTbody);
            
            // This is a helper for both Save and Nominate buttons
            const collectAndValidateEnquiryData = () => {
                const checkedRows = Array.from(courseTbody.querySelectorAll('tr')).filter(row => row.querySelector('.enq-select').checked);
                if (checkedRows.length === 0) {
                    showNotification("No courses selected.", "error");
                    return null;
                }
                const clientName = document.getElementById('clientInput')?.value.trim();
                if (!clientName) {
                    showNotification("Please select or enter a client name.", "error");
                    return null;
                }
                const contactName = nameInput.value.trim();
                if (!contactName) {
                    showNotification("Contact Name is required.", "error");
                    return null;
                }
                
                let validationPassed = true;
                const enquiriesData = [];
                for (const row of checkedRows) {
                    const courseName = row.dataset.course;
                    const qty = parseInt(row.querySelector('.enq-requested').value, 10);
                    const cost = parseFloat(row.querySelector('.enq-cost-person').value);
                    const dateValue = row.querySelector('.enq-date-range').value;
                    if (qty <= 0) { showNotification(`Validation Error for '${courseName}': Quantity must be > 0.`, 'error'); validationPassed = false; break; }
                    if (cost <= 0) { showNotification(`Validation Error for '${courseName}': Cost must be > 0.`, 'error'); validationPassed = false; break; }
                    if (!dateValue) { showNotification(`Validation Error for '${courseName}': Please select a date.`, 'error'); validationPassed = false; break; }
                    
                    const [day, month, year] = dateValue.split('/');
                    const formattedDate = `${year}-${month}-${day}`;
                    
                    const enqData = {
                        course: courseName, client: clientName, cost,
                        contactName: contactName, contactPhone: phoneInput.value.trim(), contactEmail: emailInput.value.trim(),
                        date: new Date().toISOString().slice(0, 10),
                        startDate: formattedDate, endDate: formattedDate,
                        requested: qty, nominated: 0, nominees: []
                    };

                    const clientType = container.querySelector('input[name="clientType"]:checked').value;
                    if (clientType === 'individual') {
                        enqData.civilId = container.querySelector('#newEnquiryCivilId').value.trim();
                        enqData.language = container.querySelector('#newEnquiryLanguage').value;
                    }
                    enquiriesData.push(enqData);
                }

                if (!validationPassed) return null;
                return enquiriesData;
            }

            const saveEnquiries = (enquiriesData, statusToSet) => {
                if (!enquiriesData) return null;

                const clientName = enquiriesData[0].client;
                const contactName = enquiriesData[0].contactName;
                const clientType = container.querySelector('input[name="clientType"]:checked').value;

                if (!appData.clients.some(c => c.name === clientName)) {
                    appData.clients.push({
                        name: clientName,
                        type: clientType,
                        contactPerson: contactName,
                        contactPhone: phoneInput.value.trim(),
                        contactEmail: emailInput.value.trim()
                    });
                }
                
                const newEnquiries = [];
                enquiriesData.forEach(enqData => {
                    enquiryCounter++;
                    const newEnquiryId = `ENQ-${enquiryCounter}`;
                    const enq = {
                        ...enqData,
                        id: newEnquiryId,
                        status: statusToSet,
                    };

                    appData.enquiries.unshift(enq);
                    newEnquiries.push(enq);
                    logActivity(newEnquiryId, "Enquiry Created");

                    if (!appData.historicalPrices[clientName]) appData.historicalPrices[clientName] = {};
                    if (!appData.historicalPrices[clientName][enq.course]) appData.historicalPrices[clientName][enq.course] = [];
                    const todayStr = new Date().toISOString().slice(0,10);
                    if (!appData.historicalPrices[clientName][enq.course].some(p => p.date === todayStr && p.price === enq.cost)) {
                         appData.historicalPrices[clientName][enq.course].push({ date: todayStr, price: enq.cost });
                    }
                });
                return newEnquiries;
            };

            container.querySelector('#saveAsDraftBtn').onclick = () => {
                const enquiriesData = collectAndValidateEnquiryData();
                const newEnquiries = saveEnquiries(enquiriesData, 'Draft');
                if (newEnquiries) {
                    saveData(`${newEnquiries.length} new ${newEnquiries.length > 1 ? 'enquiries have' : 'enquiry has'} been saved as draft.`);
                    renderPage('pending_enquiries');
                }
            };
            
            container.querySelector('#saveAndSendQuotationBtn').onclick = () => {
                const enquiriesData = collectAndValidateEnquiryData();
                const newEnquiries = saveEnquiries(enquiriesData, 'Draft');
                if (newEnquiries) {
                    saveData(`${newEnquiries.length} new ${newEnquiries.length > 1 ? 'enquiries have' : 'enquiry has'} been saved.`);
                    openQuotationModal(newEnquiries.map(e => e.id));
                }
            };

            // --- MODIFICATION: This now triggers the new batch-based workflow ---
            container.querySelector('#nominateIndividualBtn').onclick = () => {
                const enquiriesData = collectAndValidateEnquiryData();
                if (!enquiriesData) return; // Validation failed
                if (enquiriesData.length > 1) {
                    return showNotification("Please select only one course for direct nomination.", "error");
                }
                
                const enquiry = enquiriesData[0];
                
                // This is a direct nomination, so we move to 'Pending Nomination' state
                const newEnquiries = saveEnquiries([enquiry], 'Pending Nomination');
                if (newEnquiries && newEnquiries.length > 0) {
                     saveData("New individual enquiry created and ready for nomination.");
                     // Now trigger the same logic as confirming an agreement
                     const potentialBatchesToJoin = appData.batches.filter(batch => 
                        batch.courseName === enquiry.course &&
                        batch.pending > 0
                    );

                    const proceedToNomination = (batchToJoin = null) => {
                        if (batchToJoin) {
                            openBatchNominationModal(batchToJoin, { isJoining: true, joiningClient: enquiry.client, relatedEnquiries: newEnquiries });
                        } else {
                            const tempBatch = {
                                batchId: `TEMP-${Date.now()}`, courseName: enquiry.course, date: enquiry.startDate,
                                session: 'Morning', classCapacity: appData.classCapacity[enquiry.course] || enquiry.requested,
                                nominated: 0, pending: appData.classCapacity[enquiry.course] || enquiry.requested,
                                nominees: []
                            };
                            openBatchNominationModal(tempBatch, { isNew: true, client: enquiry.client, relatedEnquiries: newEnquiries });
                        }
                    };

                    if (potentialBatchesToJoin.length > 0) {
                        openJoinBatchModal(potentialBatchesToJoin, proceedToNomination);
                    } else {
                        proceedToNomination(null);
                    }
                }
            };
            
            renderClientInput('company');
            populateCourseTable();

            if (prefilledClientName) {
                const clientInput = container.querySelector('#clientInput');
                const clientTypeRadios = container.querySelectorAll('input[name="clientType"]');
                const client = appData.clients.find(c => c.name === prefilledClientName);
                
                if (client) {
                    clientTypeRadios.forEach(radio => {
                        radio.checked = (radio.value === client.type);
                        radio.disabled = true;
                    });
                }
                
                clientInput.value = prefilledClientName;
                clientInput.disabled = true;
                clientInput.dispatchEvent(new Event('input')); // Trigger update
            }
        }
        
        function openQuotationModal(enquiryIds) {
            const enquiries = enquiryIds.map(id => appData.enquiries.find(e => e.id === id)).filter(Boolean);
            if (enquiries.length === 0) return showNotification("Could not find enquiries for quotation.", "error");

            const clientName = enquiries[0].client;
            const contact = { name: enquiries[0].contactName, email: enquiries[0].contactEmail };
            const totalCost = enquiries.reduce((sum, enq) => sum + (enq.cost * enq.requested), 0);

            const modal = document.getElementById('scheduleModal'); // Reusing a generic modal container
            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Quotation for ${clientName}</div>
                    <div class="modal-body" id="quotation-body-for-mail">
                        <p>Dear ${contact.name},</p>
                        <p>Please find below the quotation for the requested training courses:</p>
                        <table class="data-table" style="margin-top: 15px;">
                            <thead>
                                <tr><th>Course</th><th>Qty</th><th>Date</th><th>Unit Price</th><th>Total</th></tr>
                            </thead>
                            <tbody>
                                ${enquiries.map(enq => {
                                    const start = enq.startDate ? new Date(enq.startDate).toLocaleDateString('en-GB') : 'TBD';
                                    return `<tr>
                                                <td>${enq.course}</td>
                                                <td class="text-center">${enq.requested}</td>
                                                <td>${start}</td>
                                                <td class="text-center">${enq.cost.toFixed(2)}</td>
                                                <td class="text-center">${(enq.cost * enq.requested).toFixed(2)}</td>
                                            </tr>`
                                }).join('')}
                            </tbody>
                            <tfoot>
                                <tr><td colspan="4" style="text-align:right; font-weight:bold;">Grand Total</td><td class="text-center" style="font-weight:bold;">${totalCost.toFixed(2)}</td></tr>
                            </tfoot>
                        </table>
                        <p style="margin-top:20px;">Best regards,<br>Sun Training Institute</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Cancel</button>
                        <button class="btn btn-primary">Send Mail to Client</button>
                    </div>
                </div>
            `;
            openModal(modal);

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Quotation</title></head><body>`;
                const footer = "</body></html>";
                const quotationBodyEl = document.getElementById('quotation-body-for-mail');
                
                const styledBodyHTML = quotationBodyEl.innerHTML.replace(
                    /<table class="data-table"/g, 
                    '<table style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;" border="1"'
                ).replace(/<th>/g, '<th style="background-color: #f2f2f2; padding: 8px; text-align: left;">'
                ).replace(/<td>/g, '<td style="padding: 8px;">');

                const sourceHTML = header + styledBodyHTML + footer;
                
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `Quotation - ${clientName}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);

                const subject = `Quotation from Sun Training Institute for ${clientName}`;
                const body = `Dear ${contact.name},\n\nPlease find the training quotation (downloaded from your browser) attached for your review.\n\nBest regards,\nSun Training Institute`;
                const mailtoLink = `mailto:${contact.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                showNotification("Quotation downloaded. Please attach it to the new email.", "success");
                setTimeout(() => { window.location.href = mailtoLink; }, 500);
                
                enquiries.forEach(enq => {
                    enq.status = 'Quotation Sent';
                    logActivity(enq.id, "Quotation Sent", `Quotation sent to ${contact.email}`);
                });
                saveData("Quotation sent. Enquiry status updated.");
                
                closeModal(modal);
                renderPage('pending_enquiries');
            };
        }
        
        function openEditQuotationModal(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq) {
                showNotification("Enquiry not found.", "error");
                return;
            }

            const modal = document.getElementById('editEnquiryModal'); // Reuse the same modal container
            const courseInfo = appData.courses.find(c => c.name === enq.course);
            const baselineCost = courseInfo ? courseInfo.cost : 0;
            const initialDiscount = baselineCost > 0 ? (1 - (enq.cost / baselineCost)) * 100 : 0;
            const initialTotalCost = enq.cost * enq.requested;
            
            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Edit Quotation: ${enq.id}</div>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group"><label>Client</label><input type="text" value="${enq.client}" disabled></div>
                            <div class="form-group"><label>Contact Name</label><input id="editQuotContactName" type="text" value="${enq.contactName}"></div>

                            <div class="form-group"><label>Course</label><input type="text" value="${enq.course}" disabled></div>
                            <div class="form-group"><label>Contact Phone</label><input id="editQuotContactPhone" type="text" value="${enq.contactPhone}"></div>

                            <div class="form-group"><label>Requested Qty</label><input id="editQuotRequested" type="number" min="1" value="${enq.requested}"></div>
                            <div class="form-group"><label>Contact Email</label><input id="editQuotContactEmail" type="email" value="${enq.contactEmail}"></div>
                            
                            <div class="form-group">
                                <label>Cost & Discount</label>
                                <div style="display:flex; align-items: center; gap: 10px;">
                                    <input id="editQuotCost" type="number" min="0" step="0.01" value="${enq.cost.toFixed(2)}" style="flex-grow: 1;" title="Cost per Person">
                                    <input id="editQuotDiscount" type="number" min="0" max="100" value="${initialDiscount.toFixed(2)}" style="width: 70px;" title="Discount %">
                                    <span style="font-weight:bold;">%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Total Cost</label>
                                <input id="editQuotTotalCost" type="text" value="${initialTotalCost.toFixed(2)}" disabled>
                            </div>

                            <div class="form-group"><label>Training Date</label><input id="editQuotDate" type="text" placeholder="Select date"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Cancel</button>
                        <button class="btn btn-primary">Save & Send Mail to Client</button>
                    </div>
                </div>`;
            
            openModal(modal);

            const costInput = modal.querySelector('#editQuotCost');
            const discountInput = modal.querySelector('#editQuotDiscount');
            const qtyInput = modal.querySelector('#editQuotRequested');
            const totalCostInput = modal.querySelector('#editQuotTotalCost');

            const updateCosts = (source) => {
                const qty = parseInt(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;
                let discount = parseFloat(discountInput.value) || 0;

                if (source === 'discount') {
                    cost = baselineCost * (1 - (discount / 100));
                    costInput.value = cost.toFixed(2);
                } else if (source === 'cost') {
                    if (baselineCost > 0) {
                        discount = (1 - (cost / baselineCost)) * 100;
                        discountInput.value = discount.toFixed(2);
                    } else {
                        discountInput.value = "0.00";
                    }
                }
                const total = qty * cost;
                totalCostInput.value = total.toFixed(2);
            };

            qtyInput.addEventListener('input', () => updateCosts('qty'));
            costInput.addEventListener('input', () => updateCosts('cost'));
            discountInput.addEventListener('input', () => updateCosts('discount'));

            const datePickerEl = modal.querySelector('#editQuotDate');
            const picker = new Litepicker({
                element: datePickerEl,
                singleMode: true,
                format: 'DD/MM/YYYY',
                dropdowns: { 'up': true }
            });

            if (enq.startDate) {
                picker.setDate(new Date(enq.startDate));
            }

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                const requested = parseInt(document.getElementById('editQuotRequested').value, 10);
                if (requested <= 0 || isNaN(requested)) {
                    showNotification("Requested quantity must be a positive number.", "error");
                    return;
                }

                const dateValue = datePickerEl.value;
                const [day, month, year] = dateValue.split('/');
                const formattedDate = `${year}-${month}-${day}`;
                
                enq.contactName = document.getElementById('editQuotContactName').value.trim();
                enq.contactPhone = document.getElementById('editQuotContactPhone').value.trim();
                enq.contactEmail = document.getElementById('editQuotContactEmail').value.trim();
                enq.requested = requested;
                enq.cost = parseFloat(document.getElementById('editQuotCost').value);
                enq.startDate = formattedDate;
                enq.endDate = formattedDate;

                logActivity(enq.id, "Quotation Re-edited", "Details updated before resending.");
                saveData(`Quotation ${enq.id} updated.`);
                
                closeModal(modal);
                openQuotationModal([enquiryId]); // This will handle sending the email
            };
        }

        function openPriceHistoryModal(clientName, courseName, costInputElement) {
            const modal = document.getElementById('priceHistoryModal');
            const history = appData.historicalPrices[clientName]?.[courseName]?.sort((a,b) => new Date(b.date) - new Date(a.date)) || [];

            let bodyHtml = `<p>No price history found for this client and course.</p>`;

            if (history.length > 0) {
                bodyHtml = `
                    <p>Select a price from the history below to apply it to the current enquiry.</p>
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Price</th><th>Action</th></tr></thead>
                        <tbody>
                        ${history.map(item => `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString('en-GB')}</td>
                                <td>${item.price.toFixed(2)}</td>
                                <td><button class="btn btn-secondary btn-sm use-price-btn" data-price="${item.price}">Use this Price</button></td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content modal-md">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Price History for ${courseName}<br><small style="font-weight: normal;">Client: ${clientName}</small></div>
                    <div class="modal-body">${bodyHtml}</div>
                </div>`;
            
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelectorAll('.use-price-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const newPrice = parseFloat(e.target.dataset.price);
                    showConfirmation(`Do you want to apply the cost of ${newPrice.toFixed(2)}?`, ()=> {
                        if (costInputElement) { 
                            costInputElement.value = newPrice.toFixed(2);
                            costInputElement.dispatchEvent(new Event('input'));
                        } else {
                            const nominationModal = document.getElementById('nominationDetailsModal');
                            if(nominationModal && nominationModal.classList.contains('show')) {
                                nominationModal.querySelectorAll('.nom-price:not([disabled])').forEach(input => input.value = newPrice.toFixed(2));
                            }
                        }
                        closeModal(modal);
                    });
                };
            });
        }

        function openNewNominationModal() {
            const modal = document.getElementById('newNominationModal');
            modal.innerHTML = `<div class="modal-content modal-md">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Create New Nomination</div>
                <div class="modal-body form-grid">
                    <div class="form-group"><label>Client</label><select id="newNomClient">${appData.clients.map(c=>`<option>${c.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Course</label><input id="newNomCourse" type="text" placeholder="Course Name"></div>
                    <div class="form-group"><label>Requested Count</label><input id="newNomCount" type="number" min="1" value="1"></div>
                     <div class="form-group"><label>Contact Name</label><input id="newNomContact" type="text" placeholder="Contact Person"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Create & Nominate</button></div>
            </div>`;
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                const client = document.getElementById('newNomClient').value;
                const course = document.getElementById('newNomCourse').value;
                const count = document.getElementById('newNomCount').value;
                const contact = document.getElementById('newNomContact').value;
                if(!course || !count || !contact) return showNotification("All fields are required", "error");
                
                enquiryCounter++;
                const newEnq = {
                    id: `ENQ-${enquiryCounter}`, course: course, client: client,
                    contactName: contact, contactPhone: '', contactEmail: '',
                    status: 'Nominated', date: new Date().toISOString().slice(0,10),
                    startDate: null, endDate: null, cost: appData.courses.find(c=>c.name===course)?.cost || 0,
                    requested: parseInt(count, 10), nominated: 0, nominees: []
                };
                appData.enquiries.unshift(newEnq);
                logActivity(newEnq.id, "Nomination Created Directly");
                saveData("New nomination created.");
                closeModal(modal);
                loadClassSchedulerView();
                // This function is now deprecated, the flow should use the batch modal.
                // openNominationDetailsModal(newEnq.id);
            };
        }

        // --- DEPRECATED: Replaced by openBatchNominationModal ---
        function openNominationDetailsModal(enquiryOrId, options = {}) {
            // This function is kept for any legacy calls but the main flow is redirected.
            // In a real refactor, this would be removed and all call sites updated.
            console.warn("DEPRECATED: openNominationDetailsModal called. Use openBatchNominationModal instead.");
        }

        // --- NEW/REFACTORED: This is the new central modal for all nominations ---
        function openBatchNominationModal(batch, options = {}) {
             const { isNew = false, isJoining = false, joiningClient = null, client = null, relatedEnquiries = [] } = options;

            const modal = document.getElementById('nominationDetailsModal');
            const modalTitle = isNew ? `New Batch Nomination for ${batch.courseName}` : `Edit Batch: ${batch.batchId}`;
            const clientForNewRows = isJoining ? joiningClient : client;

            modal.innerHTML = `<div class="modal-content modal-xl">
                <span class="modal-close">&times;</span>
                <div class="modal-title">${modalTitle}</div>
                <div class="modal-body">
                    <div style="display:flex; gap: 10px; align-items: flex-end;">
                        <textarea id="nomineePasteArea" rows="4" placeholder="Paste student data here (one Civil ID per line)..." style="width: 100%; font-family: monospace;"></textarea>
                        <button id="processPasteBtn" class="btn btn-primary" style="white-space: nowrap;">Process</button>
                    </div>
                    <hr style="margin: 15px 0;">
                     <div class="header-action-buttons" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; padding: 10px; background-color: #f9f9f9; border-radius: 4px; flex-wrap: nowrap; overflow-x: auto;">
                        <div><strong>Class Capacity:</strong> ${batch.classCapacity}</div>
                        <div style="padding-left:10px; border-left: 1px solid #ddd;"><strong>Nominated:</strong> <span id="nomFilledDisplay">${batch.nominated}</span></div>
                        <div><strong>Pending:</strong> <span id="nomPendingDisplay">${batch.pending}</span></div>
                    </div>
                    <div style="max-height: 40vh; overflow-y: auto;">
                        <table class="data-table">
                            <thead><tr><th>#</th><th>Client</th><th>Civil ID</th><th>Student Name</th><th>Contact #</th><th>Email</th><th>Language</th><th>Price</th><th class="text-center">Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="addNomineeRowBtn" class="btn btn-secondary" style="margin-right: auto;">+ Add Row</button>
                    <button id="cancelNominationBtn" class="btn">Cancel</button>
                    <button id="saveBatchBtn" class="btn btn-primary">Save Nominations</button>
                </div>
            </div>`;
            openModal(modal);

            const tbody = modal.querySelector('tbody');

            const updateCounts = () => {
                const capacity = batch.classCapacity || 0;
                const nominated = tbody.querySelectorAll('tr:not(.group-header)').length;
                modal.querySelector('#nomFilledDisplay').textContent = nominated;
                modal.querySelector('#nomPendingDisplay').textContent = Math.max(0, capacity - nominated);
            };

            const addRow = (nomineeData, clientName, isDisabled = false) => {
                const newRow = tbody.insertRow();
                newRow.dataset.client = clientName;
                const clientObject = appData.clients.find(c => c.name === clientName);
                const isIndividualClient = clientObject && clientObject.type === 'individual';

                const languageOptions = languages.map(lang => `<option value="${lang}" ${lang === (nomineeData.language || 'English') ? 'selected' : ''}>${lang}</option>`).join('');
                
                newRow.innerHTML = `
                    <td></td>
                    <td>${clientName}</td>
                    <td><input type="text" class="nom-civilid" value="${nomineeData.civilId || ''}" ${isDisabled || isIndividualClient ? 'disabled' : ''}></td>
                    <td><input type="text" class="nom-name" value="${nomineeData.name || ''}" ${isDisabled || isIndividualClient ? 'disabled' : ''}></td>
                    <td><input type="text" class="nom-phone" value="${nomineeData.contactNumber || ''}" ${isDisabled ? 'disabled' : ''}></td>
                    <td><input type="text" class="nom-email" value="${nomineeData.email || ''}" ${isDisabled ? 'disabled' : ''}></td>
                    <td><select class="nom-lang" ${isDisabled ? 'disabled' : ''}>${languageOptions}</select></td>
                    <td><input type="number" class="nom-price" value="${(appData.courses.find(c=>c.name === batch.courseName)?.cost || 0).toFixed(2)}" step="0.01"></td>
                    <td class="text-center"><i class="fas fa-trash-alt delete-nominee-btn action-icon" style="color: var(--danger-color); ${isDisabled ? 'display:none;' : ''}"></i></td>
                `;

                if(isDisabled) {
                    newRow.style.backgroundColor = '#f9f9f9';
                    newRow.querySelectorAll('input, select').forEach(el => el.disabled = true);
                }

                 newRow.querySelector('.nom-civilid').addEventListener('input', e => {
                    if (e.target.disabled) return;
                    const student = appData.students.find(s => s.civilId === e.target.value.trim());
                    if (student) {
                        newRow.querySelector('.nom-name').value = student.name;
                        newRow.querySelector('.nom-phone').value = student.phone;
                        newRow.querySelector('.nom-email').value = student.email;
                        newRow.querySelector('.nom-lang').value = student.language;
                    }
                });
            };

            const addClientGroupRows = (clientGroup, isDisabled) => {
                const groupHeader = tbody.insertRow();
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `<td colspan="9" style="background-color: #f0f4f8; font-weight: bold;">${clientGroup.name} (${clientGroup.type})</td>`;
                
                if (clientGroup.students && clientGroup.students.length > 0) {
                    clientGroup.students.forEach(student => addRow(student, clientGroup.name, isDisabled));
                }
            };

            batch.nominees.forEach(clientGroup => {
                if (!isJoining || clientGroup.name !== joiningClient) {
                    addClientGroupRows(clientGroup, true);
                }
            });

            if (clientForNewRows) {
                const clientType = (appData.clients.find(c => c.name === clientForNewRows)?.type || 'Company');
                const existingNomination = batch.nominees.find(n => n.name === clientForNewRows);
                
                const groupHeader = tbody.insertRow();
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `<td colspan="9" style="background-color: #e6eef7; font-weight: bold;">${clientForNewRows} (${clientType}) - Nominating Now</td>`;
                
                if (existingNomination && existingNomination.students.length > 0) {
                    existingNomination.students.forEach(student => addRow(student, clientForNewRows, false));
                } else {
                    addRow({}, clientForNewRows, false);
                }
            }

            const renumberRows = () => {
                const studentRows = tbody.querySelectorAll('tr:not(.group-header)');
                studentRows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            };
            renumberRows();
            updateCounts();

            tbody.addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-nominee-btn');
                if (deleteBtn) {
                    deleteBtn.closest('tr').remove();
                    renumberRows();
                    updateCounts();
                }
            });

            modal.querySelector('#addNomineeRowBtn').addEventListener('click', () => {
                if (clientForNewRows) {
                    addRow({}, clientForNewRows);
                    renumberRows();
                    updateCounts();
                } else {
                    showNotification("Cannot add row without a client context.", "error");
                }
            });

            modal.querySelector('#processPasteBtn').onclick = () => {
                const text = modal.querySelector('#nomineePasteArea').value.trim();
                const lines = text.split(/\r?\n/).filter(line => line.trim());
                if (!clientForNewRows) return showNotification("Cannot process paste without a client context.", "error");
                lines.forEach(line => {
                    const student = appData.students.find(s => s.civilId === line.trim()) || { civilId: line.trim() };
                    addRow(student, clientForNewRows);
                });
                modal.querySelector('#nomineePasteArea').value = '';
                renumberRows();
                updateCounts();
            };

            modal.querySelector('#saveBatchBtn').onclick = () => {
                const editableRows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.dataset.client === clientForNewRows);
                const newStudentsForClient = editableRows.map(row => {
                    const name = row.querySelector('.nom-name').value.trim();
                    const civilId = row.querySelector('.nom-civilid').value.trim();
                    if (!name || !civilId) return null;
                    return {
                        name, civilId,
                        contactNumber: row.querySelector('.nom-phone').value.trim(),
                        email: row.querySelector('.nom-email').value.trim(),
                        language: row.querySelector('.nom-lang').value
                    };
                }).filter(Boolean);

                const clientType = appData.clients.find(c => c.name === clientForNewRows)?.type === 'individual' ? 'Individual' : 'Company';

                let targetBatch;
                if (isNew) {
                    const initial = batch.courseName.charAt(0).toUpperCase();
                    if (!appData.batchCounters[initial]) appData.batchCounters[initial] = 0;
                    appData.batchCounters[initial]++;
                    
                    targetBatch = {
                        ...batch,
                        batchId: `Batch-${initial}-${String(appData.batchCounters[initial]).padStart(3, '0')}`,
                        nominees: []
                    };
                    if (newStudentsForClient.length > 0) {
                        targetBatch.nominees.push({ type: clientType, name: clientForNewRows, students: newStudentsForClient });
                    }
                    appData.batches.push(targetBatch);
                } else { // isJoining or editing
                    targetBatch = appData.batches.find(b => b.batchId === batch.batchId);
                    targetBatch.nominees = targetBatch.nominees.filter(n => n.name !== clientForNewRows);
                    if (newStudentsForClient.length > 0) {
                        targetBatch.nominees.push({ type: clientType, name: clientForNewRows, students: newStudentsForClient });
                    }
                }
                
                targetBatch.nominated = targetBatch.nominees.reduce((sum, group) => sum + group.students.length, 0);
                targetBatch.pending = Math.max(0, targetBatch.classCapacity - targetBatch.nominated);

                if(relatedEnquiries.length > 0) {
                     relatedEnquiries.forEach(enq => {
                        enq.batchNumber = targetBatch.batchId;
                        enq.nominated = newStudentsForClient.length;
                        enq.nominees = newStudentsForClient.map(s=>({name: s.name, civilId: s.civilId, phone: s.contactNumber, email: s.email, language: s.language}));
                     });
                }
                
                saveData(`Nominations saved to batch ${targetBatch.batchId}.`);
                closeModal(modal);
                renderPage('pending_nominations');
            };

            const handleClose = () => { closeModal(modal); };
            modal.querySelector('.modal-close').onclick = handleClose;
            modal.querySelector('#cancelNominationBtn').onclick = handleClose;
        }

        function openPendingPeersPanel(courseName, currentEnquiryId) {
            const panel = document.getElementById('pendingPeersPanel');

            // Filter for other clients with pending nominations for the same course
            const pendingPeers = appData.enquiries.filter(e => e.course === courseName &&
                (e.status === 'Pending Nomination' || e.status === 'Nominated') &&
                e.id !== currentEnquiryId
            );

            let panelBodyHTML = '';
            if (pendingPeers.length > 0) {
                panelBodyHTML = pendingPeers.map(peer => {
                    const pendingCount = peer.requested - peer.nominated;
                    // *** CHANGE: Updated the layout for the drawer/panel ***
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">${peer.client}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px 10px; font-size: 0.9em;">
                                <span>Requested: ${peer.requested}</span>
                                <span>Nominated: ${peer.nominated}</span>
                                <span style="font-weight: bold; color: var(--danger-color);">Pending: ${pendingCount}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                panelBodyHTML = '<p style="padding: 20px; text-align: center; color: #888;">No other pending nominations found for this course.</p>';
            }

            panel.innerHTML = `
                <div class="side-panel-header">
                    <div class="title">Pending Nominations for ${courseName}</div>
                    <span class="close-btn" onclick="toggleSidePanel('pendingPeersPanel')">&times;</span>
                </div>
                <div class="side-panel-body" style="padding:0;">
                    ${panelBodyHTML}
                </div>
            `;

            toggleSidePanel('pendingPeersPanel');
        }

        function openWorkflowScheduleModal(tableRow) {
            const courseName = tableRow.dataset.course;
            const modal = document.getElementById('workflowScheduleModal');
            
            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Set Date & Time for ${courseName}</div>
                    <div class="modal-body" style="display: flex; gap: 20px;">
                        <div class="calendar-container" style="width: 50%;"></div>
                        <div style="width: 50%; border-left: 1px solid var(--border-color); padding-left: 20px;">
                            <div id="slots-date-header"></div>
                            <div class="time-slots-container" style="max-height: 350px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div id="reservation-summary" style="margin-right: auto; font-size: 13px;"></div>
                        <button class="btn btn-secondary">Cancel</button>
                        <button id="setDateTimeBtn" class="btn btn-primary">Set Date & Time</button>
                    </div>
                </div>
            `;
            openModal(modal);

            const calContainer = modal.querySelector('.calendar-container');
            const slotsContainer = modal.querySelector('.time-slots-container');
            
            renderCalendar(calContainer, slotsContainer, new Date(), courseName);
            renderTimeSlots(slotsContainer, new Date(), null); // null enquiryId for workflow

            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('#setDateTimeBtn').onclick = () => {
                const selectedDay = calContainer.querySelector('.cal-day.selected');
                if (!selectedDay) {
                    showNotification('Please select a date from the calendar.', 'error');
                    return;
                }

                const checkboxes = slotsContainer.querySelectorAll('.slot-checkbox:checked');
                if (checkboxes.length === 0) {
                    showNotification("Please select at least one time slot.", "error");
                    return;
                }
                
                const hours = Array.from(checkboxes).map(cb => parseInt(cb.dataset.hour)).sort((a,b) => a-b);
                const minHour = hours[0];
                const maxHour = hours[hours.length - 1];

                const year = parseInt(calContainer.querySelector('#year-select').value);
                const month = parseInt(calContainer.querySelector('#month-select').value);
                const day = parseInt(selectedDay.dataset.day);
                
                const date = new Date(year, month, day);
                const dateString = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
                const timingString = `${String(minHour).padStart(2, '0')}:00 - ${String(maxHour + 1).padStart(2, '0')}:00`;

                const dateInput = tableRow.querySelector('.enq-date-range');
                // Timing input is removed
                
                dateInput.value = dateString;
                // No timing input to update
                
                closeModal(modal);
            };
        }

        // --- RESULTS PAGE AND MODAL ---
        function renderResultsPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="page-header">
                     <div id="breadcrumb-container"></div>
                </div>
                <div id="resultsData"></div>
            `;
            renderBreadcrumbs([{label: 'Results'}]);
            loadResultsView();
        }

        function loadResultsView() {
            const container = document.getElementById('resultsData');
            const viewId = 'results_view';
            let completedEnquiries = appData.enquiries
                .filter(e => e.status === 'Completed');

            if (appState.searchFilter) {
                completedEnquiries = applyGlobalSearch(completedEnquiries, appState.searchFilter);
            }

            const sortState = tableSortState[viewId];
            if(sortState) {
                completedEnquiries = applyTableSorting(completedEnquiries, sortState.key, sortState.dir, sortState.type);
            } else {
                 completedEnquiries.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            }
            
            let tableRows = `<tr><td colspan="9" class="text-center" style="padding: 20px;">No completed classes found.</td></tr>`;

            if (completedEnquiries.length > 0) {
                tableRows = completedEnquiries.map((enq, index) => {
                    const trainingDate = new Date(enq.startDate).toLocaleDateString('en-GB');
                    return `
                        <tr data-id="${enq.id}">
                            <td>${index + 1}</td>
                            <td>${enq.id}</td>
                            <td>${enq.batchNumber || '-'}</td>
                            <td>${enq.client}</td>
                            <td>${enq.course}</td>
                            <td class="text-center">${trainingDate}</td>
                            <td class="text-center">${enq.nominated}</td>
                            <td class="text-center">${getStatusBadgeHTML(enq.status)}</td>
                            <td class="text-center">
                                <div class="action-icons-container" style="/*justifycontent: center;*/">
                                    <button class="btn btn-secondary btn-sm" data-action="view-results" title="Edit Result" style="display: inline-flex; align-items: center; gap: 5px;"><i class="fas fa-edit"></i> Edit</button>
                                    <span class="action-icon" data-action="view-log" title="View History Log"><i class="fas fa-sticky-note"></i></span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            container.innerHTML = `
                <table class="data-table" data-view-id="${viewId}">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th class="sortable" data-sort-key="id">Enquiry ID</th>
                            <th>Batch No.</th>
                            <th class="sortable" data-sort-key="client">Client</th>
                            <th class="sortable" data-sort-key="course">Course</th>
                            <th class="sortable text-center" data-sort-key="startDate" data-sort-type="date">Training Date</th>
                            <th class="text-center">Students</th>
                            <th class="sortable text-center" data-sort-key="status">Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;

             if (sortState) {
                const th = container.querySelector(`th[data-sort-key="${sortState.key}"]`);
                if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }
        
        function openResultsModal(enquiryId) {
            const enq = appData.enquiries.find(e => e.id === enquiryId);
            if (!enq) return;
            const schedule = appData.schedules.find(s => s.enquiryId === enquiryId);

            const modal = document.getElementById('resultsModal');

            let nomineesTable = `<p class="text-center" style="color: #888;">No nominees for this class.</p>`;
            if (enq.nominees && enq.nominees.length > 0) {
                nomineesTable = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Civil ID</th>
                                <th>Student Name</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${enq.nominees.map((nom, index) => `
                                <tr data-civil-id="${nom.civilId}">
                                    <td>${index + 1}</td>
                                    <td>${nom.civilId}</td>
                                    <td>${nom.name}</td>
                                    <td>
                                        <select class="form-control result-select" style="padding: 4px;">
                                            <option value="">Select...</option>
                                            <option value="Pass" ${nom.result === 'Pass' ? 'selected' : ''}>Pass</option>
                                            <option value="Fail" ${nom.result === 'Fail' ? 'selected' : ''}>Fail</option>
                                        </select>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <span class="modal-close">&times;</span>
                    <div class="modal-title">Results for ${enq.course} - ${enq.client}</div>
                    <div class="modal-body">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group"><label>Client</label><input value="${enq.client}" disabled></div>
                            <div class="form-group"><label>Course</label><input value="${enq.course}" disabled></div>
                            <div class="form-group"><label>Class Date</label><input value="${new Date(enq.startDate).toLocaleDateString('en-GB')}" disabled></div>
                            <div class="form-group"><label>Trainer</label><input value="${schedule?.trainer || 'N/A'}" disabled></div>
                            <div class="form-group"><label>Class Room</label><input value="${schedule?.room || 'N/A'}" disabled></div>
                            <div class="form-group"><label>Students</label><input value="${enq.nominated}" disabled></div>
                        </div>
                        <hr style="margin: 20px 0;">
                        <h4 style="margin-top:0; margin-bottom: 10px;">Student Results</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${nomineesTable}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary">Close</button>
                        <button class="btn btn-primary">Save Results</button>
                    </div>
                </div>
            `;
            openModal(modal);
            modal.querySelector('.modal-close').onclick = () => closeModal(modal);
            modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
            modal.querySelector('.btn-primary').onclick = () => {
                let changesMade = false;
                modal.querySelectorAll('tbody tr').forEach(row => {
                    const civilId = row.dataset.civilId;
                    const result = row.querySelector('.result-select').value;
                    const nominee = enq.nominees.find(n => n.civilId === civilId);
                    if(nominee && nominee.result !== result) {
                        nominee.result = result;
                        changesMade = true;
                    }
                });
                
                if (changesMade) {
                    saveData("Student results have been saved.");
                } else {
                    showNotification("No changes to save.", "info");
                }
                closeModal(modal);
            };
        }


        // --- UTILITY: MODAL HELPERS ---
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
            setTimeout(() => modalElement.classList.add('show'), 10);
            modalElement.onclick = (e) => { if (e.target === modalElement) closeModal(modalElement); };
        }
        function closeModal(modalElement) {
            modalElement.classList.remove('show');
            modalElement.addEventListener('transitionend', () => {
                modalElement.style.display = 'none';
            }, { once: true });
        }

        // --- UTILITIES ---
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container'); 
            const notification = document.createElement('div');
            notification.className = 'notification'; 
            notification.textContent = message; 
            if(type === 'error') notification.style.backgroundColor = 'var(--danger-color)';
            if(type === 'warning') notification.style.backgroundColor = 'var(--warning-color)';
            container.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove()); }, 4000);
        }
        
        function processPastedCourseData(pasteArea, tbody) {
            const lines = pasteArea.value.trim().split('\n');
            let matchedRows = [];

            lines.forEach(line => {
                const cleanedLine = line.trim();
                if (!cleanedLine) return;
                
                let courseName, requestedCount;
                const regex = /(.+?)[-\s(]*(\d+)\)?\s*$/;
                const match = cleanedLine.match(regex);

                if (match && match[1] && !isNaN(parseInt(match[2]))) {
                    courseName = match[1].trim();
                    requestedCount = parseInt(match[2].trim(), 10);
                } else {
                    courseName = cleanedLine;
                    requestedCount = 1;
                }
                
                const row = Array.from(tbody.querySelectorAll('tr')).find(r => r.dataset.course.toLowerCase() === courseName.toLowerCase());
                
                if(row) {
                    matchedRows.push(row);
                    const checkbox = row.querySelector('.enq-select');
                    const qtyInput = row.querySelector('.enq-requested');
                    
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                    
                    qtyInput.value = requestedCount;
                    qtyInput.dispatchEvent(new Event('input'));
                } else {
                    showNotification(`Pasted course not found: "${courseName}"`, 'warning');
                }
            });

            matchedRows.reverse().forEach(row => {
                tbody.prepend(row);
            });

            pasteArea.value = '';
        }

        // --- TRAINER NEW WORKFLOW ---
        function renderTrainerStartPage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                 <style>
                    .trainer-options { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 40px; }
                    .trainer-option-card {
                        padding: 30px 40px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s ease;
                        background-color: #fff;
                        box-shadow: 0 1px 3px var(--shadow-color);
                        width: 220px;
                    }
                    .trainer-option-card:hover {transform: translateY(-5px);
                        box-shadow: 0 4px 10px var(--shadow-color);
border-color: var(--primary-color);
}
.trainer-option-card i { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-color); }
.trainer-option-card h3 { margin: 0; font-size: 1.1rem; }
</style>
<div class="page-header">
<div id="breadcrumb-container"></div>
</div>
<div id="trainer-content">
<div class="trainer-options">
<div class="trainer-option-card" data-option="new-trainer">
<i class="fas fa-user-plus"></i>
<h3>+ New Trainer</h3>
</div>
<div class="trainer-option-card" data-option="existing-trainers">
<i class="fas fa-users"></i>
<h3>Existing Trainers</h3>
</div>
<div class="trainer-option-card" data-option="leave-management">
<i class="fas fa-calendar-times"></i>
<h3>Leave Management</h3>
</div>
</div>
</div>
`;
renderBreadcrumbs([{label: 'Trainer'}]);

mainContent.querySelector('.trainer-options').addEventListener('click', e => {
            const card = e.target.closest('.trainer-option-card');
            if (!card) return;
            const option = card.dataset.option;
            if (option === 'new-trainer') {
                renderNewTrainerForm();
            } else if (option === 'existing-trainers') {
                renderExistingTrainersList();
            } else if (option === 'leave-management') {
                renderLeaveManagementPage();
            }
        });
    }
    
    function renderNewTrainerForm() {
        const container = document.getElementById('trainer-content');
        container.innerHTML = `
            <div style="max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color);">
                <div class="form-grid">
                    <div class="form-group"><label>Full Name*</label><input type="text" id ="trainerName"></div>
                    <div class="form-group"><label>Email*</label><input type="email" id="trainerEmail"></div>
                    <div class="form-group"><label>Phone*</label><input type="tel" id="trainerPhone"></div>
                    <div class="form-group"><label>Join Date</label><input type="date" id="trainerJoinDate" value="${toYYYYMMDD(new Date())}"></div>
                    <div class="form-group"><label>Specialization (comma-separated)</label><input type="text" id="trainerSpecialization"></div>
                    <div class="form-group"><label>Status</label><select id="trainerStatus"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                </div>
                <div class="form-group" style="margin-top:20px;"><label>Notes/Bio</label><textarea id="trainerNotes" rows="4"></textarea></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button id="saveNewTrainerBtn" class="btn btn-primary">Save Trainer</button>
                </div>
            </div>
        `;
        renderBreadcrumbs([{label: 'Trainer', onClick: renderTrainerStartPage}, {label: 'New Trainer'}]);
        
        document.getElementById('saveNewTrainerBtn').addEventListener('click', () => {
            const name = document.getElementById('trainerName').value.trim();
            const email = document.getElementById('trainerEmail').value.trim();
            const phone = document.getElementById('trainerPhone').value.trim();
            if (!name || !email || !phone) {
                return showNotification("Please fill in all required fields (*).", "error");
            }
            const newTrainer = {
                id: `TRN-${Date.now()}`,
                name, email, phone,
                joinDate: document.getElementById('trainerJoinDate').value,
                specialization: document.getElementById('trainerSpecialization').value,
                status: document.getElementById('trainerStatus').value,
                notes: document.getElementById('trainerNotes').value
            };
            appData.trainers.push(newTrainer);
            saveData(`Trainer "${name}" has been added.`);
            renderExistingTrainersList();
        });
    }

    function renderExistingTrainersList() {
        const container = document.getElementById('trainer-content');
        const viewId = 'trainers_view';
        let trainers = [...appData.trainers];
        
        if (appState.searchFilter) {
            trainers = applyGlobalSearch(trainers, appState.searchFilter);
        }
        
        const sortState = tableSortState[viewId];
        if(sortState) {
            trainers = applyTableSorting(trainers, sortState.key, sortState.dir, sortState.type);
        } else {
            trainers.sort((a,b) => a.name.localeCompare(b.name));
        }

        const tableRows = trainers.map(trainer => {
            const toggleIcon = trainer.status === 'Active' ? 'fa-toggle-on' : 'fa-toggle-off';
            const toggleTitle = `Click to change status to ${trainer.status === 'Active' ? 'Inactive' : 'Active'}`;
            return `
                <tr data-id="${trainer.id}">
                    <td>${trainer.name}</td>
                    <td>${trainer.email}</td>
                    <td>${trainer.phone}</td>
                    <td>${trainer.specialization}</td>
                    <td class="text-center">${getStatusBadgeHTML(trainer.status)}</td>
                    <td class="text-center">
                        <div class="action-icons-container" style="justify-content: center;">
                            <span class="action-icon" data-action="view-trainer" title="View Details"><i class="fas fa-eye"></i></span>
                            <span class="action-icon" data-action="toggle-status" title="${toggleTitle}"><i class="fas ${toggleIcon}"></i></span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <table class="data-table" data-view-id="${viewId}">
                <thead>
                    <tr>
                        <th class="sortable" data-sort-key="name">Name</th>
                        <th class="sortable" data-sort-key="email">Email</th>
                        <th>Phone</th>
                        <th class="sortable" data-sort-key="specialization">Specialization</th>
                        <th class="sortable text-center" data-sort-key="status">Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        `;
        renderBreadcrumbs([{label: 'Trainer', onClick: renderTrainerStartPage}, {label: 'Existing Trainers'}]);
        
        if (sortState) {
            const th = container.querySelector(`th[data-sort-key="${sortState.key}"]`);
            if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }

        container.querySelector('tbody').addEventListener('click', e => {
            const icon = e.target.closest('.action-icon');
            if (!icon) return;
            
            const trainerId = icon.closest('tr').dataset.id;
            const action = icon.dataset.action;

            if (action === 'view-trainer') {
                openTrainerDetailsModal(trainerId);
            } else if (action === 'toggle-status') {
                const trainer = appData.trainers.find(t => t.id === trainerId);
                if (trainer) {
                    const newStatus = trainer.status === 'Active' ? 'Inactive' : 'Active';
                    showConfirmation(`Are you sure you want to change ${trainer.name}'s status to ${newStatus}?`, () => {
                        trainer.status = newStatus;
                        saveData(`${trainer.name}'s status has been updated to ${newStatus}.`);
                        renderExistingTrainersList();
                    });
                }
            }
        });
    }
    
    function openTrainerDetailsModal(trainerId) {
        const trainer = appData.trainers.find(t => t.id === trainerId);
        if (!trainer) return;

        const modal = document.getElementById('trainerDetailsModal');
        modal.innerHTML = `
             <div class="modal-content modal-md">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Trainer Details: ${trainer.name}</div>
                <div class="modal-body">
                     <div class="form-grid">
                        <div class="form-group"><label>Full Name</label><input value="${trainer.name}" disabled></div>
                        <div class="form-group"><label>Email</label><input value="${trainer.email}" disabled></div>
                        <div class="form-group"><label>Phone</label><input value="${trainer.phone}" disabled></div>
                        <div class="form-group"><label>Join Date</label><input value="${trainer.joinDate}" disabled></div>
                        <div class="form-group"><label>Specialization</label><input value="${trainer.specialization}" disabled></div>
                        <div class="form-group"><label>Status</label><input value="${trainer.status}" disabled></div>
                    </div>
                    <div class="form-group" style="margin-top:20px;"><label>Notes/Bio</label><textarea rows="4" disabled>${trainer.notes || ''}</textarea></div>
                </div>
                 <div class="modal-footer"><button class="btn btn-secondary">Close</button></div>
            </div>
        `;
        openModal(modal);
        modal.querySelector('.modal-close').onclick = () => closeModal(modal);
        modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
    }

    function renderLeaveManagementPage() {
        const container = document.getElementById('trainer-content');
        const trainerOptions = appData.trainers
            .filter(t => t.status === 'Active')
            .map(t => `<option value="${t.name}">${t.name}</option>`).join('');

        container.innerHTML = `
            <div style="max-width: 1000px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color);">
                <h4 style="margin-top:0;">Apply for Leave</h4>
                <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;">
                    <div class="form-group" style="flex: 2;"><label>Select Trainer</label><select id="leaveTrainerSelect">${trainerOptions}</select></div>
                    <div class="form-group" style="flex: 3;"><label>Select Leave Dates</label><input type="text" id="leaveDateRange"></div>
                    <div class="form-group" style="flex: 3;"><label>Reason</label><input type="text" id="leaveReason"></div>
                    <button id="applyLeaveBtn" class="btn btn-primary">Apply</button>
                </div>
                
                <h4 style="margin-top: 20px;">Leave Requests</h4>
                <div id="leave-requests-table"></div>
            </div>
        `;
        renderBreadcrumbs([{label: 'Trainer', onClick: renderTrainerStartPage}, {label: 'Leave Management'}]);
        
        const picker = new Litepicker({
            element: document.getElementById('leaveDateRange'),
            singleMode: false,
            format: 'DD/MM/YYYY',
        });
        
        document.getElementById('applyLeaveBtn').addEventListener('click', () => {
            const trainerName = document.getElementById('leaveTrainerSelect').value;
            const startDateObj = picker.getStartDate();
            const endDateObj = picker.getEndDate();
            const reason = document.getElementById('leaveReason').value.trim();

            if (!trainerName || !startDateObj || !endDateObj || !reason) {
                return showNotification("Please select a trainer, a valid date range, and provide a reason.", "error");
            }
            const startDate = toYYYYMMDD(startDateObj.dateInstance);
            const endDate = toYYYYMMDD(endDateObj.dateInstance);

            const newLeave = {
                id: `LVE-${Date.now()}`,
                trainerName, startDate, endDate, reason, status: 'Pending'
            };
            appData.trainerLeaves.push(newLeave);
            saveData("Leave request has been submitted.");
            renderLeaveRequestsTable();
            picker.clearSelection();
            document.getElementById('leaveReason').value = '';
        });

        const renderLeaveRequestsTable = () => {
            const tableContainer = document.getElementById('leave-requests-table');
            let leaves = appData.trainerLeaves.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            
            if (appState.searchFilter) {
                leaves = applyGlobalSearch(leaves, appState.searchFilter);
            }

            const rows = leaves.map(leave => {
                let actionsHTML = '-';
                if (leave.status === 'Pending') {
                    actionsHTML = `
                        <button class="btn btn-sm btn-primary" data-action="approve-leave" style="margin-right: 5px;">Approve</button>
                        <button class="btn btn-sm btn-danger" data-action="reject-leave">Reject</button>
                    `;
                }
                const statusKey = leave.status === 'Pending' ? 'Leave Pending' : leave.status;

                return `
                    <tr data-id="${leave.id}">
                        <td>${leave.trainerName}</td>
                        <td>${new Date(leave.startDate).toLocaleDateString('en-GB')}</td>
                        <td>${new Date(leave.endDate).toLocaleDateString('en-GB')}</td>
                        <td>${leave.reason}${leave.rejectionReason ? `<br><small style="color:var(--danger-color)"><b>Rejected:</b> ${leave.rejectionReason}</small>` : ''}</td>
                        <td class="text-center">${getStatusBadgeHTML(statusKey)}</td>
                        <td class="text-center">${actionsHTML}</td>
                    </tr>
                `;
            }).join('');

            tableContainer.innerHTML = `
                <table class="data-table">
                    <thead><tr><th>Trainer</th><th>Start Date</th><th>End Date</th><th>Reason / Note</th><th class="text-center">Status</th><th class="text-center">Action</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

            tableContainer.querySelector('tbody').addEventListener('click', e => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const leaveId = button.closest('tr').dataset.id;
                const leave = appData.trainerLeaves.find(l => l.id === leaveId);
                if (!leave) return;

                const action = button.dataset.action;
                if (action === 'approve-leave') {
                    leave.status = 'Approved';
                    saveData(`Leave for ${leave.trainerName} has been approved.`);
                    renderLeaveRequestsTable();
                } else if (action === 'reject-leave') {
                    openRejectLeaveModal(leaveId);
                }
            });
        };
        renderLeaveRequestsTable();
    }

    function openRejectLeaveModal(leaveId) {
        const modal = document.getElementById('scheduleModal'); // re-use a generic modal
        modal.innerHTML = `
            <div class="modal-content modal-sm">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Reason for Rejection</div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejectionReason">Please provide a reason for rejecting this leave request:</label>
                        <textarea id="rejectionReason" rows="4" style="width: 100%;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary">Submit Rejection</button>
                </div>
            </div>`;
        openModal(modal);

        modal.querySelector('.modal-close').onclick = () => closeModal(modal);
        modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
        modal.querySelector('.btn-primary').onclick = () => {
            const reason = document.getElementById('rejectionReason').value.trim();
            if (!reason) {
                showNotification("A reason is required to reject a leave request.", "error");
                return;
            }
            const leave = appData.trainerLeaves.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'Rejected';
                leave.rejectionReason = reason;
                saveData(`Leave for ${leave.trainerName} has been rejected.`);
                closeModal(modal);
                renderLeaveManagementPage(); // Re-render the whole page to update the table
            }
        };
    }


    // --- RATE CARD NEW WORKFLOW ---
    function renderRateCardStartPage() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <style>
                .rc-options { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 40px; }
                .rc-option-card {
                    padding: 30px 40px;
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    cursor: pointer;
                    text-align: center;
                    transition: all 0.2s ease;
                    background-color: #fff;
                    box-shadow: 0 1px 3px var(--shadow-color);
                    width: 220px;
                }
                .rc-option-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 4px 10px var(--shadow-color);
                    border-color: var(--primary-color);
                }
                .rc-option-card i { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-color); }
                .rc-option-card h3 { margin: 0; font-size: 1.1rem; }
            </style>
            <div class="page-header">
                 <div id="breadcrumb-container"></div>
            </div>
            <div id="rate-card-content">
                <div class="rc-options">
                    <div class="rc-option-card" data-option="baseline">
                        <i class="fas fa-tasks"></i>
                        <h3>Baseline RC</h3>
                    </div>
                    <div class="rc-option-card" data-option="by_client">
                        <i class="fas fa-user-tag"></i>
                        <h3>By Client</h3>
                    </div>
                    <div class="rc-option-card" data-option="client_group">
                        <i class="fas fa-users"></i>
                        <h3>Client Group</h3>
                    </div>
                </div>
            </div>
        `;
        renderBreadcrumbs([{label: 'Rate Card'}]);
        mainContent.querySelector('.rc-options').addEventListener('click', (e) => {
            const card = e.target.closest('.rc-option-card');
            if (!card) return;

            const option = card.dataset.option;
            if (option === 'baseline') {
                renderBaselineRCPage();
            } else if (option === 'by_client') {
                renderClientListForRC();
            } else if (option === 'client_group') {
                document.getElementById('rate-card-content').innerHTML = `<p>Client Group Rate Card Coming Soon</p>`;
                renderBreadcrumbs([
                    {label: 'Rate Card', onClick: renderRateCardStartPage},
                    {label: 'Client Group Rate Card'}
                ]);
            }
        });
    }
    
    function renderBaselineRCPage() {
        const container = document.getElementById('rate-card-content');
        let courses = [...appData.courses].sort((a,b) => a.name.localeCompare(b.name));
        
        if (appState.searchFilter) {
            courses = applyGlobalSearch(courses, appState.searchFilter);
        }
        
        let tableRows = courses.map((course, index) => `
            <tr data-course-name="${course.name}">
                <td>${index + 1}</td>
                <td>${course.name}</td>
                <td><input type="number" class="form-control" value="${course.cost.toFixed(2)}" step="0.01" min="0" style="padding: 5px; width: 100px;"></td>
                <td class="text-center">
                    <i class="fas fa-trash-alt action-icon" data-action="delete" title="Delete Course" style="color: var(--danger-color);"></i>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <div class="page-header" style="justify-content: flex-end;">
                <div class="header-actions">
                    <button id="saveBaselineRCBtn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
            <div id="baselineRCData">
                <table class="data-table">
                    <thead><tr><th>#</th><th>Course Name</th><th>Cost</th><th class="text-center">Action</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        `;
         renderBreadcrumbs([
            {label: 'Rate Card', onClick: renderRateCardStartPage},
            {label: 'Baseline Rate Card'}
        ]);
        
        document.getElementById('saveBaselineRCBtn').addEventListener('click', () => {
            let changesMade = false;
            container.querySelectorAll('#baselineRCData tbody tr').forEach(row => {
                const courseName = row.dataset.courseName;
                const newCost = parseFloat(row.querySelector('input').value);
                const course = appData.courses.find(c => c.name === courseName);
                if(course && course.cost !== newCost) {
                    course.cost = newCost;
                    changesMade = true;
                }
            });
            if (changesMade) {
                saveData("Baseline rate card updated successfully.");
            } else {
                showNotification("No changes to save.", "info");
            }
        });

        container.querySelector('#baselineRCData tbody').addEventListener('click', e => {
            const deleteIcon = e.target.closest('[data-action="delete"]');
            if (deleteIcon) {
                const row = deleteIcon.closest('tr');
                const courseName = row.dataset.courseName;
                
                const isCourseInUse = appData.enquiries.some(enq => enq.course === courseName);
                if (isCourseInUse) {
                    showNotification(`Cannot delete "${courseName}". It is used in existing enquiries.`, "error");
                    return;
                }

                showConfirmation(`Are you sure you want to permanently delete the course "${courseName}"? This cannot be undone.`, () => {
                    appData.courses = appData.courses.filter(c => c.name !== courseName);
                    Object.keys(appData.rateCards.byClient).forEach(clientName => {
                        if (appData.rateCards.byClient[clientName][courseName]) {
                            delete appData.rateCards.byClient[clientName][courseName];
                        }
                    });
                    Object.keys(appData.historicalPrices).forEach(clientName => {
                         if (appData.historicalPrices[clientName][courseName]) {
                            delete appData.historicalPrices[clientName][courseName];
                        }
                    });
                    saveData(`Course "${courseName}" has been deleted.`);
                    renderBaselineRCPage();
                });
            }
        });
    }

    let currentClientForRC = null;

    function renderClientListForRC() {
        const container = document.getElementById('rate-card-content');
        let clients = appData.clients.filter(c => c.type === 'company' || c.type === 'individual').sort((a,b) => a.name.localeCompare(b.name));

        if (appState.searchFilter) {
            clients = applyGlobalSearch(clients, appState.searchFilter);
        }

        container.innerHTML = `
            <style>
                .client-list-container { max-width: 800px; margin: 20px auto; }
                .client-list { list-style: none; padding: 0; margin: 0; max-height: 70vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 5px; }
                .client-list li { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: #fff; }
                .client-list li:last-child { border-bottom: none; }
                .client-list li:hover { background-color: var(--secondary-color); }
            </style>
            <div class="client-list-container">
                <p>${clients.length} client(s) found. Please use the global search bar above to filter.</p>
                <ul class="client-list">
                    ${clients.map(c => `<li data-client-name="${c.name}">${c.name}</li>`).join('')}
                </ul>
            </div>
        `;
        renderBreadcrumbs([
            {label: 'Rate Card', onClick: renderRateCardStartPage},
            {label: 'By Client'}
        ]);
        
        container.querySelector('.client-list').addEventListener('click', e => {
            if (e.target.tagName === 'LI') {
                currentClientForRC = e.target.dataset.clientName;
                renderRateCardForClient();
            }
        });
    }

    function renderRateCardForClient() {
        const clientName = currentClientForRC;
        if (!clientName) return;

        const container = document.getElementById('rate-card-content');
        const courses = [...appData.courses].sort((a,b) => a.name.localeCompare(b.name));
        
        const tableRows = courses.map(course => {
            const clientRates = appData.rateCards.byClient[clientName] || {};
            const courseRate = clientRates[course.name] || { discount: 0 };
            const finalCost = course.cost * (1 - (courseRate.discount / 100));

            return `
                <tr data-course-name="${course.name}" data-baseline-cost="${course.cost}">
                    <td>${course.name}</td>
                    <td class="text-center">${course.cost.toFixed(2)}</td>
                    <td class="text-center"><input type="number" class="rc-discount" value="${courseRate.discount}" min="0" max="100" style="width: 80px; text-align: center; padding: 5px;"></td>
                    <td class="text-center rc-final-cost">${finalCost.toFixed(2)}</td>
                    <td class="text-center">
                        <i class="fas fa-trash-alt action-icon" data-action="reset-discount" title="Reset Discount to 0%" style="color: var(--danger-color);"></i>
                    </td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <div style="margin-bottom: 20px; display: flex; justify-content: flex-end; align-items: center;">
                <button id="saveClientRCBtn" class="btn btn-primary">Save Changes</button>
            </div>
             <table class="data-table">
                <thead><tr><th>Course</th><th class="text-center">Original Cost</th><th class="text-center">Discount (%)</th><th class="text-center">Final Cost</th><th class="text-center">Action</th></tr></thead>
                <tbody>${tableRows}</tbody>
             </table>
        `;

        renderBreadcrumbs([
            {label: 'Rate Card', onClick: renderRateCardStartPage},
            {label: 'By Client', onClick: renderClientListForRC},
            {label: clientName}
        ]);

        const tbody = container.querySelector('tbody');

        tbody.addEventListener('input', e => {
            if(e.target.classList.contains('rc-discount')) {
                const row = e.target.closest('tr');
                const baselineCost = parseFloat(row.dataset.baselineCost);
                const discount = parseFloat(e.target.value) || 0;
                const finalCost = baselineCost * (1 - (discount/100));
                row.querySelector('.rc-final-cost').textContent = finalCost.toFixed(2);
            }
        });

        tbody.addEventListener('click', e => {
            const resetIcon = e.target.closest('[data-action="reset-discount"]');
            if (resetIcon) {
                const row = resetIcon.closest('tr');
                const discountInput = row.querySelector('.rc-discount');
                if (discountInput.value !== '0') {
                    discountInput.value = 0;
                    discountInput.dispatchEvent(new Event('input'));
                    showNotification("Discount reset. Click 'Save Changes' to apply.", "info");
                }
            }
        });

        container.querySelector('#saveClientRCBtn').addEventListener('click', () => {
            if (!appData.rateCards.byClient[clientName]) {
                appData.rateCards.byClient[clientName] = {};
            }
            container.querySelectorAll('tbody tr').forEach(row => {
                const courseName = row.dataset.courseName;
                const discount = parseFloat(row.querySelector('.rc-discount').value) || 0;
                if(discount > 0) {
                    if(!appData.rateCards.byClient[clientName][courseName]) {
                        appData.rateCards.byClient[clientName][courseName] = {};
                    }
                    appData.rateCards.byClient[clientName][courseName].discount = discount;
                } else {
                    delete appData.rateCards.byClient[clientName][courseName];
                }
            });
            saveData(`Rate card for ${clientName} updated.`);
        });
    }
    
    // --- TABLE SORTING & SEARCH UTILITIES ---
    function applyGlobalSearch(data, searchTerm) {
        if (!searchTerm) return data;
        const lowerCaseSearchTerm = searchTerm.toLowerCase();

        return data.filter(item => {
            return Object.values(item).some(value => {
                if (value === null || typeof value === 'undefined') {
                    return false;
                }
                return String(value).toLowerCase().includes(lowerCaseSearchTerm);
            });
        });
    }

    function handleTableSort(th) {
        const table = th.closest('table');
        const viewId = table.dataset.viewId;
        const sortKey = th.dataset.sortKey;
        const sortType = th.dataset.sortType || 'string'; // default to string sort

        if (!viewId || !sortKey) return;

        let currentSort = tableSortState[viewId] || {};
        let newDir = 'asc';

        if (currentSort.key === sortKey) {
            if (currentSort.dir === 'asc') newDir = 'desc';
            else if (currentSort.dir === 'desc') {
                // Reset sort on third click
                delete tableSortState[viewId];
                // Re-render the page to go back to default sort
                if(appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
                    renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
                }
                if(appState.currentPage === 'pending_nominations') loadClassSchedulerView();
                if(appState.currentPage === 'roster') loadClassRosterView();
                if(appState.currentPage === 'trainer') renderExistingTrainersList();
                if (appState.currentPage === 'nomination_start') loadNominationListView();
                if (appState.currentPage === 'results') loadResultsView();
                if (appState.currentPage === 'invoices') renderInvoicesPage();
                return;
            }
        }
        
        tableSortState[viewId] = { key: sortKey, dir: newDir, type: sortType };
        
        // Re-render the current view to apply the sort
        if(appState.currentPage === 'all_records' || appState.currentPage === 'pending_enquiries') {
            renderEnquiriesListView(appState.currentPage === 'all_records' ? 'all' : 'pending');
        }
        if(appState.currentPage === 'pending_nominations') loadClassSchedulerView();
        if(appState.currentPage === 'roster') loadClassRosterView();
        if(appState.currentPage === 'trainer') renderExistingTrainersList();
        if(appState.currentPage === 'nomination_start') loadNominationListView();
        if (appState.currentPage === 'results') loadResultsView();
        if (appState.currentPage === 'invoices') renderInvoicesPage();
    }

    function applyTableSorting(data, key, dir, type) {
        return [...data].sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (key === 'status') {
                valA = getDisplayStatus(a);
                valB = getDisplayStatus(b);
            }

            if (type === 'number') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            } else if (type === 'date') {
                valA = new Date(valA).getTime() || 0;
                valB = new Date(valB).getTime() || 0;
            } else { // string (case-insensitive)
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }

            if (valA < valB) return dir === 'asc' ? -1 : 1;
            if (valA > valB) return dir === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    // --- NEW/UPDATED: REPORTS & CERTIFICATES ---
    function renderReportsPage() {
        const mainContent = document.getElementById('mainContent');
        const completedEnquiries = appData.enquiries.filter(e => e.status === 'Completed' && e.nominees && e.nominees.length > 0);
        
        const resultsByCourse = completedEnquiries.reduce((acc, enq) => {
            if (!acc[enq.course]) {
                acc[enq.course] = { pass: 0, fail: 0, total: 0 };
            }
            enq.nominees.forEach(nom => {
                if (nom.result === 'Pass') acc[enq.course].pass++;
                if (nom.result === 'Fail') acc[enq.course].fail++;
                if (nom.result) acc[enq.course].total++;
            });
            return acc;
        }, {});

        let chartsHTML = '';
        for (const course in resultsByCourse) {
            if (resultsByCourse[course].total > 0) {
                const data = resultsByCourse[course];
                chartsHTML += `
                    <div class="report-chart-container" style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow-color);">
                        <h4 style="margin-top: 0; text-align: center;">${course} - Result Analysis</h4>
                        <p style="text-align: center; margin: -10px 0 10px 0; font-size: 13px;">
                            <span style="color: #2ecc71; font-weight: bold;">Pass: ${data.pass}</span> | 
                            <span style="color: #e74c3c; font-weight: bold;">Fail: ${data.fail}</span>
                        </p>
                        <div style="position: relative; height:250px; width:250px; margin: 0 auto;">
                            <canvas id="chart-${course.replace(/\s+/g, '-')}"></canvas>
                        </div>
                    </div>
                `;
            }
        }

        mainContent.innerHTML = `
            <div class="page-header"><div id="breadcrumb-container"></div></div>
            <div id="reports-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${chartsHTML || '<p style="grid-column: 1 / -1; text-align: center; background: #fff; padding: 30px; border-radius: 8px;">No completed classes with results found to generate reports.</p>'}
            </div>
        `;
        renderBreadcrumbs([{ label: 'Reports' }]);

        // Render charts
        setTimeout(() => {
            for (const course in resultsByCourse) {
                if (resultsByCourse[course].total > 0) {
                    const ctx = document.getElementById(`chart-${course.replace(/\s+/g, '-')}`);
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Pass', 'Fail'],
                                datasets: [{
                                    label: 'Student Results',
                                    data: [resultsByCourse[course].pass, resultsByCourse[course].fail],
                                    backgroundColor: [ '#2ecc71', '#e74c3c' ],
                                    borderColor: ['#27ae60', '#c0392b'],
                                    hoverOffset: 4
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                }
            }
        }, 0);
    }
    
    function renderCertificatesPage() {
        const mainContent = document.getElementById('mainContent');
        
        const completedBatches = appData.enquiries
            .filter(e => e.status === 'Completed' && e.batchNumber)
            .reduce((acc, enq) => {
                if (!acc[enq.batchNumber]) {
                    acc[enq.batchNumber] = {
                        batchNumber: enq.batchNumber,
                        courseName: enq.course,
                        date: enq.startDate,
                        certificateIssued: enq.certificateIssued || false
                    };
                } else if (enq.certificateIssued) {
                    acc[enq.batchNumber].certificateIssued = true;
                }
                return acc;
            }, {});

        const sortedBatches = Object.values(completedBatches).sort((a,b) => new Date(b.date) - new Date(a.date));

        let tableRows = `<tr><td colspan="5" class="text-center" style="padding: 20px;">No completed classes with batch numbers found.</td></tr>`;
        if (sortedBatches.length > 0) {
            tableRows = sortedBatches.map(batch => `
                <tr data-batch-id="${batch.batchNumber}">
                    <td>${batch.batchNumber}</td>
                    <td>${batch.courseName}</td>
                    <td class="text-center">${new Date(batch.date).toLocaleDateString('en-GB')}</td>
                    <td class="text-center">${batch.certificateIssued ? getStatusBadgeHTML('Certificate Issued') : getStatusBadgeHTML('Certificate Pending')}</td>
                    <td class="text-center"><button class="btn btn-sm btn-primary" onclick="openBatchCertificateModal('${batch.batchNumber}')">View</button></td>
                </tr>
            `).join('');
        }

        mainContent.innerHTML = `
            <div class="page-header"><div id="breadcrumb-container"></div></div>
            <table class="data-table">
                <thead><tr><th>Batch Number</th><th>Course Name</th><th class="text-center">Date</th><th class="text-center">Status</th><th class="text-center">Action</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        `;
        renderBreadcrumbs([{ label: 'Certificates' }]);
    }

    function openBatchCertificateModal(batchNumber) {
        const batchEnquiries = appData.enquiries.filter(e => e.batchNumber === batchNumber);
        if (batchEnquiries.length === 0) return;

        const modal = document.getElementById('certificateModal');
        
        const allStudents = batchEnquiries.flatMap(enq => 
            enq.nominees.map(nom => ({ ...nom, clientName: enq.client, classDate: enq.startDate }))
        );
        
        const allLogs = batchEnquiries.flatMap(enq => appData.activityLog[enq.id] || []).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const logHTML = allLogs.length > 0 ? `<ul>${allLogs.map(log => `<li><strong>${log.activity}</strong> (${new Date(log.timestamp).toLocaleString('en-GB')})<small>${log.details ? log.details.replace(/\n/g, '<br>') : 'No details'}</small></li>`).join('')}</ul>` : '<p>No activity recorded for this batch.</p>';

        let studentListHTML = allStudents.map(student => `
            <tr>
                <td>${student.clientName}</td>
                <td>${student.civilId || 'N/A'}</td>
                <td>${student.name}</td>
                <td>${student.phone || 'N/A'}</td>
                <td>${student.email || 'N/A'}</td>
                <td class="text-center">${new Date(student.classDate).toLocaleDateString('en-GB')}</td>
                <td class="text-center">${student.result || 'N/A'}</td>
                <td><!-- Feedback placeholder --></td>
            </tr>
        `).join('');

        modal.innerHTML = `
            <div class="modal-content modal-xl">
                <span class="modal-close">&times;</span>
                <div class="modal-title">Batch Details: ${batchNumber}</div>

                <button class="accordion-button">View Full Details <i class="fas fa-chevron-down"></i></button>
                <div class="accordion-content">
                    ${logHTML}
                </div>

                <div class="modal-body" id="certificate-modal-body" style="padding-top:0;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Student Contact Number</th>
                                <th>Student Mail ID</th>
                                <th class="text-center">Class Date</th>
                                <th class="text-center">Pass/Fail Status</th>
                                <th>Feedback</th>
                            </tr>
                        </thead>
                        <tbody>${studentListHTML}</tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary">Close</button>
                    <button id="issueCertificatesBtn" class="btn btn-primary">Issue Certificate</button>
                </div>
            </div>
        `;

        openModal(modal);
        
        const accordionBtn = modal.querySelector('.accordion-button');
        accordionBtn.addEventListener('click', function() {
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });

        modal.querySelector('.modal-close').onclick = () => closeModal(modal);
        modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
        modal.querySelector('#issueCertificatesBtn').onclick = () => {
            showAllCertificatesForBatch(batchNumber);
        };
    }

    function showAllCertificatesForBatch(batchNumber) {
        const batchEnquiries = appData.enquiries.filter(e => e.batchNumber === batchNumber);
        if (!batchEnquiries.length) return;

        const modalBody = document.getElementById('certificate-modal-body');
        const modalFooter = document.getElementById('certificateModal').querySelector('.modal-footer');
        const accordion = document.getElementById('certificateModal').querySelector('.accordion-button');
        const accordionContent = document.getElementById('certificateModal').querySelector('.accordion-content');
        if(modalFooter) modalFooter.style.display = 'none';
        if(accordion) accordion.style.display = 'none';
        if(accordionContent) accordionContent.style.display = 'none';

        let certificatesHTML = '';
        let certificatesIssued = false;

        batchEnquiries.forEach(enq => {
            enq.nominees.forEach(student => {
                if (student.result === 'Pass') {
                    certificatesHTML += getSingleCertificateHTML(student, enq);
                }
            });
            if (!enq.certificateIssued) {
                enq.certificateIssued = true;
                logActivity(enq.id, "Certificates Marked as Issued", `Batch: ${batchNumber}`);
                certificatesIssued = true;
            }
        });

        if (certificatesIssued) {
            saveData(`Certificates for batch ${batchNumber} marked as issued.`);
            renderCertificatesPage(); // Refresh the main page to update status
        }

        modalBody.innerHTML = `
            <style>
                .certificate-container { border: 10px solid #c0c0c0; padding: 25px; width: 800px; height: 565px; position: relative; background-color: #f7f6f1; font-family: 'Times New Roman', serif; color: #333; margin: 20px auto; page-break-after: always; } .certificate-border { border: 2px solid #a0a0a0; width: 100%; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; } .certificate-header { margin-bottom: 20px; } .certificate-title { font-size: 38px; font-weight: bold; color: #2a3a5e; margin: 0; } .certificate-subtitle { font-size: 18px; margin-top: 5px; color: #555; } .certificate-body { margin: 20px 0; } .cert-text { font-size: 16px; margin: 5px 0; } .student-name { font-size: 32px; font-weight: bold; color: var(--logo-color); margin: 15px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; } .course-name { font-size: 20px; font-weight: bold; margin: 10px 0; } .certificate-footer { display: flex; justify-content: space-between; width: 80%; margin-top: 40px; } .signature-line { border-top: 1px solid #333; width: 200px; padding-top: 5px; font-size: 14px; }
                @media print { body * { visibility: hidden; } #certificate-modal-body, #certificate-modal-body * { visibility: visible; } #invoiceModal, #certificateModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; margin: 0; } .certificate-container, .invoice-box { margin: 0 auto; box-shadow: none; border: 10px solid #c0c0c0; } .print-controls { display: none; } }
            </style>
            <div class="print-controls" style="text-align: right; padding: 0 20px 10px 0;"><button class="btn btn-primary" onclick="window.print()">Print All</button></div>
            ${certificatesHTML || '<p class="text-center">No students passed in this batch to issue certificates.</p>'}
        `;
    }

function getSingleCertificateHTML(student, enq) {
     return `
        <div class="certificate-container">
            <div class="certificate-border">
                <div class="certificate-header">
                    <h1 class="certificate-title">Certificate of Completion</h1>
                    <p class="certificate-subtitle">This certificate is proudly presented to</p>
                </div>
                <div class="certificate-body">
                    <h2 class="student-name">${student.name}</h2>
                    <p class="cert-text">for successfully completing the training course</p>
                    <h3 class="course-name">${enq.course}</h3>
                    <p class="cert-text">on ${new Date(enq.startDate).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="certificate-footer">
                    <div class="signature-line">
                        <strong>Authorized Signature</strong><br>
                        Sun Training Institute
                    </div>
                    <div class="signature-line">
                        <strong>Date Issued</strong><br>
                        ${new Date().toLocaleDateString('en-GB')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// --- NEW: INVOICING FUNCTIONS ---
function generateInvoiceForClient(clientName) {
    const completedEnquiriesToInvoice = appData.enquiries.filter(e =>
        e.client === clientName && e.status === 'Completed' && !e.invoiceId
    );

    if (completedEnquiriesToInvoice.length === 0) {
        showNotification(`No new completed classes found for ${clientName} to invoice.`, 'warning');
        renderPage('invoices');
        return;
    }

    invoiceCounter++;
    const newInvoiceId = `INV-${new Date().getFullYear()}-${String(invoiceCounter).padStart(4, '0')}`;

    const items = completedEnquiriesToInvoice.map(enq => ({
        enquiryId: enq.id,
        course: enq.course,
        quantity: enq.nominated,
        unitPrice: enq.cost,
        total: enq.nominated * enq.cost
    }));

    const totalAmount = items.reduce((sum, item) => sum + item.total, 0);

    const newInvoice = {
        id: newInvoiceId,
        client: clientName,
        date: toYYYYMMDD(new Date()),
        items: items,
        totalAmount: totalAmount,
        status: 'Draft' // Initial status
    };

    appData.invoices.push(newInvoice);
    
    // Mark enquiries as invoiced
    completedEnquiriesToInvoice.forEach(enq => {
        enq.invoiceId = newInvoiceId;
    });

    saveData(`Invoice ${newInvoiceId} created for ${clientName}.`);
    renderPage('invoices');
}

function renderInvoicesPage() {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
        <div class="page-header">
             <div id="breadcrumb-container"></div>
        </div>
        <div id="invoicesData"></div>
    `;
    renderBreadcrumbs([{label: 'Invoices'}]);
    loadInvoicesView();
}

function loadInvoicesView() {
    const container = document.getElementById('invoicesData');
    const viewId = 'invoices_view';
    let invoices = [...appData.invoices];

    if (appState.searchFilter) {
        invoices = applyGlobalSearch(invoices, appState.searchFilter);
    }

    const sortState = tableSortState[viewId];
    if(sortState) {
        invoices = applyTableSorting(invoices, sortState.key, sortState.dir, sortState.type);
    } else {
         invoices.sort((a,b) => new Date(b.date) - new Date(a.date));
    }

    let tableRows = `<tr><td colspan="6" class="text-center" style="padding: 20px;">No invoices found.</td></tr>`;

    if (invoices.length > 0) {
        tableRows = invoices.map(inv => {
            let actionsHTML = `<button class="btn btn-secondary btn-sm" data-action="view-invoice">View</button>`;
            if(inv.status === 'Draft') {
                actionsHTML += `<button class="btn btn-primary btn-sm" data-action="send-invoice" style="margin-left: 5px;">Send Invoice &rarr;</button>`;
            } else if (inv.status === 'Sent') {
                 actionsHTML += `<button class="btn btn-primary btn-sm" data-action="mark-paid" style="margin-left: 5px;">Amount Received?</button>`;
            }
            return `
            <tr data-id="${inv.id}">
                <td>${inv.id}</td>
                <td>${inv.client}</td>
                <td class="text-center">${new Date(inv.date).toLocaleDateString('en-GB')}</td>
                <td class="text-center">${inv.totalAmount.toFixed(2)}</td>
                <td class="text-center">${getStatusBadgeHTML(inv.status)}</td>
                <td class="text-center">${actionsHTML}</td>
            </tr>
        `}).join('');
    }
    
    container.innerHTML = `
        <table class="data-table" data-view-id="${viewId}">
            <thead>
                <tr>
                    <th class="sortable" data-sort-key="id">Invoice #</th>
                    <th class="sortable" data-sort-key="client">Client</th>
                    <th class="sortable text-center" data-sort-key="date" data-sort-type="date">Date</th>
                    <th class="sortable text-center" data-sort-key="totalAmount" data-sort-type="number">Amount</th>
                    <th class="sortable text-center" data-sort-key="status">Status</th>
                    <th class="text-center" style="min-width: 200px;">Action</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>
    `;

    if (sortState) {
        const th = container.querySelector(`th[data-sort-key="${sortState.key}"]`);
        if (th) th.classList.add(sortState.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
    }
}

function openInvoiceModal(invoiceId) {
    const invoice = appData.invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return showNotification("Invoice not found", "error");

    const modal = document.getElementById('invoiceModal');
    modal.innerHTML = `
        <style>
            .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 24px; font-family: 'Helvetica Neue', 'Helvetica', Helvetica, Arial, sans-serif; color: #555; background: #fff; }
            .invoice-box table { width: 100%; line-height: inherit; text-align: left; border-collapse: collapse; }
            .invoice-box table td { padding: 5px; vertical-align: top; }
            .invoice-box table tr.top table td { padding-bottom: 20px; }
            .invoice-box table tr.top table td.title { font-size: 45px; line-height: 45px; color: #333; }
            .invoice-box table tr.information table td { padding-bottom: 40px; }
            .invoice-box table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
            .invoice-box table tr.details td { padding-bottom: 20px; }
            .invoice-box table tr.item td { border-bottom: 1px solid #eee; }
            .invoice-box table tr.item.last td { border-bottom: none; }
            .invoice-box table tr.total td:nth-child(2) { border-top: 2px solid #eee; font-weight: bold; text-align: right; }
            .invoice-box .text-right { text-align: right; }
        </style>
        <div class="modal-content modal-lg">
            <span class="modal-close">&times;</span>
            <div class="modal-body" id="invoice-modal-body">
                <div class="invoice-box">
                    <table>
                        <tr class="top">
                            <td colspan="4">
                                <table>
                                    <tr>
                                        <td class="title">
                                            <div class="logo" style="font-size: 1.5rem;"><span>Sun</span> Training</div>
                                        </td>
                                        <td class="text-right">
                                            Invoice #: ${invoice.id}<br>
                                            Created: ${new Date(invoice.date).toLocaleDateString('en-GB')}<br>
                                            Due: ${new Date(new Date(invoice.date).setDate(new Date(invoice.date).getDate() + 30)).toLocaleDateString('en-GB')}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr class="information">
                            <td colspan="4">
                                <table>
                                    <tr>
                                        <td>
                                            Sun Training Institute<br>
                                            123 Training Lane<br>
                                            City, Country 12345
                                        </td>
                                        <td class="text-right">
                                            <strong>Bill To:</strong><br>
                                            ${invoice.client}<br>
                                            <!-- Add more client details if available -->
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr class="heading">
                            <td>Description</td>
                            <td class="text-right">Quantity</td>
                            <td class="text-right">Unit Price</td>
                            <td class="text-right">Total</td>
                        </tr>
                        ${invoice.items.map(item => `
                            <tr class="item">
                                <td>${item.course} (Ref: ${item.enquiryId})</td>
                                <td class="text-right">${item.quantity}</td>
                                <td class="text-right">${item.unitPrice.toFixed(2)}</td>
                                <td class="text-right">${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                        <tr class="total">
                            <td colspan="3"></td>
<td class="text-right"><strong>Total: ${invoice.totalAmount.toFixed(2)}</strong></td>
</tr>
</table>
</div>
</div>
<div class="modal-footer print-controls">
<button class="btn btn-secondary">Close</button>
<button class="btn btn-primary" onclick="window.print()">Print Invoice</button>
</div>
</div>
`;
openModal(modal);
modal.querySelector('.modal-close').onclick = () => closeModal(modal);
modal.querySelector('.btn-secondary').onclick = () => closeModal(modal);
}

function sendInvoiceByMail(invoiceId) {
    const invoice = appData.invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;
    
    const firstEnquiryId = invoice.items[0]?.enquiryId;
    const enquiry = appData.enquiries.find(e => e.id === firstEnquiryId);
    const contactEmail = enquiry ? enquiry.contactEmail : '';
    const contactName = enquiry ? enquiry.contactName : invoice.client;

    if (!contactEmail) {
        showNotification(`No contact email found for client ${invoice.client}. Cannot send invoice.`, "error");
        return;
    }

    const subject = `Invoice ${invoice.id} from Sun Training Institute`;
    const body = `Dear ${contactName},\n\nPlease find your invoice attached for the recent training services.\n\nInvoice Number: ${invoice.id}\nTotal Amount: ${invoice.totalAmount.toFixed(2)}\n\nThank you for your business.\n\nBest regards,\nSun Training Institute`;
    const mailtoLink = `mailto:${contactEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    showConfirmation(`This will open your default email client to send Invoice ${invoiceId} to ${contactEmail}. Do you want to continue?`, () => {
        invoice.status = 'Sent';
        saveData(`Invoice ${invoice.id} has been sent.`);
        window.location.href = mailtoLink;
        loadInvoicesView();
    });
}

function renderRevenuePage() {
    const mainContent = document.getElementById('mainContent');
    let paidInvoices = appData.invoices.filter(inv => inv.status === 'Paid');
    let pendingInvoices = appData.invoices.filter(inv => ['Draft', 'Sent'].includes(inv.status));

    if (appState.searchFilter) {
        paidInvoices = applyGlobalSearch(paidInvoices, appState.searchFilter);
        pendingInvoices = applyGlobalSearch(pendingInvoices, appState.searchFilter);
    }

    const totalRevenue = paidInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);
    const pendingAmount = pendingInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);

    let tableRows = `<tr><td colspan="5" class="text-center" style="padding: 20px;">No paid invoices found.</td></tr>`;
    if (paidInvoices.length > 0) {
        tableRows = paidInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).map(inv => `
            <tr data-id="${inv.id}">
                <td>${inv.id}</td>
                <td>${inv.client}</td>
                <td class="text-center">${new Date(inv.date).toLocaleDateString('en-GB')}</td>
                <td class="text-center">${inv.totalAmount.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-secondary btn-sm" data-action="view-invoice">View</button>
                </td>
            </tr>
        `).join('');
    }
    
    mainContent.innerHTML = `
        <div class="page-header"><div id="breadcrumb-container"></div></div>
        <div class="dashboard-grid" style="margin-bottom: 20px;">
             <div class="stat-card">
                <div class="icon" style="background-color: var(--success-color);"><i class="fas fa-chart-line"></i></div>
                <div class="info">
                    <div class="number">${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                    <div class="label">Total Revenue (Paid)</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background-color: var(--warning-color);"><i class="fas fa-hourglass-half"></i></div>
                <div class="info">
                    <div class="number">${pendingAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                    <div class="label">Total Pending Amount</div>
                </div>
            </div>
        </div>
        <h4 style="margin-top: 30px;">Paid Invoices</h4>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Client</th>
                    <th class="text-center">Date</th>
                    <th class="text-center">Amount</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>
    `;
    renderBreadcrumbs([{label: 'Revenue'}]);
}


document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setupEventListeners();
        
        const getNavigablePages = (menu) => {
            let pages = [];
            menu.forEach(item => {
                if(item.submenu) {
                    pages = pages.concat(getNavigablePages(item.submenu));
                } else {
                    pages.push(item);
                }
            });
            return pages;
        };
        const allNavigablePages = getNavigablePages(menuConfig);
        const accessiblePages = allNavigablePages.filter(item => (item.roles || []).includes(appState.role));

        const isCurrentPageAccessible = accessiblePages.some(p => p.id === appState.currentPage);
        if (!isCurrentPageAccessible && accessiblePages.length > 0) {
            appState.currentPage = accessiblePages[0].id;
        } else if (accessiblePages.length === 0) {
            appState.currentPage = null;
        }

        renderMenu();
        renderPage(appState.currentPage);
        updateAllReminders();
    });
</script>
</body>
</html>